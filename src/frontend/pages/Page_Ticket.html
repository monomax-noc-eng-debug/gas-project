<div id="page-ticket" class="page-section hidden w-full h-full bg-base-200/50 flex flex-col p-4 md:p-6 gap-6 overflow-hidden">

    <div class="flex justify-between items-center bg-white px-5 py-3 rounded-2xl shadow-sm border border-base-300 shrink-0">
        <div class="flex items-center gap-3">
            <div class="bg-primary/10 p-2 rounded-xl text-primary">
                <i class="fas fa-ticket-alt text-xl"></i>
            </div>
            <div>
                <h2 class="text-base font-bold text-gray-800">ทิคเก็ต (Ticket)</h2>
                <p class="text-[10px] text-gray-400">รายการแจ้งปัญหาและงานทั้งหมด</p>
            </div>
        </div>
        
        <div class="flex items-center gap-2">
            <button onclick="TicketManager.loadTickets(true)"
                class="btn btn-sm btn-ghost btn-circle text-base-content/60 hover:text-primary tooltip tooltip-bottom"
                data-tip="รีเฟรช">
                <i class="fas fa-sync-alt"></i>
            </button>
            <button onclick="TicketManager.openModal('CREATE')"
                class="btn btn-sm btn-primary text-white shadow-sm gap-2 font-medium px-4">
                <i class="fas fa-plus text-xs"></i> <span class="hidden sm:inline">สร้าง Ticket</span>
            </button>
        </div>
    </div>

    <div class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-7 gap-3 shrink-0">
        <div class="stat bg-white shadow-sm border border-base-200 rounded-xl p-3">
            <div class="stat-figure text-primary/20"><i class="fas fa-layer-group text-xl"></i></div>
            <div class="stat-title text-[10px] uppercase font-bold text-gray-400">Total</div>
            <div class="stat-value text-2xl text-primary" id="stat-total">0</div>
        </div>
        <div class="stat bg-white shadow-sm border border-base-200 rounded-xl p-3">
            <div class="stat-title text-[10px] uppercase font-bold text-red-400">Open</div>
            <div class="stat-value text-2xl text-red-500" id="stat-open">0</div>
        </div>
        <div class="stat bg-white shadow-sm border border-base-200 rounded-xl p-3">
            <div class="stat-title text-[10px] uppercase font-bold text-amber-400">Pending</div>
            <div class="stat-value text-2xl text-amber-500" id="stat-pending">0</div>
        </div>
        <div class="stat bg-white shadow-sm border border-base-200 rounded-xl p-3">
            <div class="stat-title text-[10px] uppercase font-bold text-green-400">Resolved</div>
            <div class="stat-value text-2xl text-green-500" id="stat-resolved">0</div>
        </div>
        <div class="stat bg-white shadow-sm border border-base-200 rounded-xl p-3">
            <div class="stat-title text-[10px] uppercase font-bold text-gray-400">Closed</div>
            <div class="stat-value text-2xl text-gray-500" id="stat-closed">0</div>
        </div>
        <div class="stat bg-white shadow-sm border border-base-200 rounded-xl p-3">
            <div class="stat-title text-[10px] uppercase font-bold text-blue-400">Request</div>
            <div class="stat-value text-xl text-blue-500" id="stat-request">0</div>
        </div>
        <div class="stat bg-white shadow-sm border border-base-200 rounded-xl p-3">
            <div class="stat-title text-[10px] uppercase font-bold text-pink-400">Incident</div>
            <div class="stat-value text-xl text-pink-500" id="stat-incident">0</div>
        </div>
    </div>

    <div class="card bg-white shadow-sm border border-base-200 flex-1 min-h-0 flex flex-col overflow-hidden">
        
        <div class="p-4 border-b border-base-100 flex items-center gap-3 bg-white z-20">
            <div class="relative flex-1 max-w-md">
                <i class="fas fa-search absolute left-3 top-1/2 -translate-y-1/2 text-gray-300 text-xs"></i>
                <input type="text" id="ticket-search" onkeyup="TicketManager.filterData()" 
                    placeholder="ค้นหา ID, หัวข้อ, สถานะ..." 
                    class="input input-sm input-bordered w-full pl-9 focus:input-primary rounded-lg text-xs">
            </div>
        </div>

        <div class="flex-1 overflow-x-auto overflow-y-auto relative custom-scrollbar bg-white">
            
            <div id="ticket-loader" class="absolute inset-0 bg-white/80 z-30 flex flex-col items-center justify-center hidden backdrop-blur-[1px]">
                <span class="loading loading-dots loading-lg text-primary"></span>
            </div>

            <div id="ticket-empty" class="absolute inset-0 flex flex-col items-center justify-center text-gray-300 hidden z-10 pointer-events-none">
                <i class="fas fa-inbox text-4xl mb-2 opacity-30"></i>
                <p class="text-sm">ไม่พบข้อมูล Ticket</p>
            </div>

            <table class="table table-md w-full text-left">
                <thead class="bg-gray-50 text-gray-600 font-bold text-sm uppercase sticky top-0 z-20 shadow-sm">
                    <tr>
                        <th class="whitespace-nowrap py-4 pl-4 w-16 text-center">No.</th>
                        <th class="whitespace-nowrap py-4 w-32">Ticket ID</th>
                        <th class="whitespace-nowrap py-4 w-32">Date</th>
                        <th class="whitespace-nowrap py-4 min-w-[250px]">Subject</th>
                        <th class="whitespace-nowrap py-4 w-28 text-center">Type</th>
                        <th class="whitespace-nowrap py-4 w-28 text-center">Severity</th>
                        <th class="whitespace-nowrap py-4 w-32 text-center">Status</th>
                        <th class="whitespace-nowrap py-4 w-40">Category</th>
                        <th class="whitespace-nowrap py-4 w-40">Assign To</th>
                        <th class="whitespace-nowrap py-4 pr-4 w-20 text-center">Action</th>
                    </tr>
                </thead>
                <tbody id="ticket-table-body" class="text-sm divide-y divide-gray-100">
                    </tbody>
            </table>
        </div>
    </div>

    <dialog id="modal-ticket-form" class="modal modal-bottom sm:modal-middle">
        <div class="modal-box w-11/12 max-w-3xl p-0 rounded-2xl bg-white shadow-2xl overflow-hidden">
            
            <div class="px-6 py-4 border-b border-base-200 flex justify-between items-center bg-base-50">
                <h3 class="font-bold text-lg text-gray-800 flex items-center gap-2">
                    <span class="w-2 h-6 bg-primary rounded-full"></span>
                    <span id="ticket-modal-title">Ticket Detail</span>
                </h3>
                <form method="dialog">
                    <button class="btn btn-sm btn-circle btn-ghost text-gray-400 hover:text-gray-600">✕</button>
                </form>
            </div>

            <form id="form-ticket" onsubmit="TicketManager.handleSubmit(event)" class="overflow-y-auto max-h-[calc(100vh-12rem)]">
                <input type="hidden" name="id" id="inp-ticket-id">

                <div class="p-6 space-y-6">
                    
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                        <div class="form-control">
                            <span class="label-text text-xs font-bold text-gray-400 mb-1">Date</span>
                            <input type="date" name="date" id="inp-ticket-date" required class="input input-sm input-bordered w-full">
                        </div>
                        <div class="form-control">
                            <span class="label-text text-xs font-bold text-gray-400 mb-1">Time</span>
                            <input type="time" name="time" id="inp-ticket-time" required class="input input-sm input-bordered w-full">
                        </div>
                        <div class="form-control">
                            <span class="label-text text-xs font-bold text-gray-400 mb-1">Type</span>
                            <select name="type" id="sel-ticket-type" class="select select-sm select-bordered w-full"></select>
                        </div>
                        <div class="form-control">
                            <span class="label-text text-xs font-bold text-gray-400 mb-1">Status</span>
                            <select name="status" id="sel-ticket-status" class="select select-sm select-bordered w-full font-bold"></select>
                        </div>
                    </div>

                    <div class="divider my-0"></div>

                    <div class="space-y-4">
                        <div class="form-control">
                            <span class="label-text text-xs font-bold text-gray-400 mb-1">Subject / หัวข้อ</span>
                            <input type="text" name="subject" id="inp-ticket-subject" required class="input input-bordered w-full font-bold text-gray-700 placeholder:font-normal" placeholder="ระบุหัวข้อปัญหา...">
                        </div>

                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                            <div class="form-control">
                                <span class="label-text text-xs font-bold text-gray-400 mb-1">Category</span>
                                <select name="category" id="sel-ticket-category" onchange="TicketManager.updateSubCategories()" class="select select-sm select-bordered w-full"></select>
                            </div>
                            <div class="form-control">
                                <span class="label-text text-xs font-bold text-gray-400 mb-1">Sub Category</span>
                                <select name="subCategory" id="sel-ticket-subcategory" class="select select-sm select-bordered w-full"></select>
                            </div>
                            <div class="form-control">
                                <span class="label-text text-xs font-bold text-gray-400 mb-1">Severity</span>
                                <select name="severity" id="sel-ticket-severity" class="select select-sm select-bordered w-full"></select>
                            </div>
                        </div>

                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div class="form-control">
                                <span class="label-text text-xs font-bold text-gray-400 mb-1">Description</span>
                                <textarea name="detail" id="txt-ticket-detail" class="textarea textarea-bordered h-24 text-xs" placeholder="รายละเอียด..."></textarea>
                            </div>
                            <div class="form-control">
                                <span class="label-text text-xs font-bold text-gray-400 mb-1">Action Taken</span>
                                <textarea name="action" id="txt-ticket-action" class="textarea textarea-bordered h-24 text-xs" placeholder="การแก้ไขเบื้องต้น..."></textarea>
                            </div>
                        </div>
                    </div>

                    <div class="collapse collapse-arrow border border-base-200 bg-base-50 rounded-xl">
                        <input type="checkbox" /> 
                        <div class="collapse-title text-sm font-bold text-gray-600 flex items-center gap-2">
                            <i class="fas fa-check-double text-green-500"></i> Resolution & Assign
                        </div>
                        <div class="collapse-content space-y-4 pt-2">
                            <div class="form-control">
                                <span class="label-text text-xs font-bold text-gray-400 mb-1">Resolution Detail</span>
                                <textarea name="resolvedDetail" id="txt-ticket-resolved" class="textarea textarea-bordered h-20 text-xs" placeholder="รายละเอียดการแก้ไข..."></textarea>
                            </div>
                            <div class="grid grid-cols-2 gap-4">
                                <div class="form-control">
                                    <span class="label-text text-xs font-bold text-gray-400 mb-1">Responsibility</span>
                                    <input type="text" name="responsibility" id="inp-ticket-resp" class="input input-sm input-bordered w-full">
                                </div>
                                <div class="form-control">
                                    <span class="label-text text-xs font-bold text-gray-400 mb-1">Assignee</span>
                                    <input type="text" name="assignee" id="inp-ticket-assign" class="input input-sm input-bordered w-full">
                                </div>
                            </div>
                            <div class="form-control">
                                <span class="label-text text-xs font-bold text-gray-400 mb-1">Remark</span>
                                <textarea name="remark" id="txt-ticket-remark" class="textarea textarea-bordered h-16 text-xs"></textarea>
                            </div>
                        </div>
                    </div>

                </div>

                <div class="px-6 py-4 border-t border-base-200 bg-gray-50 flex justify-end gap-2 sticky bottom-0 z-10">
                    <button type="button" class="btn btn-sm btn-ghost text-gray-500" onclick="document.getElementById('modal-ticket-form').close()">Cancel</button>
                    <button type="submit" id="btn-save-ticket" class="btn btn-sm btn-primary min-w-[100px]">
                        <span class="loading loading-spinner loading-xs hidden" id="spinner-save-ticket"></span>
                        Save
                    </button>
                </div>
            </form>
        </div>
        <form method="dialog" class="modal-backdrop bg-black/40 backdrop-blur-[1px]"><button>close</button></form>
    </dialog>

</div>