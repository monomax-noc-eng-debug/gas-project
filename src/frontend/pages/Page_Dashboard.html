<script>
  const Dashboard = {
    currentFilter: 'DAY',
    currentDate: new Date().toISOString().split('T')[0],

    init() {
      this.loadData();
    },

    loadData() {
      UIManager.showLoading();
      Server.call('getMatches', this.currentFilter, this.currentDate)
        .then(data => this.renderTable(data))
        .catch(e => console.error(e))
        .finally(() => UIManager.hideLoading());
    },

    renderTable(matches) {
      const tbody = document.getElementById('match-table-body');
      if (!tbody) return;
      tbody.innerHTML = '';

      if (!matches.length) { tbody.innerHTML = '<tr><td colspan="10" class="text-center p-4">No matches</td></tr>'; return; }

      matches.forEach(m => {
        const tr = document.createElement('tr');
        tr.className = "hover";

        // ✅ Logic ปิดปุ่มถ้าเป็น NON
        const isDisabled = (m.signalOwner === 'NON' || !m.signalOwner) ? 'disabled' : '';

        // ✅ Dropdown Options
        const opts = ['NON', 'HOST', 'RECEIVE'].map(o => `<option value="${o}" ${m.signalOwner === o ? 'selected' : ''}>${o}</option>`).join('');

        tr.innerHTML = `
        <td class="font-mono text-xs">${m.time}</td>
        <td><div class="font-bold text-sm">${m.league}</div><div class="text-xs text-gray-500">${m.home} vs ${m.away}</div></td>
        <td><span class="badge badge-ghost badge-sm">${m.channel}</span></td>
        <td>
          <select class="select select-bordered select-xs w-24" onchange="Dashboard.updateSignal('${m.id}', this.value)">${opts}</select>
        </td>
        <td>
          <div class="join">
            <button id="btn-in-${m.id}" class="btn btn-xs btn-success join-item text-white" ${isDisabled} onclick="Dashboard.setStatus('${m.id}','IN')">IN</button>
            <button id="btn-out-${m.id}" class="btn btn-xs btn-error join-item text-white" ${isDisabled} onclick="Dashboard.setStatus('${m.id}','OUT')">OUT</button>
          </div>
        </td>
        <td><span class="badge ${m.status === 'LIVE' ? 'badge-success' : m.status === 'DONE' ? 'badge-neutral' : 'badge-ghost'} badge-sm">${m.status}</span></td>
      `;
        tbody.appendChild(tr);
      });
    },

    updateSignal(id, val) {
      Server.call('toggleSignalOwner', id, val);
      const bIn = document.getElementById(`btn-in-${id}`);
      const bOut = document.getElementById(`btn-out-${id}`);
      if (val === 'NON') { if (bIn) bIn.disabled = true; if (bOut) bOut.disabled = true; }
      else { if (bIn) bIn.disabled = false; if (bOut) bOut.disabled = false; }
    },

    setStatus(id, type) {
      Server.call('setMatchStatus', id, type).then(() => this.loadData());
    },

    changeDate(d) { this.currentDate = d; this.loadData(); }
  };
</script>