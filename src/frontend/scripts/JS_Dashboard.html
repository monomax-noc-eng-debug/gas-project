<script>
  /**
   * JS_Dashboard.html
   * Logic ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤ Dashboard (Corrected Version)
   */

  // üö© ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç 1: ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô const ‡πÄ‡∏õ‡πá‡∏ô var ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô Error "already declared"
  var Dashboard = {
    viewMode: "DAY", // 'DAY' | 'MONTH'
    data: [],

    init() {
      // ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏ß‡∏±‡∏ô‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô
      const today = new Date().toISOString().split("T")[0];
      const thisMonth = today.slice(0, 7);

      const datePicker = document.getElementById("dash-date-picker");
      const monthPicker = document.getElementById("dash-month-picker");

      if (datePicker) datePicker.value = today;
      if (monthPicker) monthPicker.value = thisMonth;

      this.loadData();
    },

    switchMode(mode) {
      this.viewMode = mode;
      const datePicker = document.getElementById("dash-date-picker");
      const monthPicker = document.getElementById("dash-month-picker");

      if (mode === "DAY") {
        datePicker.classList.remove("hidden");
        monthPicker.classList.add("hidden");
      } else {
        datePicker.classList.add("hidden");
        monthPicker.classList.remove("hidden");
      }
      this.loadData();
    },

    loadData(forceRefresh = false) {
      const icon = document.getElementById("dash-refresh-icon");
      const tbody = document.getElementById("match-table-body"); // ‡πÅ‡∏Å‡πâ ID ‡πÉ‡∏´‡πâ‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö Table Body ‡∏à‡∏£‡∏¥‡∏á
      const dateVal = document.getElementById("dash-date-picker").value;
      const monthVal = document.getElementById("dash-month-picker").value;

      const filterValue = this.viewMode === "DAY" ? dateVal : monthVal;

      // UI Loading
      if (icon) icon.classList.add("fa-spin");
      if (tbody) tbody.innerHTML = `<tr><td colspan="7" class="text-center py-20 text-base-content/40"><span class="loading loading-dots loading-lg"></span></td></tr>`;

      // Call Backend
      Server.call("getMatches", this.viewMode, filterValue)
        .then((matches) => {
          this.data = matches;
          this.renderTable(matches);
          if (forceRefresh) UIManager.showToast(`Data Refreshed`, "success");
        })
        .catch((err) => {
          if (tbody) tbody.innerHTML = `<tr><td colspan="7" class="text-center py-10 text-error">Error: ${err.message}</td></tr>`;
        })
        .finally(() => {
          if (icon) icon.classList.remove("fa-spin");
        });
    },

    renderTable(matches) {
      const tbody = document.getElementById("match-table-body");
      if (!tbody) return;
      tbody.innerHTML = "";

      if (matches.length === 0) {
        tbody.innerHTML = '<tr><td colspan="10" class="text-center p-4 text-gray-500">No matches found</td></tr>';
        return;
      }

      matches.forEach((match) => {
        const tr = document.createElement("tr");
        tr.id = `row-${match.id}`;
        tr.className = "hover";

        // Logic Disable ‡∏õ‡∏∏‡πà‡∏°
        const isBtnDisabled = (match.signalOwner === "NON" || !match.signalOwner) ? "disabled" : "";

        // Dropdown Options
        const signalOptions = ["NON", "HOST", "RECEIVE"]
          .map(opt => `<option value="${opt}" ${match.signalOwner === opt ? "selected" : ""}>${opt}</option>`)
          .join("");

        tr.innerHTML = `
        <td class="font-mono text-xs">${match.time}</td>
        <td>
          <div class="font-bold text-sm">${match.league}</div>
          <div class="text-xs text-gray-500">${match.home} vs ${match.away}</div>
        </td>
        <td><span class="badge badge-ghost badge-sm">${match.channel}</span></td>
        
        <td>
          <select class="select select-bordered select-xs w-full max-w-[100px]"
            onchange="Dashboard.updateSignal('${match.id}', this.value)">
            ${signalOptions}
          </select>
        </td>

        <td>
          <div class="join">
            <button id="btn-in-${match.id}" class="btn btn-xs btn-success join-item text-white" 
              ${isBtnDisabled} 
              onclick="Dashboard.setStatus('${match.id}', 'IN')">IN</button>
            
            <button id="btn-out-${match.id}" class="btn btn-xs btn-error join-item text-white" 
              ${isBtnDisabled} 
              onclick="Dashboard.setStatus('${match.id}', 'OUT')">OUT</button>
          </div>
        </td>
        
        <td>
          <span class="badge ${match.status === "LIVE" ? "badge-success" : match.status === "DONE" ? "badge-neutral" : "badge-ghost"} badge-sm">
            ${match.status}
          </span>
        </td>
      `;
        tbody.appendChild(tr);
      });
    },

    // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï Signal Dropdown
    updateSignal(matchId, newSignal) {
      Server.call("toggleSignalOwner", matchId, newSignal)
        .then(() => { /* Success */ })
        .catch((err) => console.error(err));

      // ‡∏Ñ‡∏ß‡∏ö‡∏Ñ‡∏∏‡∏°‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏¥‡∏î/‡∏õ‡∏¥‡∏î‡∏õ‡∏∏‡πà‡∏° In/Out ‡∏ó‡∏±‡∏ô‡∏ó‡∏µ
      const btnIn = document.getElementById(`btn-in-${matchId}`);
      const btnOut = document.getElementById(`btn-out-${matchId}`);

      if (newSignal === "NON") {
        if (btnIn) btnIn.disabled = true;
        if (btnOut) btnOut.disabled = true;
      } else {
        if (btnIn) btnIn.disabled = false;
        if (btnOut) btnOut.disabled = false;
      }
    },

    // üö© ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç 2: ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô setStatus ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏£‡∏±‡∏ö‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏à‡∏≤‡∏Å‡∏õ‡∏∏‡πà‡∏°‡πÉ‡∏ô HTML
    setStatus(id, type) {
      // ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• Match ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏≠‡∏≤‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏≤‡πÅ‡∏™‡∏î‡∏á‡πÉ‡∏ô Modal
      const match = this.data.find(m => m.id == id);
      const matchName = match ? `${match.home} vs ${match.away}` : id;

      // ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å Modal ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô
      this.confirmUpdateStatus(id, type, matchName);
    },

    // Modal ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô (‡∏ñ‡πâ‡∏≤‡∏Ñ‡∏∏‡∏ì‡∏°‡∏µ UIManager.showModal ‡πÅ‡∏•‡πâ‡∏ß)
    confirmUpdateStatus(id, type, matchName) {
      const actionText = type === "IN" ? "Check-In" : "Check-Out";

      // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏°‡∏µ UIManager.showModal ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà (‡πÄ‡∏ú‡∏∑‡πà‡∏≠‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏ó‡∏≥)
      if (typeof UIManager.showModal !== 'function') {
        // Fallback: ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ Modal ‡πÉ‡∏´‡πâ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏•‡∏¢
        if (confirm(`Confirm ${actionText} for ${matchName}?`)) {
          this.executeSetStatus(id, type, actionText);
        }
        return;
      }

      UIManager.showModal({
        title: `Confirm ${actionText}`,
        confirmText: `Yes, ${actionText}`,
        body: `
          <div class="text-center">
            <div class="text-4xl mb-2 ${type === "IN" ? "text-success" : "text-error"}">
              <i class="fas ${type === "IN" ? "fa-check-circle" : "fa-times-circle"}"></i>
            </div>
            <p>Are you sure you want to <b>${actionText}</b>?</p>
            <p class="text-sm opacity-60 mt-2">${matchName}</p>
          </div>
        `,
        onConfirm: () => this.executeSetStatus(id, type, actionText)
      });
    },

    // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏¢‡∏¥‡∏á Backend ‡∏à‡∏£‡∏¥‡∏á‡πÜ
    executeSetStatus(id, type, actionText) {
      UIManager.showLoading();
      Server.call("setMatchStatus", id, type)
        .then((res) => {
          if (res.success) {
            UIManager.showToast(`${actionText} Successful`, "success");
            this.loadData(false);
          } else {
            UIManager.showToast(res.message, "error");
          }
        })
        .catch((err) => UIManager.showToast(err.message, "error"))
        .finally(() => UIManager.hideLoading());
    }
  };

  // Auto Init (‡πÉ‡∏™‡πà‡πÑ‡∏ß‡πâ‡πÄ‡∏ú‡∏∑‡πà‡∏≠ JS_App ‡πÑ‡∏°‡πà‡πÄ‡∏£‡∏µ‡∏¢‡∏Å ‡πÅ‡∏ï‡πà‡πÉ‡∏™‡πà setTimeout ‡∏Å‡∏±‡∏ô‡∏ä‡∏ô)
  document.addEventListener("DOMContentLoaded", () => {
    if (typeof Dashboard !== 'undefined' && Dashboard.init) {
      // ‡πÄ‡∏ä‡πá‡∏Ñ‡∏ß‡πà‡∏≤ JS_App ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡πÑ‡∏õ‡∏´‡∏£‡∏∑‡∏≠‡∏¢‡∏±‡∏á ‡∏ñ‡πâ‡∏≤‡∏¢‡∏±‡∏á‡∏Ñ‡πà‡∏≠‡∏¢‡πÄ‡∏£‡∏µ‡∏¢‡∏Å
      // ‡πÅ‡∏ï‡πà‡∏õ‡∏Å‡∏ï‡∏¥ JS_App ‡∏à‡∏∞‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡πÉ‡∏´‡πâ
    }
  });
</script>