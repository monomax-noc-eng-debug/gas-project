<script>
  /**
   * JS_Dashboard.html
   * Logic สำหรับหน้า Dashboard (Safe Syntax Version)
   */
  var Dashboard = {
    viewMode: "DAY",
    data: [],
    currentUpload: null,

    init: function () {
      var now = new Date();
      var year = now.getFullYear();
      var month = String(now.getMonth() + 1).padStart(2, '0');
      var day = String(now.getDate()).padStart(2, '0');

      var today = year + '-' + month + '-' + day;
      var thisMonth = year + '-' + month;

      var datePicker = document.getElementById("dash-date-picker");
      var monthPicker = document.getElementById("dash-month-picker");

      if (datePicker) datePicker.value = today;
      if (monthPicker) monthPicker.value = thisMonth;

      // เพิ่ม Event Listener สำหรับ Paste รูปภาพ
      var self = this;
      document.addEventListener('paste', function (e) { self.handlePaste(e); });

      this.loadData();
    },

    switchMode: function (mode) {
      this.viewMode = mode;
      var datePicker = document.getElementById("dash-date-picker");
      var monthPicker = document.getElementById("dash-month-picker");

      if (mode === "DAY") {
        datePicker.classList.remove("hidden");
        monthPicker.classList.add("hidden");
      } else {
        datePicker.classList.add("hidden");
        monthPicker.classList.remove("hidden");
      }
      this.loadData();
    },

    loadData: function (forceRefresh) {
      var icon = document.getElementById("dash-refresh-icon");
      var tbody = document.getElementById("match-table-body");
      var dateVal = document.getElementById("dash-date-picker").value;
      var monthVal = document.getElementById("dash-month-picker").value;
      var filterValue = this.viewMode === "DAY" ? dateVal : monthVal;

      if (icon) icon.classList.add("fa-spin");

      if (forceRefresh || !this.data.length) {
        if (tbody) tbody.innerHTML = '<tr><td colspan="8" class="text-center py-20"><span class="loading loading-dots loading-lg"></span></td></tr>';
      }

      var self = this;
      Server.call("getMatches", this.viewMode, filterValue)
        .then(function (matches) {
          self.data = matches;
          self.renderTable(matches);
          if (forceRefresh) UIManager.showToast("Updated", "success");
        })
        .catch(function (err) {
          if (tbody) tbody.innerHTML = '<tr><td colspan="8" class="text-center py-10 text-error">Error: ' + err.message + '</td></tr>';
        })
        .finally(function () {
          if (icon) icon.classList.remove("fa-spin");
        });
    },

    updateSignal: function (id, val) {
      var selectEl = document.getElementById('signal-select-' + id);
      var containerEl = document.getElementById('signal-container-' + id);

      if (selectEl) selectEl.disabled = true;

      var spinner = document.createElement("span");
      spinner.id = 'spinner-' + id;
      spinner.className = "loading loading-spinner loading-xs text-primary absolute -right-6 top-1/2 transform -translate-y-1/2";
      if (containerEl) containerEl.appendChild(spinner);

      var self = this;
      Server.call("toggleSignalOwner", id, val)
        .then(function () {
          self.loadData(false);
          UIManager.showToast("Saved", "success");
        })
        .catch(function (err) {
          if (selectEl) selectEl.disabled = false;
          if (containerEl && spinner) spinner.remove();
          UIManager.showToast("Update Failed: " + err.message, "error");
        });
    },

    renderTable: function (matches) {
      var tbody = document.getElementById("match-table-body");
      if (!tbody) return;
      tbody.innerHTML = "";

      if (matches.length === 0) {
        tbody.innerHTML = '<tr><td colspan="8" class="text-center p-4 text-gray-500">No matches found</td></tr>';
        return;
      }

      var self = this;
      matches.forEach(function (match) {
        var tr = document.createElement("tr");
        tr.className = "hover";

        var signalVal = match.signalOwner || "NON";

        // สร้าง Options
        var optionsHtml = "";
        var opts = [
          { val: "NON", label: "ไม่มี" },
          { val: "HOST", label: "noc start" },
          { val: "RECEIVE", label: "cus start" }
        ];
        opts.forEach(function (opt) {
          var selected = (signalVal === opt.val) ? "selected" : "";
          optionsHtml += '<option value="' + opt.val + '" ' + selected + '>' + opt.label + '</option>';
        });

        var hasStart = !!match.start_img;
        var hasStop = !!match.stop_img;
        var isStartDone = hasStart || signalVal === "RECEIVE";
        var isComplete = isStartDone && hasStop;

        var disableStart = "";
        if (signalVal === "NON" || hasStart || signalVal === "RECEIVE") {
          disableStart = "disabled";
        }
        var disableStop = (signalVal === "NON" || hasStop) ? "disabled" : "";
        var disableAction = isComplete ? "disabled" : "";

        var btnStartClass = hasStart ? "btn-disabled bg-success/20 text-success" : "btn-success text-white";
        var btnStopClass = hasStop ? "btn-disabled bg-error/20 text-error" : "btn-error text-white";

        var statusSymbol = '<span class="text-gray-300"><i class="fas fa-minus"></i></span>';
        if (isComplete) {
          statusSymbol = '<div class="tooltip" data-tip="Completed"><i class="fas fa-check-circle text-success text-xl"></i></div>';
        } else if (isStartDone) {
          statusSymbol = '<div class="tooltip" data-tip="On Air"><i class="fas fa-video text-error text-xl animate-pulse"></i></div>';
        } else if (hasStop) {
          statusSymbol = '<div class="tooltip" data-tip="Stop Only"><i class="fas fa-stop-circle text-warning text-xl"></i></div>';
        }

        // ใช้ String Concatenation แทน Template Literal เพื่อความปลอดภัยสูงสุด
        var html = '';
        html += '<td class="font-mono text-xs">' + match.time + '</td>';
        html += '<td>';
        html += '<div class="font-bold text-sm">' + match.league + '</div>';
        html += '<div class="text-xs text-gray-500">' + match.home + ' vs ' + match.away + '</div>';
        html += '</td>';
        html += '<td><span class="badge badge-ghost badge-sm">' + match.channel + '</span></td>';

        html += '<td class="text-center">';
        html += '<div id="signal-container-' + match.id + '" class="relative inline-block w-full max-w-[120px]">';
        html += '<select id="signal-select-' + match.id + '" class="select select-bordered select-xs w-full" onchange="Dashboard.updateSignal(\'' + match.id + '\', this.value)">';
        html += optionsHtml;
        html += '</select>';
        html += '</div>';
        html += '</td>';

        html += '<td class="text-center">';
        html += '<button class="btn btn-xs ' + btnStartClass + ' w-full" ' + disableStart + ' onclick="Dashboard.openUploadModal(\'' + match.id + '\', \'START\')">';
        html += (hasStart ? '<i class="fas fa-check"></i>' : 'Start');
        html += '</button>';
        html += '</td>';

        html += '<td class="text-center">';
        html += '<button class="btn btn-xs ' + btnStopClass + ' w-full" ' + disableStop + ' onclick="Dashboard.openUploadModal(\'' + match.id + '\', \'STOP\')">';
        html += (hasStop ? '<i class="fas fa-check"></i>' : 'Stop');
        html += '</button>';
        html += '</td>';

        html += '<td class="text-center">' + statusSymbol + '</td>';

        html += '<td class="text-center">';
        html += '<div class="join">';
        html += '<button class="btn btn-xs btn-ghost join-item text-warning" ' + disableAction + ' onclick="Dashboard.editMatch(\'' + match.id + '\')"><i class="fas fa-edit"></i></button>';
        html += '<button class="btn btn-xs btn-ghost join-item text-error" ' + disableAction + ' onclick="Dashboard.deleteMatch(\'' + match.id + '\')"><i class="fas fa-trash-alt"></i></button>';
        html += '</div>';
        html += '</td>';

        tr.innerHTML = html;
        tbody.appendChild(tr);
      });
    },

    openUploadModal: function (id, type) {
      this.currentUpload = { matchId: id, type: type, file: null };

      var bodyHtml = '';
      bodyHtml += '<div class="text-center space-y-4">';
      bodyHtml += '<p class="text-sm text-gray-500">คลิกเพื่อเลือกไฟล์ หรือ Paste (Ctrl+V) รูปภาพที่นี่</p>';
      bodyHtml += '<div id="upload-zone" onclick="document.getElementById(\'hidden-file-input\').click()" class="border-2 border-dashed border-base-300 rounded-lg p-6 cursor-pointer hover:bg-base-100 transition relative min-h-[150px] flex items-center justify-center">';
      bodyHtml += '<input type="file" id="hidden-file-input" class="hidden" accept="image/*" onchange="Dashboard.handleFileSelect(this)">';
      bodyHtml += '<div id="upload-placeholder" class="pointer-events-none">';
      bodyHtml += '<i class="fas fa-cloud-upload-alt text-3xl text-gray-400 mb-2"></i>';
      bodyHtml += '<p class="text-xs">Browse or Paste Image</p>';
      bodyHtml += '</div>';
      bodyHtml += '<img id="upload-preview" class="hidden max-h-48 rounded shadow-sm object-contain" />';
      bodyHtml += '</div>';
      bodyHtml += '</div>';

      // ✅ แก้ไข: ใช้ Single Quote และ Concatenation ป้องกัน Error 'Unexpected identifier'
      var titleText = "เพิ่มรูปภาพ (" + (type === 'START' ? 'Start' : 'Stop') + ")";
      var self = this;

      UIManager.showModal({
        title: titleText,
        body: bodyHtml,
        confirmText: 'ยืนยันอัปโหลด',
        manualClose: true, // สั่งเปิดค้างไว้
        onConfirm: function () { self.submitUpload(); }
      });
    },

    handleFileSelect: function (input) {
      if (input.files && input.files[0]) this.processFile(input.files[0]);
    },

    handlePaste: function (e) {
      if (!this.currentUpload) return;
      var items = (e.clipboardData || e.originalEvent.clipboardData).items;
      for (var i = 0; i < items.length; i++) {
        if (items[i].kind === 'file' && items[i].type.startsWith('image/')) {
          this.processFile(items[i].getAsFile());
          break;
        }
      }
    },

    processFile: function (file) {
      this.currentUpload.file = file;
      var reader = new FileReader();
      reader.onload = function (e) {
        var img = document.getElementById('upload-preview');
        var ph = document.getElementById('upload-placeholder');
        if (img && ph) {
          img.src = e.target.result;
          img.classList.remove('hidden');
          ph.classList.add('hidden');
        }
      };
      reader.readAsDataURL(file);
    },

    submitUpload: function () {
      if (!this.currentUpload || !this.currentUpload.file) {
        UIManager.showToast("กรุณาเลือกรูปภาพก่อนครับ", "warning");
        return;
      }

      var modalBox = document.querySelector('.modal[open] .modal-box') || document.querySelector('.modal-box');
      var confirmBtn = modalBox ? modalBox.querySelector('.btn-primary') : null;
      var originalBtnText = confirmBtn ? confirmBtn.innerHTML : 'ยืนยันอัปโหลด';

      // ✅ 1. แปลงร่างปุ่มเป็น Progress Bar (ใช้ String ปกติ)
      if (confirmBtn) {
        confirmBtn.style.position = 'relative';
        confirmBtn.style.overflow = 'hidden';
        confirmBtn.disabled = true;

        var progressHtml = '';
        progressHtml += '<div id="btn-progress-bar" style="position: absolute; top: 0; left: 0; bottom: 0; width: 0%; background-color: rgba(0,0,0,0.3); transition: width 0.2s linear;"></div>';
        progressHtml += '<span id="btn-progress-text" style="position: relative; z-index: 1;">Uploading... 0%</span>';

        confirmBtn.innerHTML = progressHtml;
      }

      // ✅ 2. จำลองตัวเลขวิ่ง (Simulate Progress)
      var progress = 0;
      var progressInterval = setInterval(function () {
        if (progress < 90) {
          progress += Math.floor(Math.random() * 5) + 1;
          if (progress > 90) progress = 90;
        }
        if (confirmBtn) {
          var bar = confirmBtn.querySelector('#btn-progress-bar');
          var txt = confirmBtn.querySelector('#btn-progress-text');
          if (bar) bar.style.width = progress + '%';
          if (txt) txt.innerText = 'Uploading... ' + progress + '%';
        }
      }, 300);

      // ✅ 3. ส่งข้อมูลไป Backend
      var uploadData = this.currentUpload;
      var reader = new FileReader();
      reader.readAsDataURL(uploadData.file);

      var self = this;
      reader.onload = function () {
        var base64 = reader.result.split(',')[1];

        Server.call("uploadMatchImage", uploadData.matchId, uploadData.type, base64, uploadData.file.type)
          .then(function (res) {
            clearInterval(progressInterval); // หยุดตัวเลขวิ่ง

            if (confirmBtn) {
              var bar = confirmBtn.querySelector('#btn-progress-bar');
              var txt = confirmBtn.querySelector('#btn-progress-text');
              if (bar) bar.style.width = '100%';
              if (txt) txt.innerText = 'Completed 100%!';
            }

            if (res.success) {
              UIManager.showToast("อัปโหลดสำเร็จ", "success");
              self.currentUpload = null;

              setTimeout(function () {
                var modal = document.querySelector('.modal[open]') || document.getElementById('core-modal');
                if (modal) {
                  if (typeof modal.close === 'function') modal.close();
                  else modal.removeAttribute('open');

                  if (modal.id.startsWith('dynamic-modal')) modal.remove();
                }
                self.loadData();
              }, 1000);

            } else {
              UIManager.showToast(res.message || "เกิดข้อผิดพลาด", "error");
              if (confirmBtn) {
                confirmBtn.innerHTML = originalBtnText;
                confirmBtn.disabled = false;
                confirmBtn.style.position = '';
              }
            }
          })
          .catch(function (err) {
            clearInterval(progressInterval);
            UIManager.showToast(err.message, "error");
            if (confirmBtn) {
              confirmBtn.innerHTML = originalBtnText;
              confirmBtn.disabled = false;
              confirmBtn.style.position = '';
            }
          });
      };
    },

    editMatch: function (id) { alert("ระบบแก้ไขกำลังพัฒนา"); },
    deleteMatch: function (id) {
      var self = this;
      UIManager.showModal({
        title: "ลบรายการ",
        body: "คุณแน่ใจหรือไม่ที่จะลบรายการนี้?",
        confirmText: "ลบรายการ",
        onConfirm: function () {
          Server.call('deleteMatch', id)
            .then(function () { UIManager.showToast("ลบสำเร็จ", "success"); self.loadData(); })
            .catch(function (err) { console.error(err); });
        }
      });
    }
  };

  // เรียกใช้เมื่อโหลดหน้าจอ
  document.addEventListener("DOMContentLoaded", function () {
    if (typeof Dashboard !== 'undefined' && Dashboard.init) {
      // Init manually if needed
    }
  });
</script>