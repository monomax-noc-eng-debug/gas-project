<script>
    /**
     * JS_Dashboard.html
     * Logic: Show matches exactly on the selected date (00:00 - 23:59)
     * Version: Optimized for Stability
     */
    const Dashboard = (function () {
        // --- Helpers ---
        const getEl = function (id) { return document.getElementById(id); };
        let _currentDate = new Date();
        let _allWorkData = [];
        let _pickers = {};
        let _currentBlobs = { start: null, stop: null, 'stop-quick': null };
        let _editMode = 'all'; // 'new', 'all', 'start', 'stop'

        // --- Date Helpers ---
        const toDisplayDate = (date) => {
            if (!date) return "";
            const d = new Date(date);
            const y = d.getFullYear();
            const m = String(d.getMonth() + 1).padStart(2, '0');
            const day = String(d.getDate()).padStart(2, '0');
            return `${day}/${m}/${y}`;
        };

        const toInputDate = (date) => {
            if (!date) return "";
            const d = new Date(date);
            const y = d.getFullYear();
            const m = String(d.getMonth() + 1).padStart(2, '0');
            const day = String(d.getDate()).padStart(2, '0');
            return `${y}-${m}-${day}`;
        };

        const showToastInModal = (msg, type, modalId) => {
            const targetEl = getEl(modalId);
            Swal.fire({
                toast: true,
                position: 'top-end',
                showConfirmButton: false,
                timer: 3000,
                icon: type,
                title: msg,
                target: targetEl || 'body',
                customClass: { container: 'z-[999999]' }
            });
        };

        const createPicker = (elementId, onSelectCallback) => {
            const el = getEl(elementId);
            if (!el) return null;
            return new Pikaday({
                field: el,
                format: 'DD/MM/YYYY',
                theme: 'triangle-theme',
                i18n: { previousMonth: 'เดือนก่อน', nextMonth: 'เดือนถัดไป', months: ['มกราคม', 'กุมภาพันธ์', 'มีนาคม', 'เมษายน', 'พฤษภาคม', 'มิถุนายน', 'กรกฎาคม', 'สิงหาคม', 'กันยายน', 'ตุลาคม', 'พฤศจิกายน', 'ธันวาคม'], weekdays: ['อาทิตย์', 'จันทร์', 'อังคาร', 'พุธ', 'พฤหัสบดี', 'ศุกร์', 'เสาร์'], weekdaysShort: ['อา', 'จ', 'อ', 'พ', 'พฤ', 'ศ', 'ส'] },
                toString(date, format) {
                    const y = date.getFullYear();
                    const m = String(date.getMonth() + 1).padStart(2, '0');
                    const d = String(date.getDate()).padStart(2, '0');
                    return `${d}/${m}/${y}`;
                },
                onSelect: onSelectCallback
            });
        };

        const compressImage = function (file, quality = 0.8) { return new Promise((resolve, reject) => { const r = new FileReader(); r.readAsDataURL(file); r.onload = e => { const i = new Image(); i.src = e.target.result; i.onload = () => { const c = document.createElement('canvas'); let w = i.width, h = i.height, m = 1200; if (w > m) { h *= m / w; w = m } c.width = w; c.height = h; c.getContext('2d').drawImage(i, 0, 0, w, h); resolve(c.toDataURL('image/jpeg', quality).split(',')[1]) }; i.onerror = reject }; r.onerror = reject }) };

        const formatDriveUrl = function (url) {
            if (!url) return "";
            if (url.startsWith('data:')) return url;
            try {
                let id = null;
                if (url.indexOf('/d/') !== -1) {
                    const match = url.match(/\/d\/(.+?)(\/|$)/);
                    if (match) id = match[1];
                } else if (url.indexOf('id=') !== -1) {
                    const match = url.match(/id=([^&]+)/);
                    if (match) id = match[1];
                }
                if (id) return 'https://drive.google.com/thumbnail?id=' + id + '&sz=w1000';
                return url;
            } catch (e) { return url; }
        };

        return {
            init: function () {
                this.initDatePickers();
                this.loadWorkList();
                document.addEventListener('page-change', function (e) {
                    if (e.detail.pageId === 'page-dashboard') {
                        if (_pickers.main) _pickers.main.setDate(_currentDate);
                        Dashboard.loadWorkList();
                    }
                });
            },

            initDatePickers: function () {
                _pickers.main = createPicker('dash-date-input', (date) => {
                    _currentDate = date;
                    Dashboard.updateDateDisplay();
                    Dashboard.renderFilteredList();
                });
                this.updateDateDisplay();
            },

            changeDate: function (days) {
                _currentDate.setDate(_currentDate.getDate() + days);
                if (_pickers.main) { _pickers.main.setDate(_currentDate); }
                else { this.updateDateDisplay(); this.renderFilteredList(); }
            },

            updateDateDisplay: function () {
                const input = getEl('dash-date-input');
                if (input) input.value = toDisplayDate(_currentDate);
            },

            loadWorkList: function (forceRefresh) {
                var loader = getEl('dash-loader');
                var empty = getEl('dash-empty');
                if (loader) loader.classList.remove('hidden');
                if (empty) empty.classList.add('hidden');

                Server.call({ func: 'apiGetWorkList', silent: true })
                    .then(function (res) {
                        if (res && res.success) {
                            _allWorkData = res.data || [];
                            Dashboard.renderFilteredList();
                        } else {
                            if (typeof UIManager !== 'undefined') UIManager.showToast("Load Failed: " + (res ? res.message : "Unknown Error"), 'error');
                        }
                    })
                    .catch(function (err) { console.error(err); })
                    .finally(function () { if (loader) loader.classList.add('hidden'); });
            },

            renderFilteredList: function () {
                var curDateStr = toInputDate(_currentDate);

                var filtered = _allWorkData.filter(item => {
                    return item.date === curDateStr;
                });

                filtered.sort((a, b) => {
                    return a.time.localeCompare(b.time);
                });

                this.renderTable(filtered);
                this.updateStats(filtered);
            },

            formatTime: function (rawTime) {
                if (!rawTime) return "-";
                var str = String(rawTime);
                if (str.indexOf('T') !== -1) return str.split('T')[1].substring(0, 5);
                return str.substring(0, 5);
            },

            renderTable: function (data) {
                var tbody = getEl('work-list-body');
                var empty = getEl('dash-empty');
                if (!tbody) return;
                tbody.innerHTML = '';

                if (!data || data.length === 0) {
                    if (empty) empty.classList.remove('hidden');
                    return;
                }
                if (empty) empty.classList.add('hidden');

                var html = '';
                data.forEach(function (item) {
                    var isDone = item.status === 'DONE';
                    var now = new Date();
                    var matchTimeStr = item.date + 'T' + item.time + ':00';
                    var matchDate = new Date(matchTimeStr);
                    var matchEndDate = new Date(matchDate.getTime() + 120 * 60 * 1000); // 2 Hours duration
                    var isTimeReached = now >= matchDate;
                    var isMatchEnded = now >= matchEndDate;
                    var hasStart = !!item.start_img;

                    // 1. Status Widget Calculation
                    var statusWidget = '';
                    if (isDone) {
                        statusWidget = '<div class="flex flex-col items-center justify-center opacity-70"><div class="w-6 h-6 rounded-full bg-success text-white flex items-center justify-center mb-1 shadow-sm"><i class="fas fa-check text-[10px]"></i></div><span class="text-[9px] font-bold text-success tracking-wider">DONE</span></div>';
                    } else if (hasStart) {
                        if (isMatchEnded) {
                            // ENDED (Need Stop)
                            statusWidget = '<div class="flex flex-col items-center justify-center gap-1"><span class="badge badge-warning badge-sm text-white font-bold tracking-wider shadow-sm">ENDED</span><span class="text-[9px] text-warning/70">จบการแข่ง</span></div>';
                        } else if (isTimeReached) {
                            // ON AIR
                            statusWidget = '<div class="flex flex-col items-center justify-center gap-1"><div class="flex items-center gap-1 animate-pulse"><span class="w-2 h-2 bg-red-500 rounded-full shadow-[0_0_8px_rgba(239,68,68,0.6)]"></span><span class="text-[9px] font-black text-red-500 tracking-wider">ON AIR</span></div></div>';
                        } else {
                            // READY
                            statusWidget = '<div class="flex flex-col items-center justify-center gap-1"><span class="badge badge-success badge-sm text-white font-bold tracking-wider shadow-sm">READY</span><span class="text-[9px] text-success/70">รอเวลาเริ่ม</span></div>';
                        }
                    } else {
                        if (isTimeReached) {
                            // LATE (Time passed but no start image)
                            statusWidget = '<div class="flex flex-col items-center justify-center gap-1"><span class="badge badge-error badge-sm text-white font-bold tracking-wider shadow-sm">LATE</span><span class="text-[9px] text-error/70">เลยเวลาแข่ง</span></div>';
                        } else {
                            // WAIT
                            statusWidget = '<span class="badge badge-ghost badge-sm text-[10px] opacity-50">WAIT</span>';
                        }
                    }

                    // 2. Action Widget Calculation
                    var itemJson = encodeURIComponent(JSON.stringify(item));
                    var actionWidget = '<div class="flex flex-col items-center gap-1">';

                    // Stop Button (Only if Started and Not Done)
                    if (hasStart && !isDone) {
                        var stopBtnClass = isTimeReached ? 'btn-error' : 'btn-success'; // Red for On Air, Green for Ready
                        actionWidget += '<button onclick="Dashboard.openStopModal(\'' + item.id + '\')" class="btn btn-xs btn-outline ' + stopBtnClass + ' bg-white hover:text-white transition-all shadow-sm w-full max-w-[80px] gap-1"><i class="fas fa-stop"></i> จบงาน</button>';
                    }

                    // Edit Button (Always visible)
                    actionWidget += '<button onclick="Dashboard.openEditModal(\'' + itemJson + '\', \'all\')" class="btn btn-ghost btn-xs text-base-content/40 hover:text-primary hover:bg-base-200 gap-1 w-full max-w-[80px]"><i class="fas fa-pencil-alt"></i> แก้ไข</button>';
                    actionWidget += '</div>';

                    var btnProof = function (url, label, itemId) {
                        var itemJson = encodeURIComponent(JSON.stringify(item));
                        if (!url) {
                            return '<div onclick="Dashboard.openEditModal(\'' + itemJson + '\', \'' + label.toLowerCase() + '\')" class="tooltip cursor-pointer w-10 h-10 rounded-lg bg-warning/10 border border-warning/30 flex items-center justify-center mx-auto hover:bg-warning/20 transition-colors animate-pulse" data-tip="ยังไม่ใส่รูป ' + label + ' (คลิกเพื่อเพิ่ม)">' +
                                '<i class="fas fa-exclamation text-warning text-xs"></i>' +
                                '</div>';
                        }
                        var validUrl = formatDriveUrl(url);
                        return '<div onclick="Dashboard.viewImage(\'' + validUrl + '\')" class="tooltip cursor-pointer hover:scale-110 transition-transform bg-white rounded-lg shadow-sm border border-base-200 p-0.5 inline-block" data-tip="ดูรูป ' + label + '"><img src="' + validUrl + '" class="h-10 w-10 object-cover rounded-md" onerror="this.onerror=null;this.src=\'https://placehold.co/40x40?text=Err\'"></div>';
                    };

                    html += '<tr class="hover:bg-base-50 transition-colors border-b border-base-100 last:border-none h-16"><td class="text-center font-mono font-bold text-base-content/70">' + Dashboard.formatTime(item.time) + '</td><td class="pl-4 align-middle"><div class="flex flex-col justify-center h-full"><span class="text-[9px] font-bold text-base-content/40 uppercase tracking-widest mb-0.5 truncate max-w-[200px]">' + (item.league || '-') + '</span><div class="font-bold text-sm text-base-content/90 flex items-center gap-1 truncate"><div class="truncate max-w-[150px]">' + (hasStart ? '<span class="text-primary">' + item.home + '</span>' : item.home) + '</div><span class="text-[10px] text-base-content/30 px-1 font-normal">vs</span><div class="truncate max-w-[150px]">' + (hasStart ? '<span class="text-primary">' + item.away + '</span>' : item.away) + '</div></div></div></td><td class="text-center"><span class="badge badge-ghost badge-sm font-mono text-[10px]">' + (item.channel || '-') + '</span></td><td class="text-center align-middle">' + btnProof(item.start_img, 'Start', item.id) + '</td><td class="text-center align-middle">' + btnProof(item.stop_img, 'Stop', item.id) + '</td><td class="text-center align-middle bg-base-50/50 h-16">' + statusWidget + '</td><td class="text-center align-middle">' + actionWidget + '</td></tr>';
                });
                tbody.innerHTML = html;
            },

            updateStats: function (data) {
                var live = data.filter(function (d) { return d.status === 'LIVE'; }).length;
                var done = data.filter(function (d) { return d.status === 'DONE'; }).length;
                var liveEl = getEl('stat-live'); if (liveEl) liveEl.innerText = live;
                var doneEl = getEl('stat-done'); if (doneEl) doneEl.innerText = done;
            },

            openAddModal: function () {
                this._editMode = 'new';
                getEl('form-add-work').reset();
                getEl('input-edit-id').value = "";
                getEl('modal-title-work').innerText = "เริ่มงานใหม่ (New Work)";

                // Ensure grid is 3 columns for new work
                getEl('section-import').classList.remove('hidden');
                getEl('form-add-work').classList.remove('lg:grid-cols-2');
                getEl('form-add-work').classList.add('lg:grid-cols-3');

                getEl('section-img-stop').classList.add('hidden');
                getEl('btn-delete-work').classList.add('hidden');

                getEl('btn-submit-start').innerHTML = '<span class="loading loading-spinner loading-xs hidden" id="spinner-submit-start"></span><i class="fas fa-save"></i> <span>บันทึกและเริ่มงาน</span>';

                var now = new Date();
                var inputDate = toInputDate(now);
                getEl('input-date').value = inputDate;

                var HH = String(now.getHours()).padStart(2, '0');
                var ii = String(now.getMinutes()).padStart(2, '0');
                getEl('input-time').value = HH + ':' + ii;

                this.clearImage('start');
                this.clearImage('stop');

                // Auto fetch calendar
                getEl('import-date-picker').value = inputDate;
                this.fetchCalendarEvents();

                getEl('modal-add-work').showModal();

                this.checkUploadState();
            },

            openEditModal: function (itemEncoded, mode) {
                this._editMode = mode || 'all';
                var item = JSON.parse(decodeURIComponent(itemEncoded));
                getEl('input-edit-id').value = item.id;
                getEl('input-date').value = item.date;
                getEl('input-time').value = item.time;
                getEl('input-league').value = item.league;
                getEl('input-home').value = item.home;
                getEl('input-away').value = item.away;
                getEl('input-channel').value = item.channel;

                getEl('modal-title-work').innerText = "แก้ไขข้อมูล (Edit)";

                // Hide or Disable Calendar column in Edit Mode? 
                // Requirement says "Start Work" (New Work) needs it. For Edit, it might be distracting or useful.
                // Usually Edit is focused on the item. Let's hide it for clarity or make it insensitive.
                // Converting to 3 column makes hiding one column leave a gap if using grid-cols-3.
                // If we hide section-import, we have 2 columns left.
                // We should update the grid class on the form if we hide the column, OR just hide the content.
                // Simpler: Add 'hidden' to the div, and the grid will auto-adjust if we change grid-cols.
                // But grid-cols-3 assumes 3 children. If one is hidden, it leaves a gap.
                // Tailwind grid: if child is hidden, it doesn't take space? No, it doesn't take space in flow, but grid-cols-3 enforces 3 columns?
                // Actually if a child is hidden (display:none), it does not occupy a grid cell.
                // However, we need to span the remaining columns or change the grid definition.
                // Let's just hide it and let the other 2 columns take their place, but we might want them to expand.
                // If we change class to 'grid-cols-1 lg:grid-cols-2' when in edit mode.

                getEl('section-import').classList.add('hidden');
                getEl('form-add-work').classList.remove('lg:grid-cols-3');
                getEl('form-add-work').classList.add('lg:grid-cols-2');

                // getEl('section-img-stop').classList.remove('hidden'); // Let checkUploadState handle this
                getEl('btn-delete-work').classList.remove('hidden');
                getEl('btn-submit-start').innerHTML = '<span class="loading loading-spinner loading-xs hidden" id="spinner-submit-start"></span><i class="fas fa-save"></i> <span>บันทึกการแก้ไข</span>';

                this.clearImage('start');
                this.clearImage('stop');

                if (item.start_img) {
                    getEl('preview-start-img').src = formatDriveUrl(item.start_img);
                    getEl('wrapper-preview-start').classList.remove('hidden');
                }
                if (item.stop_img) {
                    getEl('preview-stop-img').src = formatDriveUrl(item.stop_img);
                    getEl('wrapper-preview-stop').classList.remove('hidden');
                }
                getEl('modal-add-work').showModal();

                this.checkUploadState();
            },

            handleDeleteWork: function () {
                var id = getEl('input-edit-id').value;
                if (!id) return;

                Swal.fire({
                    title: 'ยืนยันการลบ?',
                    text: "คุณต้องการลบรายการนี้ใช่หรือไม่",
                    icon: 'warning',
                    showCancelButton: true,
                    confirmButtonColor: '#d33',
                    cancelButtonColor: '#3085d6',
                    confirmButtonText: 'ใช่, ลบรายการ',
                    cancelButtonText: 'ยกเลิก',
                    target: getEl('modal-add-work')
                }).then((result) => {
                    if (result.isConfirmed) {
                        var btn = getEl('btn-delete-work');
                        var btnTxt = btn.innerHTML;
                        btn.disabled = true;
                        btn.innerHTML = '<span class="loading loading-spinner loading-xs"></span> กำลังลบ...';

                        Server.call({ func: 'apiDeleteWorkItem', silent: true }, id)
                            .then(res => {
                                if (res && res.success) {
                                    showToastInModal("ลบรายการเรียบร้อย", "success", "modal-add-work");
                                    setTimeout(() => {
                                        getEl('modal-add-work').close();
                                        Dashboard.loadWorkList(true);
                                    }, 1000);
                                } else { throw new Error(res ? res.message : "Unknown Error"); }
                            })
                            .catch(e => Swal.fire({ title: 'Error', text: e.message, icon: 'error', target: getEl('modal-add-work') }))
                            .finally(() => { btn.disabled = false; btn.innerHTML = btnTxt; });
                    }
                });
            },

            handleSubmitWork: function () {
                var form = getEl('form-add-work');
                if (!form.checkValidity()) { form.reportValidity(); return; }

                var id = getEl('input-edit-id').value;
                var isEdit = !!id;

                var rawDate = getEl('input-date').value;
                var rawTime = getEl('input-time').value;

                var payload = {
                    id: id,
                    date: rawDate,
                    time: rawTime,
                    league: getEl('input-league').value,
                    home: getEl('input-home').value,
                    away: getEl('input-away').value,
                    channel: getEl('input-channel').value
                };

                var btn = getEl('btn-submit-start');
                var spinner = getEl('spinner-submit-start');
                btn.disabled = true; spinner.classList.remove('hidden');

                const sendData = (finalPayload, apiFunc) => {
                    Server.call({ func: apiFunc, silent: true }, finalPayload)
                        .then(res => {
                            if (res && res.success) {
                                showToastInModal(isEdit ? "แก้ไขข้อมูลสำเร็จ" : "เริ่มงานสำเร็จ", "success", "modal-add-work");
                                setTimeout(() => {
                                    getEl('modal-add-work').close();
                                    Dashboard.loadWorkList(true);
                                }, 1000);
                            } else { throw new Error(res ? res.message : "Unknown Error"); }
                        })
                        .catch(e => {
                            Swal.fire({ title: 'Error', text: e.message, icon: 'error', target: getEl('modal-add-work') });
                        })
                        .finally(() => { btn.disabled = false; spinner.classList.add('hidden'); });
                };

                if (isEdit) {
                    const promises = [];
                    if (_currentBlobs['start']) promises.push(compressImage(_currentBlobs['start']).then(b64 => payload.startImageBase64 = b64));
                    if (_currentBlobs['stop']) promises.push(compressImage(_currentBlobs['stop']).then(b64 => payload.stopImageBase64 = b64));

                    Promise.all(promises).then(() => { sendData(payload, 'apiUpdateWorkItem'); });
                } else {
                    if (_currentBlobs['start']) {
                        compressImage(_currentBlobs['start']).then(base64 => {
                            payload.imageBase64 = base64;
                            payload.mimeType = 'image/jpeg';
                            sendData(payload, 'apiCreateWorkItem');
                        });
                    } else {
                        payload.imageBase64 = null;
                        sendData(payload, 'apiCreateWorkItem');
                    }
                }
            },

            openStopModal: function (id) {
                getEl('inp-stop-id-quick').value = id;
                this.clearImage('stop-quick');
                getEl('modal-stop-work').showModal();
            },

            submitStopWork: function (skipImage) {
                var id = getEl('inp-stop-id-quick').value;
                var blob = _currentBlobs['stop-quick'];

                if (!skipImage && !blob) {
                    // Allowed optional stop image
                }

                var btn = getEl('btn-submit-stop');
                var btnSkip = getEl('btn-submit-stop-skip');
                var spinner = getEl('spinner-submit-stop');

                if (btn) btn.disabled = true;
                if (btnSkip) btnSkip.disabled = true;
                if (spinner) spinner.classList.remove('hidden');

                const sendStop = (base64) => {
                    Server.call({ func: 'apiStopWorkItem', silent: true }, {
                        id: id,
                        imageBase64: base64,
                        mimeType: 'image/jpeg',
                        isSkipImage: skipImage
                    })
                        .then(function (res) {
                            if (res && res.success) {
                                showToastInModal("จบงานเรียบร้อย!", "success", "modal-stop-work");
                                setTimeout(() => {
                                    getEl('modal-stop-work').close();
                                    Dashboard.loadWorkList(true);
                                }, 1000);
                            } else { throw new Error(res ? res.message : "Unknown Error"); }
                        })
                        .catch(function (e) {
                            Swal.fire({ title: 'Error', text: e.message, icon: 'error', target: getEl('modal-stop-work') });
                        })
                        .finally(() => {
                            if (btn) btn.disabled = false;
                            if (btnSkip) btnSkip.disabled = false;
                            if (spinner) spinner.classList.add('hidden');
                        });
                };

                if (skipImage) {
                    sendStop(null);
                } else {
                    compressImage(blob).then(sendStop);
                }
            },

            triggerPaste: async function (mode) {
                var modalId = mode === 'stop-quick' ? 'modal-stop-work' : 'modal-add-work';
                var areaId = mode === 'stop-quick' ? 'paste-area-stop-quick' : 'paste-area-' + mode;
                var area = getEl(areaId);

                if (area) {
                    area.style.width = '1px'; area.style.height = '1px'; area.style.opacity = '0';
                    area.style.position = 'fixed'; area.focus();
                    if (!area.hasAttribute('data-listening')) {
                        area.addEventListener('paste', (e) => Dashboard.handlePasteEvent(e, mode));
                        area.setAttribute('data-listening', 'true');
                    }
                }

                try {
                    const clipboardItems = await navigator.clipboard.read();
                    let imageFound = false;
                    for (const item of clipboardItems) {
                        const imageTypes = item.types.filter(type => type.startsWith('image/'));
                        for (const type of imageTypes) {
                            const blob = await item.getType(type);
                            this.setPreview(mode, blob);
                            showToastInModal("วางรูปสำเร็จ", "success", modalId);
                            imageFound = true;
                            break;
                        }
                        if (imageFound) break;
                    }
                    if (!imageFound) showToastInModal("ไม่พบรูปภาพใน Clipboard", "warning", modalId);
                } catch (err) {
                    console.warn("Clipboard API failed:", err);
                    showToastInModal("กด Ctrl+V เพื่อวางรูป", "info", modalId);
                }
            },

            handlePasteEvent: function (e, mode) {
                var items = (e.clipboardData || e.originalEvent.clipboardData).items;
                for (var i = 0; i < items.length; i++) {
                    if (items[i].type.indexOf("image") !== -1) {
                        var blob = items[i].getAsFile();
                        this.setPreview(mode, blob);
                        e.preventDefault();
                        var modalId = mode === 'stop-quick' ? 'modal-stop-work' : 'modal-add-work';
                        showToastInModal("วางรูปเรียบร้อย", "success", modalId);
                        return;
                    }
                }
            },

            toggleCalendar: function () {
                // Function removed as calendar is always visible
            },

            fetchCalendarEvents: function () {
                var dateVal = getEl('import-date-picker').value;
                if (!dateVal) dateVal = getEl('input-date').value;
                if (!dateVal) return;

                var loader = getEl('cal-loader');
                var list = getEl('calendar-picker-list');
                loader.classList.remove('hidden');
                list.innerHTML = '';

                Server.call({ func: 'apiGetCalendarEvents', silent: true }, dateVal)
                    .then(function (res) {
                        loader.classList.add('hidden');
                        if (res && res.success) Dashboard.renderImportList(res.data);
                        else list.innerHTML = '<div class="text-error text-center text-xs p-4">' + (res ? res.message : "No Data") + '</div>';
                    })
                    .catch(function (err) {
                        loader.classList.add('hidden');
                        list.innerHTML = '<div class="text-error text-center text-xs p-4">Connection failed</div>';
                    });
            },

            renderImportList: function (events) {
                var list = getEl('calendar-picker-list');
                if (!events || events.length === 0) {
                    list.innerHTML = '<div class="text-center text-xs text-base-content/40 py-6">ไม่พบรายการแข่งขัน</div>';
                    return;
                }

                var html = '';
                events.forEach(function (evt) {
                    var evtJson = encodeURIComponent(JSON.stringify(evt));
                    var isPrev = evt.isPreviousDay;
                    var timeBadgeClass = isPrev ? 'badge-error text-white border-none' : 'badge-neutral';
                    var timeLabel = evt.time + (isPrev ? '<span class="ml-1 text-[9px] opacity-90 font-normal">(ข้ามวัน)</span>' : '');

                    html += '<div onclick="Dashboard.selectImportEvent(\'' + evtJson + '\')" class="p-2 bg-white hover:bg-primary/5 border border-base-200 rounded-lg cursor-pointer transition-all hover:shadow-sm group mb-1"><div class="flex items-center gap-3"><div class="badge ' + timeBadgeClass + ' font-mono font-bold h-6 whitespace-nowrap">' + timeLabel + '</div><div class="flex-1 min-w-0"><div class="text-[10px] font-bold text-primary/70 uppercase tracking-wider truncate">' + (evt.league || 'Unknown') + '</div><div class="text-sm font-bold text-base-content/80 truncate group-hover:text-primary transition-colors">' + evt.home + ' <span class="text-xs text-base-content/40 font-normal px-1">vs</span> ' + evt.away + '</div></div><i class="fas fa-plus-circle text-base-content/10 group-hover:text-primary text-xl transition-colors"></i></div></div>';
                });
                list.innerHTML = html;
            },

            selectImportEvent: function (evtEncoded) {
                try {
                    var evt = JSON.parse(decodeURIComponent(evtEncoded));
                    getEl('input-time').value = evt.time;
                    getEl('input-league').value = evt.league;
                    getEl('input-home').value = evt.home;
                    getEl('input-away').value = evt.away;
                    getEl('input-channel').value = evt.channel || 'N/A';

                    if (importDate) getEl('input-date').value = importDate;

                    // this.toggleCalendar(); // Removed
                    showToastInModal("นำเข้าข้อมูลเรียบร้อย", "success", "modal-add-work");
                    this.checkFormInput();
                } catch (e) { console.error(e); }
            },

            checkFormInput: function () {
                var home = getEl('input-home').value.trim();
                var away = getEl('input-away').value.trim();
                var sectionStart = getEl('section-img-start');

                if (!sectionStart) return;

                if (this._editMode === 'new') {
                    if (home && away) {
                        sectionStart.classList.remove('hidden');
                    } else {
                        sectionStart.classList.add('hidden');
                    }
                }
            },

            checkUploadState: function () {
                // 1. Determine State
                var hasStartDb = !getEl('wrapper-preview-start').classList.contains('hidden') && !getEl('preview-start-img').src.endsWith('undefined');
                var hasStartNew = !!_currentBlobs['start'];
                var hasStart = hasStartDb || hasStartNew;

                var hasStopDb = !getEl('wrapper-preview-stop').classList.contains('hidden') && !getEl('preview-stop-img').src.endsWith('undefined');
                var hasStopNew = !!_currentBlobs['stop'];
                // Stop considered present if DB has it OR new upload exists
                var hasStop = hasStopDb || hasStopNew;

                // Elements
                var startUpload = getEl('box-upload-start');
                var startSection = getEl('section-img-start');
                var stopSection = getEl('section-img-stop');
                var stopUpload = getEl('box-upload-stop');
                var btnSubmit = getEl('btn-submit-start');

                // 2. Mode-Based Visibility Control (The "Macro" View)
                if (this._editMode === 'new') {
                    // Start Section: Controlled by checkFormInput (called separately or via event)
                    this.checkFormInput();
                    // Stop Section: Always Hidden
                    if (stopSection) stopSection.classList.add('hidden');
                    // Submit: Always Visible
                    if (btnSubmit) btnSubmit.classList.remove('hidden');

                } else if (this._editMode === 'start') {
                    // Start Section: Always Visible
                    if (startSection) startSection.classList.remove('hidden');
                    // Stop Section: Always Hidden
                    if (stopSection) stopSection.classList.add('hidden');
                    // Submit: Always Visible
                    if (btnSubmit) btnSubmit.classList.remove('hidden');

                } else if (this._editMode === 'stop') {
                    // Start Section: Always Hidden
                    if (startSection) startSection.classList.add('hidden');
                    // Stop Section: Always Visible
                    if (stopSection) stopSection.classList.remove('hidden');
                    // Submit: Always Visible
                    if (btnSubmit) btnSubmit.classList.remove('hidden');

                } else { // 'all' (Regular Edit)
                    // Start Section: Always Visible
                    if (startSection) startSection.classList.remove('hidden');
                    // Stop Section: Always Visible
                    if (stopSection) stopSection.classList.remove('hidden');
                    // Submit: Always Visible
                    if (btnSubmit) btnSubmit.classList.remove('hidden');
                }

                // 3. Upload Box vs Preview Control (The "Micro" View)
                // If image exists (DB or New), hide upload button, show preview wrapper (handled in setPreview/openModal)
                // Here we just ensure upload box is hidden if image exists

                if (hasStart) {
                    if (startUpload) startUpload.classList.add('hidden');
                } else {
                    if (startUpload) startUpload.classList.remove('hidden');
                }

                if (hasStop) {
                    if (stopUpload) stopUpload.classList.add('hidden');
                } else {
                    if (stopUpload) stopUpload.classList.remove('hidden');
                }
            },

            clearImage: function (mode) {
                _currentBlobs[mode] = null;
                if (mode === 'start') getEl('input-start-img').value = '';
                if (mode === 'stop') getEl('inp-file-stop').value = '';
                if (mode === 'stop-quick') getEl('inp-file-stop-quick').value = '';

                var wrapperId = mode === 'stop-quick' ? 'wrapper-preview-stop-quick' : 'wrapper-preview-' + mode;
                var w = getEl(wrapperId);
                if (w) w.classList.add('hidden');

                var imgId = mode === 'stop-quick' ? 'preview-stop-quick-img' : 'preview-' + mode + '-img';
                var img = getEl(imgId);
                if (img) img.src = '';

                this.checkUploadState();
            },

            setPreview: function (mode, blob) {
                var url = URL.createObjectURL(blob);
                var wrapperId = mode === 'stop-quick' ? 'wrapper-preview-stop-quick' : 'wrapper-preview-' + mode;
                var imgId = mode === 'stop-quick' ? 'preview-stop-quick-img' : 'preview-' + mode + '-img';
                var wrapper = getEl(wrapperId);
                var img = getEl(imgId);

                if (img) img.src = url;
                if (wrapper) wrapper.classList.remove('hidden');
                _currentBlobs[mode] = blob;

                this.checkUploadState();
            },

            handleFileSelect: function (input, mode) {
                if (input.files && input.files[0]) this.setPreview(mode, input.files[0]);
            },

            viewImage: function (url) {
                if (!url) return;
                getEl('img-preview-target').src = formatDriveUrl(url);
                getEl('modal-view-image').showModal();
            }
        };
    })();

    document.addEventListener('DOMContentLoaded', function () {
        Dashboard.init();
    });
</script>