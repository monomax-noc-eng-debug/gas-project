<script>
    /**
     * Ticket Module (Vanilla JS Refactor)
     * Handles Ticket CRUD and Dynamic Config without Alpine.js
     */
    const TicketManager = (() => {
        // --- State ---
        let _tickets = [];
        let _config = { types: [], severities: [], statuses: [], categories: {} };
        let _isLoading = false;

        // --- HTML Elements ---
        const getEl = (id) => document.getElementById(id);

        // --- Public Methods ---
        return {
            // Called once on DOMContentLoaded
            init: function () {
                console.log("ðŸš€ Ticket Manager Initialized");
                this.loadConfig();
            },

            // âœ… Called automatically by Router when page-ticket is shown
            onShow: function () {
                this.loadTickets();
            },

            loadConfig: function () {
                Server.call({ func: 'getTicketConfig', silent: true })
                    .then(res => {
                        if (res.success) {
                            _config = res.data || _config;
                            // Normalize
                            _config.types = _config.types || [];
                            _config.severities = _config.severities || [];
                            _config.statuses = _config.statuses || [];
                            _config.categories = _config.categories || {};
                        }
                    })
                    .catch(err => console.error("Config Load Error", err));
            },

            loadTickets: function (force = false) {
                const loader = getEl('ticket-loader');
                const empty = getEl('ticket-empty');
                const tbody = getEl('ticket-table-body');

                if (!loader || !tbody) return;

                // UI: Loading
                loader.classList.remove('hidden');
                empty.classList.add('hidden');
                tbody.innerHTML = '';

                const apiCall = force ? 'getTickets' : { func: 'getTickets', silent: true };

                Server.call(apiCall)
                    .then(res => {
                        if (res.success) {
                            _tickets = res.data || [];
                            this.renderTable(_tickets);
                            this.updateStats(_tickets);
                        } else {
                            UIManager.showToast("Load Failed: " + res.message, "error");
                        }
                    })
                    .catch(err => {
                        console.error(err);
                        UIManager.showToast("Connection Error", "error");
                    })
                    .finally(() => {
                        loader.classList.add('hidden');
                    });
            },

            filterData: function () {
                const search = getEl('ticket-search').value.toLowerCase();

                const filtered = _tickets.filter(t => {
                    const id = String(t[2] || '').toLowerCase(); // ID at index 2
                    const subj = String(t[8] || '').toLowerCase(); // Subject at index 8
                    const type = String(t[3] || '').toLowerCase(); // Type at index 3
                    const status = String(t[4] || '').toLowerCase(); // Status at index 4

                    return !search || id.includes(search) || subj.includes(search) || type.includes(search) || status.includes(search);
                });

                this.renderTable(filtered);
            },

            renderTable: function (data) {
                const tbody = getEl('ticket-table-body');
                const empty = getEl('ticket-empty');

                if (!data || data.length === 0) {
                    empty.classList.remove('hidden');
                    tbody.innerHTML = '';
                    return;
                }
                empty.classList.add('hidden');

                const html = data.map((row, i) => this.renderRow(row, i)).join('');
                tbody.innerHTML = html;
            },

            renderRow: function (row, index) {
                const id = row[2];
                const date = dayjs(row[1]).format('DD/MM/YY');
                const type = row[3] || '';
                const status = row[4] || '';
                const severity = row[5] || 'Normal';
                const subject = row[8] || '(No Subject)';

                // Jira-style status lozenge class
                const statusLower = status.toLowerCase();
                let lozengeClass = 'default';
                if (statusLower.includes('open')) lozengeClass = 'open';
                else if (statusLower.includes('pending') || statusLower.includes('wait')) lozengeClass = 'pending';
                else if (statusLower.includes('resolved') || statusLower.includes('fix')) lozengeClass = 'resolved';
                else if (statusLower.includes('close')) lozengeClass = 'closed';

                // Severity dot class
                const sevLower = severity.toLowerCase();
                let sevDotClass = 'normal';
                if (sevLower.includes('critical')) sevDotClass = 'critical';
                else if (sevLower.includes('high')) sevDotClass = 'high';
                else if (sevLower.includes('medium')) sevDotClass = 'medium';
                else if (sevLower.includes('low')) sevDotClass = 'low';

                // Type badge
                const typeLower = type.toLowerCase();
                const typeIcon = typeLower.includes('incident') ? 'fas fa-bolt' : 'fas fa-arrow-up';
                const typeColorClass = typeLower.includes('incident') ? 'incident' : 'request';

                return `
                <tr class="ticket-row border-b border-gray-100">
                    <td class="text-center text-gray-300 font-mono text-[10px] px-3">${index + 1}</td>
                    <td class="px-3">
                        <span class="ticket-id-link text-[11px] cursor-pointer" onclick="TicketManager.openModal('EDIT', '${id}')">${id}</span>
                    </td>
                    <td class="px-3">
                        <div class="font-medium text-xs text-gray-800 line-clamp-1 block" title="${subject}">${subject}</div>
                    </td>
                    <td class="text-center px-2">
                        <span class="type-badge ${typeColorClass}">
                            <i class="${typeIcon} text-[9px]"></i> ${type}
                        </span>
                    </td>
                    <td class="text-center px-2">
                        <div class="flex items-center justify-center gap-1.5">
                            <span class="severity-dot ${sevDotClass}"></span>
                            <span class="text-[10px] text-gray-500">${severity}</span>
                        </div>
                    </td>
                    <td class="text-center px-2">
                        <span class="status-lozenge ${lozengeClass}">${status}</span>
                    </td>
                    <td class="text-center text-[10px] text-gray-400 font-mono px-2">${date}</td>
                    <td class="text-center px-2">
                        <div class="flex items-center justify-center gap-0.5">
                            <button onclick="event.stopPropagation(); TicketManager.openModal('EDIT', '${id}')"
                                class="btn btn-ghost btn-xs btn-square text-gray-400 hover:text-indigo-600 hover:bg-indigo-50 rounded-md"
                                title="Edit">
                                <i class="fas fa-pen text-[10px]"></i>
                            </button>
                            <button onclick="event.stopPropagation(); TicketManager.deleteTicket('${id}')"
                                class="btn btn-ghost btn-xs btn-square text-gray-400 hover:text-red-500 hover:bg-red-50 rounded-md"
                                title="Delete">
                                <i class="fas fa-trash text-[10px]"></i>
                            </button>
                        </div>
                    </td>
                </tr>
            `;
            },

            updateStats: function (data) {
                let s = { total: 0, open: 0, pending: 0, resolved: 0, closed: 0, incident: 0, request: 0 };
                data.forEach(r => {
                    s.total++;
                    const st = String(r[4] || '').toLowerCase();
                    const ty = String(r[3] || '').toLowerCase();

                    if (st.includes('open')) s.open++;
                    else if (st.includes('pending') || st.includes('wait')) s.pending++;
                    else if (st.includes('resolved') || st.includes('fix')) s.resolved++;
                    else if (st.includes('close')) s.closed++;

                    if (ty.includes('incident')) s.incident++;
                    else if (ty.includes('request')) s.request++;
                });

                getEl('stat-total').innerText = s.total;
                getEl('stat-open').innerText = s.open;
                getEl('stat-pending').innerText = s.pending;
                getEl('stat-resolved').innerText = s.resolved;
                getEl('stat-closed').innerText = s.closed;
                getEl('stat-incident').innerText = s.incident;
                getEl('stat-request').innerText = s.request;
            },

            // --- Modal & Form ---

            openModal: function (mode, id = null) {
                const modal = getEl('modal-ticket-form');
                const title = getEl('ticket-modal-title');
                const form = getEl('form-ticket');

                // Populate Dropdowns first
                this.populateDropdowns();

                if (mode === 'CREATE') {
                    title.innerText = 'à¸ªà¸£à¹‰à¸²à¸‡ Ticket à¹ƒà¸«à¸¡à¹ˆ';
                    form.reset();
                    getEl('inp-ticket-id').value = '';

                    // Defaults
                    const today = new Date();
                    getEl('inp-ticket-date').value = dayjs().format('YYYY-MM-DD');
                    getEl('inp-ticket-time').value = dayjs().format('HH:mm');
                    getEl('sel-ticket-status').value = 'Open';

                } else {
                    title.innerText = 'à¹à¸à¹‰à¹„à¸‚ Ticket: ' + id;
                    const row = _tickets.find(r => r[2] == id);
                    if (row) this.fillForm(row);
                }

                modal.showModal();
            },

            fillForm: function (row) {
                // row: [timestamp, dateFull, id, type, status, severity, cat, sub, subj, detail, action, res, resp, assign, remark]
                getEl('inp-ticket-id').value = row[2];

                // Split Date/Time
                const dt = row[1].split(' ');
                getEl('inp-ticket-date').value = dt[0] || '';
                getEl('inp-ticket-time').value = dt[1] || '';

                getEl('sel-ticket-type').value = row[3];
                getEl('sel-ticket-status').value = row[4];
                getEl('sel-ticket-severity').value = row[5];

                getEl('sel-ticket-category').value = row[6];
                this.updateSubCategories(); // Refresh subs based on cat
                getEl('sel-ticket-subcategory').value = row[7];

                getEl('inp-ticket-subject').value = row[8];
                getEl('txt-ticket-detail').value = row[9];
                getEl('txt-ticket-action').value = row[10];
                getEl('txt-ticket-resolved').value = row[11];
                getEl('inp-ticket-resp').value = row[12];
                getEl('inp-ticket-assign').value = row[13];
                getEl('txt-ticket-remark').value = row[14];
            },

            populateDropdowns: function () {
                const fill = (id, items) => {
                    const el = getEl(id);
                    const cur = el.value;
                    el.innerHTML = items.map(i => `<option value="${i}">${i}</option>`).join('');
                    if (cur && items.includes(cur)) el.value = cur;
                };

                fill('sel-ticket-type', _config.types);
                fill('sel-ticket-status', _config.statuses);
                fill('sel-ticket-severity', _config.severities);

                // Categories
                const cats = Object.keys(_config.categories);
                const catEl = getEl('sel-ticket-category');
                const curCat = catEl.value;
                catEl.innerHTML = '<option value="">Select Category...</option>' + cats.map(c => `<option value="${c}">${c}</option>`).join('');
                if (curCat && cats.includes(curCat)) catEl.value = curCat;
            },

            updateSubCategories: function () {
                const cat = getEl('sel-ticket-category').value;
                const subEl = getEl('sel-ticket-subcategory');
                subEl.innerHTML = '';

                if (cat && _config.categories[cat]) {
                    const subs = _config.categories[cat];
                    subEl.innerHTML = subs.map(s => `<option value="${s}">${s}</option>`).join('');
                }
            },

            handleSubmit: function (event) {
                event.preventDefault();
                const form = event.target;
                const btn = getEl('btn-save-ticket');
                const spinner = getEl('spinner-save-ticket');

                btn.disabled = true;
                spinner.classList.remove('hidden');

                const formData = new FormData(form);
                const id = formData.get('id');
                const data = Object.fromEntries(formData.entries());

                const func = id ? 'updateTicket' : 'createTicket';

                Server.call(func, data)
                    .then(res => {
                        if (res.success) {
                            UIManager.showToast("à¸šà¸±à¸™à¸—à¸¶à¸à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸ªà¸³à¹€à¸£à¹‡à¸ˆ", "success");
                            getEl('modal-ticket-form').close();
                            this.loadTickets(true); // Refund
                        } else {
                            Swal.fire('Error', res.message, 'error');
                        }
                    })
                    .catch(err => Swal.fire('Error', err.message, 'error'))
                    .finally(() => {
                        btn.disabled = false;
                        spinner.classList.add('hidden');
                    });
            },

            deleteTicket: function (id) {
                Swal.fire({
                    title: 'à¸¢à¸·à¸™à¸¢à¸±à¸™à¸à¸²à¸£à¸¥à¸š?',
                    text: `à¸„à¸¸à¸“à¸•à¹‰à¸­à¸‡à¸à¸²à¸£à¸¥à¸š Ticket ${id} à¸«à¸£à¸·à¸­à¹„à¸¡à¹ˆ?`,
                    icon: 'warning',
                    showCancelButton: true,
                    confirmButtonColor: '#d33',
                    confirmButtonText: 'à¸¥à¸šà¸£à¸²à¸¢à¸à¸²à¸£'
                }).then((result) => {
                    if (result.isConfirmed) {
                        Server.call('deleteTicket', id)
                            .then(res => {
                                if (res.success) {
                                    Swal.fire('Deleted!', 'à¸¥à¸šà¸£à¸²à¸¢à¸à¸²à¸£à¸ªà¸³à¹€à¸£à¹‡à¸ˆ', 'success');
                                    this.loadTickets(true);
                                } else {
                                    Swal.fire('Error', res.message, 'error');
                                }
                            });
                    }
                });
            },

            // --- Helpers ---
            getStatusClass: function (s) {
                s = (s || '').toLowerCase();
                if (s.includes('open')) return 'badge-error';
                if (s.includes('pending')) return 'badge-warning';
                if (s.includes('resolved')) return 'badge-success';
                if (s.includes('closed')) return 'badge-neutral';
                return 'badge-ghost';
            },

            getSeverityClass: function (s) {
                s = (s || '').toLowerCase();
                if (s.includes('critical')) return 'badge-error';
                if (s.includes('high')) return 'badge-warning';
                if (s.includes('medium')) return 'badge-info';
                return 'badge-ghost';
            }

        };
    })();

    // Register with Router for lifecycle hooks
    document.addEventListener('DOMContentLoaded', () => {
        Router.register('page-ticket', TicketManager);
        TicketManager.init();
    });
</script>