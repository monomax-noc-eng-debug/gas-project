<script>
    /**
     * Ticket Module (Full Optimized)
     * Features: CRUD, Config Loading, Stats, Expanded Table UI
     */
    const TicketManager = (() => {
        // --- State ---
        let _tickets = [];
        let _config = { types: [], severities: [], statuses: [], categories: {} };
        let _isLoading = false;

        // --- HTML Elements ---
        const getEl = (id) => document.getElementById(id);

        return {
            init: function () {
                console.log("ðŸš€ Ticket Manager Initialized");
                this.loadConfig();
            },

            onShow: function () {
                this.loadTickets();
            },

            loadConfig: function () {
                Server.call({ func: 'getTicketConfig', silent: true })
                    .then(res => {
                        if (res.success) {
                            _config = res.data || _config;
                            _config.types = _config.types || [];
                            _config.severities = _config.severities || [];
                            _config.statuses = _config.statuses || [];
                            _config.categories = _config.categories || {};
                        }
                    })
                    .catch(err => console.error("Config Load Error", err));
            },

            loadTickets: function (force = false) {
                const loader = getEl('ticket-loader');
                const empty = getEl('ticket-empty');
                const tbody = getEl('ticket-table-body');

                if (!loader || !tbody) return;

                loader.classList.remove('hidden');
                empty.classList.add('hidden');
                tbody.innerHTML = '';

                const apiCall = force ? 'getTickets' : { func: 'getTickets', silent: true };

                Server.call(apiCall)
                    .then(res => {
                        if (res.success) {
                            _tickets = res.data || [];
                            this.renderTable(_tickets);
                            this.updateStats(_tickets);
                        } else {
                            UIManager.showToast("Load Failed: " + res.message, "error");
                        }
                    })
                    .catch(err => {
                        console.error(err);
                        UIManager.showToast("Connection Error", "error");
                    })
                    .finally(() => {
                        loader.classList.add('hidden');
                    });
            },

            filterData: function () {
                const search = getEl('ticket-search').value.toLowerCase();
                const filtered = _tickets.filter(t => {
                    const id = String(t[2] || '').toLowerCase(); 
                    const subj = String(t[8] || '').toLowerCase(); 
                    const type = String(t[3] || '').toLowerCase(); 
                    const status = String(t[4] || '').toLowerCase(); 
                    return !search || id.includes(search) || subj.includes(search) || type.includes(search) || status.includes(search);
                });
                this.renderTable(filtered);
            },

            renderTable: function (data) {
                const tbody = getEl('ticket-table-body');
                const empty = getEl('ticket-empty');

                if (!data || data.length === 0) {
                    empty.classList.remove('hidden');
                    tbody.innerHTML = '';
                    return;
                }
                empty.classList.add('hidden');

                const html = data.map((row, i) => this.renderRow(row, i)).join('');
                tbody.innerHTML = html;
            },

            renderRow: function (row, index) {
                const id = row[2];
                const date = dayjs(row[1]).format('DD/MM/YYYY');
                const type = row[3] || '';
                const status = row[4] || '';
                const severity = row[5] || 'Normal';
                const subject = row[8] || '(No Subject)';
                const category = row[6] || '-';
                const assignee = row[13] || 'Unassigned';

                // Status Badge Logic
                const statusLower = status.toLowerCase();
                let badgeClass = 'badge-ghost';
                if (statusLower.includes('open')) badgeClass = 'badge-error badge-outline';
                else if (statusLower.includes('pending') || statusLower.includes('wait')) badgeClass = 'badge-warning badge-outline';
                else if (statusLower.includes('resolved') || statusLower.includes('fix')) badgeClass = 'badge-success text-white border-none';
                else if (statusLower.includes('close')) badgeClass = 'badge-neutral text-white';

                // Severity Dot Logic
                const sevLower = severity.toLowerCase();
                let sevColor = 'bg-gray-300';
                if (sevLower.includes('critical')) sevColor = 'bg-red-500 animate-pulse';
                else if (sevLower.includes('high')) sevColor = 'bg-orange-500';
                else if (sevLower.includes('medium')) sevColor = 'bg-blue-500';

                // Assignee Avatar Initial
                const assignInitial = assignee.charAt(0).toUpperCase();

                // âœ… Expanded Row + Single Line (whitespace-nowrap) + Padding (py-4)
                return `
                <tr class="hover:bg-base-50 transition-colors group cursor-pointer border-b border-gray-100 last:border-none" 
                    onclick="TicketManager.openModal('EDIT', '${id}')">
                    
                    <td class="text-center font-medium text-gray-400 whitespace-nowrap py-4">${index + 1}</td>
                    
                    <td class="whitespace-nowrap py-4">
                        <span class="font-mono font-bold text-primary group-hover:underline">${id}</span>
                    </td>

                    <td class="whitespace-nowrap py-4 text-gray-500 font-mono text-xs">
                        ${date}
                    </td>
                    
                    <td class="whitespace-nowrap py-4">
                        <div class="font-bold text-gray-700 max-w-xs truncate" title="${subject}">${subject}</div>
                    </td>
                    
                    <td class="text-center whitespace-nowrap py-4 text-xs text-gray-600">
                        ${type}
                    </td>

                    <td class="text-center whitespace-nowrap py-4">
                        <div class="flex items-center justify-center gap-2">
                            <div class="w-2 h-2 rounded-full ${sevColor}"></div>
                            <span class="text-xs text-gray-500">${severity}</span>
                        </div>
                    </td>
                    
                    <td class="text-center whitespace-nowrap py-4">
                        <span class="badge ${badgeClass} badge-sm font-bold uppercase tracking-wider h-6 px-3">
                            ${status}
                        </span>
                    </td>

                    <td class="whitespace-nowrap py-4 text-gray-500 text-xs">
                        ${category}
                    </td>

                    <td class="whitespace-nowrap py-4">
                        <div class="flex items-center gap-2">
                            <div class="avatar placeholder">
                                <div class="bg-neutral-focus text-neutral-content rounded-full w-6 h-6 bg-gray-200 text-gray-600">
                                    <span class="text-[10px] font-bold">${assignInitial}</span>
                                </div>
                            </div>
                            <span class="text-xs text-gray-600 truncate max-w-[100px]">${assignee}</span>
                        </div>
                    </td>
                    
                    <td class="text-center whitespace-nowrap py-4 pr-4">
                        <button onclick="event.stopPropagation(); TicketManager.deleteTicket('${id}')"
                            class="btn btn-ghost btn-xs btn-square text-gray-300 hover:text-red-500 hover:bg-red-50 rounded-lg transition-all opacity-0 group-hover:opacity-100">
                            <i class="fas fa-trash-alt"></i>
                        </button>
                    </td>
                </tr>
            `;
            },

            updateStats: function (data) {
                let s = { total: 0, open: 0, pending: 0, resolved: 0, closed: 0, incident: 0, request: 0 };
                data.forEach(r => {
                    s.total++;
                    const st = String(r[4] || '').toLowerCase();
                    const ty = String(r[3] || '').toLowerCase();

                    if (st.includes('open')) s.open++;
                    else if (st.includes('pending') || st.includes('wait')) s.pending++;
                    else if (st.includes('resolved') || st.includes('fix')) s.resolved++;
                    else if (st.includes('close')) s.closed++;

                    if (ty.includes('incident')) s.incident++;
                    else if (ty.includes('request')) s.request++;
                });

                const setTxt = (id, val) => { const el = getEl(id); if (el) el.innerText = val; };
                setTxt('stat-total', s.total);
                setTxt('stat-open', s.open);
                setTxt('stat-pending', s.pending);
                setTxt('stat-resolved', s.resolved);
                setTxt('stat-closed', s.closed);
                setTxt('stat-incident', s.incident);
                setTxt('stat-request', s.request);
            },

            // --- Modal & Form ---

            openModal: function (mode, id = null) {
                const modal = getEl('modal-ticket-form');
                const title = getEl('ticket-modal-title');
                const form = getEl('form-ticket');

                this.populateDropdowns();

                if (mode === 'CREATE') {
                    title.innerText = 'à¸ªà¸£à¹‰à¸²à¸‡ Ticket à¹ƒà¸«à¸¡à¹ˆ';
                    form.reset();
                    getEl('inp-ticket-id').value = '';
                    getEl('inp-ticket-date').value = dayjs().format('YYYY-MM-DD');
                    getEl('inp-ticket-time').value = dayjs().format('HH:mm');
                    getEl('sel-ticket-status').value = 'Open';
                } else {
                    title.innerText = 'à¹à¸à¹‰à¹„à¸‚ Ticket: ' + id;
                    const row = _tickets.find(r => r[2] == id);
                    if (row) this.fillForm(row);
                }
                modal.showModal();
            },

            fillForm: function (row) {
                getEl('inp-ticket-id').value = row[2];
                const dt = row[1].split(' ');
                getEl('inp-ticket-date').value = dt[0] || '';
                getEl('inp-ticket-time').value = dt[1] || '';
                getEl('sel-ticket-type').value = row[3];
                getEl('sel-ticket-status').value = row[4];
                getEl('sel-ticket-severity').value = row[5];
                getEl('sel-ticket-category').value = row[6];
                this.updateSubCategories();
                getEl('sel-ticket-subcategory').value = row[7];
                getEl('inp-ticket-subject').value = row[8];
                getEl('txt-ticket-detail').value = row[9];
                getEl('txt-ticket-action').value = row[10];
                getEl('txt-ticket-resolved').value = row[11];
                getEl('inp-ticket-resp').value = row[12];
                getEl('inp-ticket-assign').value = row[13];
                getEl('txt-ticket-remark').value = row[14];
            },

            populateDropdowns: function () {
                const fill = (id, items) => {
                    const el = getEl(id);
                    const cur = el.value;
                    el.innerHTML = items.map(i => `<option value="${i}">${i}</option>`).join('');
                    if (cur && items.includes(cur)) el.value = cur;
                };
                fill('sel-ticket-type', _config.types);
                fill('sel-ticket-status', _config.statuses);
                fill('sel-ticket-severity', _config.severities);
                
                const cats = Object.keys(_config.categories);
                const catEl = getEl('sel-ticket-category');
                const curCat = catEl.value;
                catEl.innerHTML = '<option value="">Select...</option>' + cats.map(c => `<option value="${c}">${c}</option>`).join('');
                if (curCat && cats.includes(curCat)) catEl.value = curCat;
            },

            updateSubCategories: function () {
                const cat = getEl('sel-ticket-category').value;
                const subEl = getEl('sel-ticket-subcategory');
                subEl.innerHTML = '';
                if (cat && _config.categories[cat]) {
                    subEl.innerHTML = _config.categories[cat].map(s => `<option value="${s}">${s}</option>`).join('');
                }
            },

            handleSubmit: function (event) {
                event.preventDefault();
                const form = event.target;
                const btn = getEl('btn-save-ticket');
                const spinner = getEl('spinner-save-ticket');

                btn.disabled = true;
                spinner.classList.remove('hidden');

                const formData = new FormData(form);
                const id = formData.get('id');
                const data = Object.fromEntries(formData.entries());
                const func = id ? 'updateTicket' : 'createTicket';

                Server.call(func, data)
                    .then(res => {
                        if (res.success) {
                            UIManager.showToast("à¸šà¸±à¸™à¸—à¸¶à¸à¸ªà¸³à¹€à¸£à¹‡à¸ˆ", "success");
                            getEl('modal-ticket-form').close();
                            this.loadTickets(true);
                        } else {
                            UIManager.showToast(res.message, "error");
                        }
                    })
                    .catch(err => UIManager.showToast(err.message, "error"))
                    .finally(() => {
                        btn.disabled = false;
                        spinner.classList.add('hidden');
                    });
            },

            deleteTicket: function (id) {
                if(confirm(`à¸•à¹‰à¸­à¸‡à¸à¸²à¸£à¸¥à¸š Ticket ${id} à¸«à¸£à¸·à¸­à¹„à¸¡à¹ˆ?`)) {
                    Server.call('deleteTicket', id).then(res => {
                        if (res.success) {
                            UIManager.showToast("à¸¥à¸šà¸£à¸²à¸¢à¸à¸²à¸£à¸ªà¸³à¹€à¸£à¹‡à¸ˆ", "success");
                            this.loadTickets(true);
                        } else {
                            UIManager.showToast(res.message, "error");
                        }
                    });
                }
            }
        };
    })();

    document.addEventListener('DOMContentLoaded', () => {
        Router.register('page-ticket', TicketManager);
        TicketManager.init();
    });
</script>