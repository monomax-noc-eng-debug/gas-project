<script>
  // ----------------------------------------------------------------------
  // 1. ROUTER: Page Switching with Lifecycle Hooks
  // ----------------------------------------------------------------------
  const Router = {
    activePage: null,
    _controllers: {},   // Registry: { 'page-dashboard': { onShow, onHide } }
    _previousPage: null,

    /**
     * Register a Page Controller
     * @param {string} pageId - ID of the page element (e.g., 'page-history')
     * @param {object} controller - Object with optional onShow() and onHide() methods
     */
    register: function (pageId, controller) {
      this._controllers[pageId] = controller;
      console.log('üìå Router: Registered controller for', pageId);
    },

    /**
     * Navigate to a page
     * @param {string} pageId - ID of the target page element
     */
    navigateTo: function (pageId) {
      // 1. Validate target exists
      var target = document.getElementById(pageId);
      if (!target) {
        console.warn('‚ö†Ô∏è Router: Page not found -', pageId);
        return;
      }

      // 2. Skip if already on this page
      if (this.activePage === pageId) return;

      // 3. Call onHide() on the previous page controller
      this._previousPage = this.activePage;
      if (this._previousPage && this._controllers[this._previousPage]) {
        var prevCtrl = this._controllers[this._previousPage];
        if (typeof prevCtrl.onHide === 'function') {
          try { prevCtrl.onHide(); } catch (e) { console.error('Router: onHide error for', this._previousPage, e); }
        }
      }

      // 4. Hide all pages
      var sections = document.querySelectorAll('.page-section');
      for (var i = 0; i < sections.length; i++) {
        sections[i].classList.add('hidden');
        sections[i].classList.remove('fade-in');
      }

      // 5. Show target page with animation
      target.classList.remove('hidden');
      target.classList.add('fade-in');
      this.activePage = pageId;

      // 6. Update Sidebar active state
      var links = document.querySelectorAll('aside a[data-target]');
      for (var i = 0; i < links.length; i++) {
        var link = links[i];
        link.classList.remove('active', 'bg-primary', 'text-white');
        if (link.dataset.target === pageId) {
          link.classList.add('active', 'bg-primary', 'text-white');
          // Update Header Title
          var titleEl = document.getElementById('header-title');
          if (titleEl) titleEl.innerText = link.innerText.trim();
        }
      }

      // 7. Call onShow() on the new page controller
      if (this._controllers[pageId]) {
        var ctrl = this._controllers[pageId];
        if (typeof ctrl.onShow === 'function') {
          try { ctrl.onShow(); } catch (e) { console.error('Router: onShow error for', pageId, e); }
        }
      }

      // 8. Dispatch event for backward compatibility (existing listeners)
      setTimeout(function () {
        document.dispatchEvent(new CustomEvent('page-change', { detail: { pageId: pageId } }));
      }, 50);
    }
  };

  /** Global helper function */
  function changePage(pageId) {
    Router.navigateTo(pageId);
  }

  // ----------------------------------------------------------------------
  // 2. SERVER (Routes { func } calls through apiHandler)
  // ----------------------------------------------------------------------
  const Server = {
    call: function (target) {
      var args = Array.prototype.slice.call(arguments, 1);
      return new Promise(function (resolve, reject) {
        if (typeof google === 'undefined' || !google.script) {
          console.error("Local Dev Mode: Google Script not found");
          reject(new Error("Local Dev Mode"));
          return;
        }

        var funcName = target;
        var options = { silent: false, loadingMsg: null };
        var useApiHandler = false;

        if (typeof target === 'object' && target !== null) {
          funcName = target.func;
          if (target.silent) options.silent = true;
          if (target.loadingMsg) options.loadingMsg = target.loadingMsg;
          useApiHandler = true; // Object-style ‚Üí route through apiHandler
        }

        if (!options.silent) UIManager.showLoading(options.loadingMsg);

        var runner = google.script.run
          .withSuccessHandler(function (res) {
            if (!options.silent) UIManager.hideLoading();
            try {
              var data = typeof res === 'string' ? JSON.parse(res) : res;
              resolve(data);
            } catch (e) { resolve(res); }
          })
          .withFailureHandler(function (err) {
            if (!options.silent) UIManager.hideLoading();
            console.error("Server Error:", err);
            if (typeof UIManager !== 'undefined') UIManager.showToast(err.message, "error");
            reject(err);
          });

        if (useApiHandler) {
          // ‚úÖ Route through apiHandler (centralized backend router)
          runner.apiHandler({ func: funcName, data: args[0] });
        } else {
          // Legacy: direct global function call (e.g., getUserSettings)
          if (typeof runner[funcName] !== 'function') {
            if (!options.silent) UIManager.hideLoading();
            reject(new Error('Function not found: ' + funcName));
            return;
          }
          runner[funcName].apply(runner, args);
        }
      });
    }
  };

  // ----------------------------------------------------------------------
  // 3. UI MANAGER (Fixed: Bottom-Right & High Z-Index)
  // ----------------------------------------------------------------------
  const UIManager = {
    showToast: function (msg, type) {
      type = type || 'info';
      var container = document.getElementById('toast-container');

      if (!container) {
        container = document.createElement('div');
        container.id = 'toast-container';
        document.body.appendChild(container);
      }

      // üî• FIX: ‡πÉ‡∏ä‡πâ DaisyUI Class 'toast-bottom' ‡πÅ‡∏•‡∏∞‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö z-index ‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î
      container.className = 'toast toast-bottom toast-end';
      container.style.zIndex = '2147483647'; // ‡∏Ñ‡πà‡∏≤‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î‡∏Ç‡∏≠‡∏á Integer (‡πÄ‡∏´‡∏ô‡∏∑‡∏≠‡∏ó‡∏∏‡∏Å Modal)
      container.style.position = 'fixed';
      container.style.bottom = '20px';
      container.style.right = '20px';
      container.style.pointerEvents = 'none'; // ‡πÉ‡∏´‡πâ‡∏Ñ‡∏•‡∏¥‡∏Å‡∏ó‡∏∞‡∏•‡∏∏‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏ß‡πà‡∏≤‡∏á‡πÑ‡∏î‡πâ

      var alert = document.createElement('div');
      var extraClass = type === 'error' ? 'alert-error' : type === 'success' ? 'alert-success' : 'alert-info';

      // ‡πÄ‡∏û‡∏¥‡πà‡∏° pointer-events-auto ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏ï‡∏±‡∏ß Toast ‡πÄ‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏Ñ‡∏•‡∏¥‡∏Å‡πÑ‡∏î‡πâ
      alert.className = 'alert ' + extraClass + ' text-white shadow-lg mb-2 min-w-[300px] pointer-events-auto animate-bounce';
      alert.innerHTML = '<span>' + msg + '</span>';
      container.appendChild(alert);

      setTimeout(function () { alert.remove(); }, 3000);
    },

    showLoading: function (msg) {
      if (document.getElementById('global-loading')) return;
      var d = document.createElement('dialog');
      d.id = 'global-loading';
      d.className = 'modal';
      // ‡πÉ‡∏´‡πâ Loading ‡∏≠‡∏¢‡∏π‡πà‡∏£‡∏≠‡∏á‡∏•‡∏á‡∏°‡∏≤‡∏à‡∏≤‡∏Å Toast ‡πÄ‡∏•‡πá‡∏Å‡∏ô‡πâ‡∏≠‡∏¢
      d.style.zIndex = '2147483646';
      d.innerHTML =
        '<div class="modal-box bg-transparent shadow-none flex flex-col items-center justify-center overflow-hidden">' +
        '<span class="loading loading-spinner loading-lg text-primary"></span>' +
        (msg ? '<p class="mt-2 text-white font-bold drop-shadow-md text-sm">' + msg + '</p>' : '') +
        '</div>';
      document.body.appendChild(d);
      d.showModal();
    },

    hideLoading: function () {
      var d = document.getElementById('global-loading');
      if (d) { d.close(); d.remove(); }
    },

    confirm: function (msg) {
      return new Promise(function (resolve) {
        if (typeof Swal !== 'undefined') {
          Swal.fire({
            title: 'Are you sure?',
            text: msg,
            icon: 'warning',
            showCancelButton: true,
            confirmButtonColor: '#d33',
            cancelButtonColor: '#3085d6',
            confirmButtonText: 'Yes',
            didOpen: function () {
              // ‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö SweetAlert ‡πÉ‡∏´‡πâ‡∏≠‡∏¢‡∏π‡πà‡πÄ‡∏´‡∏ô‡∏∑‡∏≠ Modal ‡∏õ‡∏Å‡∏ï‡∏¥
              var container = Swal.getContainer();
              if (container) container.style.zIndex = '100000';
            }
          }).then(function (result) {
            resolve(result.isConfirmed);
          });
        } else {
          var res = confirm(msg);
          resolve(res);
        }
      });
    }
  };

  // ----------------------------------------------------------------------
  // 4. STORE
  // ----------------------------------------------------------------------
  const Store = {
    state: { currentUser: null, settings: {}, isAppLoaded: false },
    init: function () {
      var self = this;
      return Server.call('getUserSettings').then(function (res) {
        self.state.currentUser = res.profile;
        self.state.settings = res;
      });
    }
  };
</script>