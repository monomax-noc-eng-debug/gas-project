<script>
    /**
     * JS_Report.html
     * Version: Final Stable (Fixed Date Format & Logic)
     */
    window.ReportManager = (function () {
        var _files = { mono: [], ais: [], start: [] };
        var _autoStartUrls = [];
        var _isCustomReporter = false;
        var _picker = null;
        var _isLoading = false;

        var el = function (id) { return document.getElementById(id); };
        var show = function (id, visible) { var e = el(id); if (e) e.classList.toggle('hidden', !visible); };

        var formatDriveUrl = function (url) {
            if (!url) return "";
            if (url.startsWith('data:')) return url;
            try {
                var id = null;
                if (url.indexOf('/d/') !== -1) id = url.match(/\/d\/(.+?)(\/|$)/)[1];
                else if (url.indexOf('id=') !== -1) id = url.match(/id=([^&]+)/)[1];
                return id ? 'https://drive.google.com/thumbnail?id=' + id + '&sz=w1000' : url;
            } catch (e) { return url; }
        };

        return {
            init: function () {
                document.addEventListener('page-change', function (e) {
                    if (e.detail.pageId === 'page-report') ReportManager.onPageShow();
                });
            },

            onPageShow: function () {
                if (!_picker) {
                    var input = el('inputDate');
                    if (input) {
                        var today = new Date();
                        var yyyy = today.getFullYear();
                        var mm = String(today.getMonth() + 1).padStart(2, '0');
                        var dd = String(today.getDate()).padStart(2, '0');
                        input.value = `${yyyy}-${mm}-${dd}`;

                        _picker = new Pikaday({
                            field: input,
                            format: 'YYYY-MM-DD',
                            // ‚úÖ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡πà‡∏ß‡∏ô‡∏ô‡∏µ‡πâ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö Format ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÉ‡∏´‡πâ‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á (2026-02-10)
                            toString(date, format) {
                                const day = String(date.getDate()).padStart(2, '0');
                                const month = String(date.getMonth() + 1).padStart(2, '0');
                                const year = date.getFullYear();
                                return `${year}-${month}-${day}`;
                            },
                            yearRange: [2020, 2030],
                            onSelect: function () { if (!_isLoading) ReportManager.autoFetchAll(); }
                        });
                        setTimeout(function () { ReportManager.autoFetchAll(); }, 300);
                    }
                }
            },

            openDatePicker: function () {
                if (_picker) { _picker.show(); }
                else { var input = el('inputDate'); if (input) input.focus(); }
            },

            autoFetchAll: function () {
                if (_isLoading) return;
                var dateVal = el('inputDate').value;
                if (!dateVal) return;

                var self = this;
                self._setLoading(true);

                Promise.all([
                    self.fetchTickets(),
                    self.fetchMatches(),
                    self.fetchStartImages()
                ]).then(function () {
                    if (typeof UIManager !== 'undefined') UIManager.showToast("‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢", "success");
                }).catch(function (err) {
                    console.error("Fetch Error:", err);
                }).finally(function () {
                    self._setLoading(false);
                });
            },

            _setLoading: function (loading) {
                _isLoading = loading;
                var btn = el('btn-load-data');
                var input = el('inputDate');
                if (input) input.disabled = loading;
                if (btn) {
                    btn.disabled = loading;
                    btn.innerHTML = loading ? '<span class="loading loading-spinner"></span>' : '<i class="fas fa-sync-alt"></i> ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•';
                }
            },

            fetchTickets: function () {
                var dateVal = el('inputDate').value;
                show('loader-ticket', true);
                show('empty-ticket', false);
                el('disp-ticket-tbody').innerHTML = '';

                return Server.call({ func: 'getTicketDetails', silent: true }, dateVal)
                    .then(function (res) {
                        if (res && res.success) {
                            // 3-Bucket stats
                            var s = res.stats;
                            var resolvedTotal = (parseInt(s.resolved) || 0) + (parseInt(s.closed) || 0);

                            if (el('disp-ticket-total')) el('disp-ticket-total').innerText = s.total || 0;
                            if (el('disp-ticket-new')) el('disp-ticket-new').innerText = s.new || 0;
                            if (el('disp-ticket-resolved')) el('disp-ticket-resolved').innerText = resolvedTotal;
                            if (el('disp-ticket-backlog')) el('disp-ticket-backlog').innerText = s.backlog || 0;

                            el('ticketSummary').value = res.text;

                            if (res.list && res.list.length > 0) {
                                var html = res.list.map(function (t) {
                                    // Color by tag (bucket)
                                    var badgeClass = 'badge-ghost';
                                    var tagBadge = '';
                                    if (t.tag === 'NEW') {
                                        badgeClass = 'badge-success text-white';
                                        tagBadge = '<span class="badge badge-success badge-xs ml-1 font-bold gap-0.5">üü¢ NEW</span>';
                                    } else if (t.tag === 'RESOLVED') {
                                        badgeClass = 'badge-info text-white';
                                        tagBadge = '<span class="badge badge-info badge-xs ml-1 font-bold gap-0.5">üîµ DONE</span>';
                                    } else if (t.tag === 'BACKLOG') {
                                        badgeClass = 'badge-error text-white';
                                        tagBadge = '<span class="badge badge-error badge-xs ml-1 font-bold gap-0.5">üî¥ ‡∏Ñ‡πâ‡∏≤‡∏á</span>';
                                    }

                                    return `<tr class="border-b border-gray-100 hover:bg-gray-50">
                                            <td class="font-mono font-bold text-center text-[10px] text-gray-500 w-24">${t.id}</td>
                                            <td class="text-center p-1 w-28">
                                                <div class="flex items-center justify-center">
                                                    <span class="badge ${badgeClass} badge-xs font-bold whitespace-nowrap">${t.status}</span>
                                                    ${tagBadge}
                                                </div>
                                            </td>
                                            <td class="p-2">
                                                <div class="text-xs text-gray-700 line-clamp-1 block" title="${t.detail}">${t.detail}</div>
                                            </td>
                                        </tr>`;
                                }).join('');
                                el('disp-ticket-tbody').innerHTML = html;
                            } else { show('empty-ticket', true); }
                        }
                    })
                    .finally(() => show('loader-ticket', false));
            },

            fetchMatches: function () {
                var dateVal = el('inputDate').value;
                show('verify-loader', true);
                el('verification-tbody').innerHTML = '';

                // 1. Get Stats breakdown (API return data: { "Premier League": 2, ... })
                var p1 = Server.call({ func: 'getMatchesByDate', silent: true }, dateVal).then(res => {
                    if (res.success) {
                        // ‚úÖ ‡∏™‡∏£‡πâ‡∏≤‡∏á Format ‡∏™‡∏£‡∏∏‡∏õ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô (‡∏ï‡∏≤‡∏°‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ó‡∏µ‡πà‡∏Ç‡∏≠)
                        var summaryText = "";
                        var breakdownHtml = "";

                        if (res.data) {
                            for (var league in res.data) {
                                // Text for Report/Preview
                                summaryText += `${league}: ${res.data[league]}\n`;
                                // HTML Badge for UI
                                breakdownHtml += `<div class="badge badge-ghost badge-sm text-[10px] gap-1 whitespace-nowrap border-slate-200">
                                    ${league}: <span class="font-bold text-slate-700">${res.data[league]}</span>
                                </div>`;
                            }
                        }

                        // Set value to hidden input for submission
                        el('matchSummary').value = summaryText || "‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÅ‡∏Ç‡πà‡∏á‡∏Ç‡∏±‡∏ô";

                        // Render Badges
                        var bd = el('league-breakdown');
                        if (bd) bd.innerHTML = breakdownHtml;
                    }
                });

                // 2. Get Verification Table
                var p2 = Server.call({ func: 'getVerificationReport', silent: true }, dateVal).then(res => {
                    if (res.success) {
                        el('matchTotalValue').value = res.data.stats.totalMatches;
                        if (el('disp-match-total')) el('disp-match-total').innerText = res.data.stats.totalMatches + " ‡∏Ñ‡∏π‡πà";

                        // ‚úÖ Show date range label
                        var dr = res.data.stats.dateRange;
                        if (dr && el('date-range-label')) {
                            var fmtShort = function (ds) {
                                if (!ds) return '';
                                var parts = ds.split('-');
                                var months = ['‡∏°.‡∏Ñ.', '‡∏Å.‡∏û.', '‡∏°‡∏µ.‡∏Ñ.', '‡πÄ‡∏°.‡∏¢.', '‡∏û.‡∏Ñ.', '‡∏°‡∏¥.‡∏¢.', '‡∏Å.‡∏Ñ.', '‡∏™.‡∏Ñ.', '‡∏Å.‡∏¢.', '‡∏ï.‡∏Ñ.', '‡∏û.‡∏¢.', '‡∏ò.‡∏Ñ.'];
                                return parseInt(parts[2]) + ' ' + months[parseInt(parts[1]) - 1];
                            };
                            el('date-range-label').innerHTML = 'üìÖ ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ä‡πà‡∏ß‡∏á: <b>' + fmtShort(dr.from) + ' 10:00</b> ‚Üí <b>' + fmtShort(dr.to) + ' 10:00</b>';
                        }

                        var list = res.data.list || [];
                        var dateRange = res.data.stats.dateRange || {};

                        // ‚úÖ Calculate Match Ended (Count items with Stop Image)
                        var endedCount = list.filter(item => item.dashboard && item.dashboard.stopImg).length;
                        el('matchEndedValue').value = endedCount;

                        if (list.length === 0) {
                            show('verify-empty', true);
                        } else {
                            show('verify-empty', false);
                            var html = list.map(item => {
                                var db = item.dashboard;
                                var hasEvidence = !!(db.startImg || db.stopImg);
                                var badge = hasEvidence
                                    ? '<div class="w-5 h-5 rounded-full bg-success/10 flex items-center justify-center mx-auto"><i class="fas fa-check text-success text-[10px]"></i></div>'
                                    : '<div class="w-5 h-5 rounded-full bg-base-200 flex items-center justify-center mx-auto"><i class="fas fa-times text-base-content/30 text-[10px]"></i></div>';

                                var imgBtn = (url, icon, color) => url
                                    ? `<a href="${formatDriveUrl(url)}" target="_blank" class="btn btn-xs btn-square btn-ghost text-${color}"><i class="fas ${icon}"></i></a>`
                                    : `<span class="text-gray-300 text-[10px]">-</span>`;

                                // ‚úÖ Date indicator: show which day this match belongs to
                                var dateBadge = '';
                                if (db.date && dateRange.from) {
                                    var isPrevDay = (db.date === dateRange.from);
                                    var fmtDay = function (ds) {
                                        if (!ds) return '';
                                        var p = ds.split('-');
                                        return parseInt(p[2]) + '/' + parseInt(p[1]);
                                    };
                                    dateBadge = isPrevDay
                                        ? '<div class="text-[8px] font-bold text-orange-500 leading-none">' + fmtDay(db.date) + '</div>'
                                        : '<div class="text-[8px] font-bold text-blue-500 leading-none">' + fmtDay(db.date) + '</div>';
                                }

                                return `<tr class="border-b border-gray-100">
                                    <td class="text-center">
                                        <div class="font-mono text-[10px]">${db.time}</div>
                                        ${dateBadge}
                                    </td>
                                    <td class="text-xs">
                                        <div class="font-bold text-slate-700">${db.home} v ${db.away}</div>
                                        <div class="text-[9px] text-slate-400">${db.league}</div>
                                    </td>
                                    <td class="text-center">${imgBtn(db.startImg, 'fa-play-circle', 'success')}</td>
                                    <td class="text-center">${imgBtn(db.stopImg, 'fa-stop-circle', 'error')}</td>
                                    <td class="text-center">${badge}</td>
                                </tr>`;
                            }).join('');
                            el('verification-tbody').innerHTML = html;
                        }
                    }
                });

                return Promise.all([p1, p2]).finally(() => show('verify-loader', false));
            },

            fetchStartImages: function () {
                var dateVal = el('inputDate').value;

                // Reset Start List
                var autoStartList = el('auto-start-list');
                if (autoStartList) autoStartList.innerHTML = '';
                show('auto-start-images', false);
                _autoStartUrls = [];

                // Reset Mono (Stop) List
                var autoMonoList = el('auto-mono-list');
                if (autoMonoList) autoMonoList.innerHTML = '';
                show('auto-mono-images', false);
                ReportManager._autoMonoUrls = [];

                return Server.call({ func: 'getDailyProofImages', silent: true }, dateVal).then(res => {
                    if (res.success) {
                        var hasStartImages = res.data.start && res.data.start.length > 0;

                        // Render Start Images
                        if (hasStartImages) {
                            show('auto-start-images', true);
                            res.data.start.forEach(img => {
                                ReportManager._renderAutoImage(img, autoStartList, _autoStartUrls);
                            });
                        }

                        // ‚úÖ Auto-set Start dropdown based on available images
                        var statusStartEl = el('statusStart');
                        if (statusStartEl) {
                            statusStartEl.value = hasStartImages ? '‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢' : '‡πÑ‡∏°‡πà‡∏°‡∏µ';
                            ReportManager.toggleStartArea(statusStartEl.value);
                        }

                        // Render Stop Images (for Mono)
                        if (res.data.stop && res.data.stop.length > 0) {
                            show('auto-mono-images', true);
                            res.data.stop.forEach(img => {
                                ReportManager._renderAutoImage(img, autoMonoList, ReportManager._autoMonoUrls);
                            });
                        }
                    }
                });
            },

            _renderAutoImage: function (img, container, urlArray) {
                var div = document.createElement('div');
                div.className = "relative group cursor-pointer border-2 border-slate-200 rounded-lg overflow-hidden w-14 h-14 flex-shrink-0 transition-all hover:shadow-md";
                div.innerHTML = `<img src="${formatDriveUrl(img.url)}" class="object-cover w-full h-full opacity-60 transition-opacity">
                                 <div class="auto-check absolute top-0 right-0 w-4 h-4 bg-green-500 rounded-bl-lg flex items-center justify-center hidden"><i class="fas fa-check text-white text-[8px]"></i></div>
                                 <div class="auto-hover absolute inset-0 flex items-center justify-center bg-black/30 opacity-0 group-hover:opacity-100 text-white text-xs transition-opacity"><i class="fas fa-plus-circle"></i></div>
                                 <div class="absolute bottom-0 left-0 right-0 bg-black/60 text-[7px] text-white truncate px-1 py-0.5 leading-tight">${img.label}</div>`;

                // Determine which count badge to update
                var countElId = (urlArray === _autoStartUrls) ? 'auto-start-count' : 'auto-mono-count';

                div.onclick = () => {
                    var checkEl = div.querySelector('.auto-check');
                    var hoverEl = div.querySelector('.auto-hover');
                    var imgEl = div.querySelector('img');

                    if (div.classList.contains('ring-2')) {
                        // Deselect
                        div.classList.remove('ring-2', 'ring-green-500', 'border-green-400');
                        div.classList.add('border-slate-200');
                        if (checkEl) checkEl.classList.add('hidden');
                        if (hoverEl) hoverEl.innerHTML = '<i class="fas fa-plus-circle"></i>';
                        if (imgEl) imgEl.classList.add('opacity-60');
                        const idx = urlArray.indexOf(img.url);
                        if (idx > -1) urlArray.splice(idx, 1);
                    } else {
                        // Select
                        div.classList.add('ring-2', 'ring-green-500', 'border-green-400');
                        div.classList.remove('border-slate-200');
                        if (checkEl) checkEl.classList.remove('hidden');
                        if (hoverEl) hoverEl.innerHTML = '<i class="fas fa-minus-circle"></i>';
                        if (imgEl) imgEl.classList.remove('opacity-60');
                        urlArray.push(img.url);
                    }

                    // Update count badge
                    var countEl = el(countElId);
                    if (countEl) countEl.textContent = urlArray.length + ' ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å';
                };
                container.appendChild(div);
            },

            handleFileUpload: function (input, type) {
                if (input.files.length > 0) {
                    _files[type] = _files[type].concat(Array.from(input.files));
                    this.renderFileList(type);
                }
            },

            triggerPaste: async function (type) {
                try {
                    const items = await navigator.clipboard.read();
                    for (const item of items) {
                        const types = item.types.filter(t => t.startsWith('image/'));
                        for (const t of types) {
                            const blob = await item.getType(t);
                            const file = new File([blob], `pasted_${type}_${Date.now()}.png`, { type: t });
                            _files[type].push(file);
                            this.renderFileList(type);
                            if (typeof UIManager !== 'undefined') UIManager.showToast("‡∏ß‡∏≤‡∏á‡∏£‡∏π‡∏õ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢", "success");
                            return;
                        }
                    }
                    if (typeof UIManager !== 'undefined') UIManager.showToast("‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡πÉ‡∏ô Clipboard", "warning");
                } catch (e) {
                    console.warn("Clipboard API Error:", e);
                    // Focus the dropzone so user can Ctrl+V
                    var dz = el('dropzone-' + type);
                    if (dz) dz.focus();
                    if (typeof UIManager !== 'undefined') UIManager.showToast("‡∏Å‡∏î Ctrl+V ‡∏ó‡∏µ‡πà‡∏Å‡∏£‡∏≠‡∏ö‡πÄ‡∏™‡πâ‡∏ô‡∏õ‡∏∞ ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ß‡∏≤‡∏á‡∏£‡∏π‡∏õ", "info");
                }
            },

            // ‚úÖ Direct paste event handler for dropzones (onpaste attribute)
            handlePasteEvent: function (e, type) {
                var items = (e.clipboardData || e.originalEvent.clipboardData).items;
                for (var i = 0; i < items.length; i++) {
                    if (items[i].type.indexOf("image") !== -1) {
                        var blob = items[i].getAsFile();
                        _files[type].push(blob);
                        ReportManager.renderFileList(type);
                        if (typeof UIManager !== 'undefined') UIManager.showToast("‡∏ß‡∏≤‡∏á‡∏£‡∏π‡∏õ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢ ‚úÖ", "success");
                        e.preventDefault();
                        return;
                    }
                }
            },

            setupPasteHandlers: function () {
                // Attach paste listeners to dropzone elements
                ['mono', 'ais', 'start'].forEach(type => {
                    var dz = el('dropzone-' + type);
                    if (dz && !dz.hasAttribute('data-listening')) {
                        dz.addEventListener('paste', (e) => {
                            ReportManager.handlePasteEvent(e, type);
                        });
                        dz.setAttribute('data-listening', 'true');
                    }
                });
            },

            renderFileList: function (type) {
                var listId = type + 'FileList';
                var container = el(listId);
                if (!container) return;

                container.innerHTML = '';
                _files[type].forEach((file, idx) => {
                    var div = document.createElement('div');
                    div.className = "flex justify-between items-center bg-white p-1.5 rounded border text-[10px] mb-1 shadow-sm";
                    div.innerHTML = `<span class="truncate w-32 text-slate-600">${file.name}</span>
                                     <button onclick="ReportManager.removeFile('${type}',${idx})" class="text-red-400 hover:text-red-600 hover:bg-red-50 p-0.5 rounded transition-colors"><i class="fas fa-times"></i></button>`;
                    container.appendChild(div);
                });
                // Compact dropzone when files exist, full when empty
                var dropzoneId = 'dropzone-' + type;
                var dz = el(dropzoneId);
                if (dz) {
                    if (_files[type].length > 0) {
                        dz.classList.add('py-1', 'p-1.5');
                        dz.classList.remove('p-2.5', 'p-2');
                    } else {
                        dz.classList.remove('py-1', 'p-1.5');
                    }
                }
            },

            removeFile: function (type, index) {
                _files[type].splice(index, 1);
                this.renderFileList(type);
            },
            showTicketInfo: function () {
                Swal.fire({
                    title: '‡∏´‡∏•‡∏±‡∏Å‡∏Å‡∏≤‡∏£‡∏ô‡∏±‡∏ö Ticket',
                    html: '<div style="text-align:left;font-size:12px;line-height:1.7">' +
                        '<div style="background:#ecfdf5;padding:10px 12px;border-radius:8px;border:1px solid #bbf7d0;margin-bottom:8px">' +
                        '<b style="color:#15803d">üü¢ ‡∏á‡∏≤‡∏ô‡πÄ‡∏Ç‡πâ‡∏≤‡πÉ‡∏´‡∏°‡πà (New)</b><br>' +
                        '<span style="color:#16a34a">‡∏ô‡∏±‡∏ö‡∏à‡∏≤‡∏Å <u>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏£‡πâ‡∏≤‡∏á</u> ‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å<br>‡πÑ‡∏°‡πà‡∏™‡∏ô‡∏ß‡πà‡∏≤‡∏ï‡∏≠‡∏ô‡∏ô‡∏µ‡πâ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÄ‡∏õ‡πá‡∏ô‡∏≠‡∏∞‡πÑ‡∏£<br>(‡πÅ‡∏°‡πâ‡πÄ‡∏õ‡∏¥‡∏î‡πÅ‡∏•‡πâ‡∏ß‡∏õ‡∏¥‡∏î‡πÄ‡∏•‡∏¢‡∏Å‡πá‡∏ô‡∏±‡∏ö‡πÄ‡∏õ‡πá‡∏ô New)</span></div>' +
                        '<div style="background:#eff6ff;padding:10px 12px;border-radius:8px;border:1px solid #bfdbfe;margin-bottom:8px">' +
                        '<b style="color:#1d4ed8">üîµ ‡∏õ‡∏¥‡∏î‡πÑ‡∏î‡πâ‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ (Resolved)</b><br>' +
                        '<span style="color:#2563eb">‡∏ô‡∏±‡∏ö‡∏à‡∏≤‡∏Å <u>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏õ‡∏¥‡∏î‡∏á‡∏≤‡∏ô</u> ‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å<br>‡πÑ‡∏°‡πà‡∏™‡∏ô‡∏ß‡πà‡∏≤‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÑ‡∏´‡∏£‡πà = ‡∏ú‡∏•‡∏á‡∏≤‡∏ô‡∏Å‡∏∞‡∏ô‡∏µ‡πâ</span></div>' +
                        '<div style="background:#fef2f2;padding:10px 12px;border-radius:8px;border:1px solid #fecaca">' +
                        '<b style="color:#b91c1c">üî¥ ‡∏á‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤‡∏á (Backlog)</b><br>' +
                        '<span style="color:#dc2626">‡∏á‡∏≤‡∏ô‡∏ó‡∏∏‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà <u>‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏õ‡∏¥‡∏î</u><br>(Open, Pending, In Progress)<br>‡∏£‡∏ß‡∏°‡∏ó‡∏∏‡∏Å‡∏ß‡∏±‡∏ô ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÑ‡∏°‡πà‡πÉ‡∏´‡πâ‡∏á‡∏≤‡∏ô‡∏´‡∏•‡∏∏‡∏î</span></div></div>',
                    icon: 'info',
                    confirmButtonText: '‡πÄ‡∏Ç‡πâ‡∏≤‡πÉ‡∏à‡πÅ‡∏•‡πâ‡∏ß üëç',
                    width: '32rem', // Approx 500px, responsive
                    heightAuto: false, // üîß Critical fix: Don't mess with body height
                    scrollbarPadding: false // üîß Critical fix: Don't add padding-right
                });
            },

            handleReporterChange: function (val) {
                var isOther = (val === 'OTHER');
                _isCustomReporter = isOther;
                show('wrapper-reporter-other', isOther);
                if (isOther) setTimeout(() => el('reporterOther').focus(), 100);
            },

            resetReporter: function () {
                el('reporterSelect').value = '';
                el('reporterOther').value = '';
                show('wrapper-reporter-other', false);
            },

            toggleStartArea: function (val) {
                var hasStart = (val !== '‡πÑ‡∏°‡πà‡∏°‡∏µ');
                show('start-upload-area', hasStart);
            },

            toggleAisActions: function (val) {
                var hasAis = (val !== '‡πÑ‡∏°‡πà‡∏°‡∏µ');
                show('proof-ais-box', hasAis);
            },

            submitForm: function (mode) {
                var reporter = _isCustomReporter ? el('reporterOther').value : el('reporterSelect').value;
                if (!reporter) return UIManager.showToast("‡∏£‡∏∞‡∏ö‡∏∏‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô", "warning");

                var hasMono = (_files.mono && _files.mono.length > 0) || (ReportManager._autoMonoUrls && ReportManager._autoMonoUrls.length > 0);
                if (!hasMono) return UIManager.showToast("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÅ‡∏ô‡∏ö‡∏£‡∏π‡∏õ Mono ‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏à‡∏≤‡∏Å Dashboard", "error");

                var btn = el('btn-submit-report');
                if (mode === 'send') { btn.disabled = true; el('spin-btn-send').classList.remove('hidden'); }

                var formData = {
                    date: el('inputDate').value,
                    reporter: reporter,
                    shift: el('shiftSelect').value,
                    chatTarget: el('chatTargetSelect').value,
                    ticketSummary: el('ticketSummary').value,
                    matchSummary: el('matchSummary').value,
                    matchTotal: el('matchTotalValue').value,
                    matchEnded: el('matchEndedValue').value,
                    transferReport: el('transferReport').value,
                    statusMono: "‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢",
                    statusAis: el('statusAis').value,
                    statusStart: el('statusStart').value,
                    ticketStats: {
                        total: el('disp-ticket-total').innerText,
                        new: el('disp-ticket-new').innerText,
                        open: el('disp-ticket-backlog').innerText,
                        pending: 0,
                        resolved: el('disp-ticket-resolved').innerText,
                        closed: 0,
                        backlog: el('disp-ticket-backlog').innerText
                    },
                    proofImages: {},
                    autoStartUrls: _autoStartUrls,
                    autoMonoUrls: ReportManager._autoMonoUrls,
                    isDraft: (mode === 'preview')
                };

                var compress = (file) => new Promise(res => {
                    var r = new FileReader(); r.readAsDataURL(file);
                    r.onload = e => {
                        var i = new Image(); i.src = e.target.result;
                        i.onload = () => {
                            var c = document.createElement('canvas'); var ctx = c.getContext('2d');
                            var m = 1000, w = i.width, h = i.height;
                            if (w > h && w > m) { h *= m / w; w = m } else if (h > m) { w *= m / h; h = m }
                            c.width = w; c.height = h; ctx.drawImage(i, 0, 0, w, h);
                            res(c.toDataURL('image/jpeg', 0.7).split(',')[1]);
                        }
                    }
                });

                (async () => {
                    try {
                        if (mode !== 'preview') {
                            if (_files.mono.length) formData.proofImages.mono = await Promise.all(_files.mono.map(compress));
                            if (_files.ais.length) formData.proofImages.ais = await Promise.all(_files.ais.map(compress));
                            if (_files.start.length) formData.proofImages.start = await Promise.all(_files.start.map(compress));
                        }

                        var res = await Server.call({ func: 'processShiftReport' }, formData);

                        if (res && res.success) {
                            if (res.isPreview) {
                                el('chatPreviewText').innerText = res.chatPreview;
                                el('preview_modal').showModal();
                            } else {
                                UIManager.showToast("‡∏™‡πà‡∏á‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à", "success");
                                _files = { mono: [], ais: [], start: [] };
                                _autoStartUrls = [];
                                ReportManager._autoMonoUrls = [];
                                this.renderFileList('mono');
                                this.renderFileList('ais');
                                this.renderFileList('start');
                                el('auto-start-list').innerHTML = ''; show('auto-start-images', false);
                                el('auto-mono-list').innerHTML = ''; show('auto-mono-images', false);
                                el('transferReport').value = "";
                            }
                        } else UIManager.showToast(res ? res.error : "Unknown Error", "error");
                    } catch (e) { UIManager.showToast(e.message, "error"); }
                    finally { btn.disabled = false; el('spin-btn-send').classList.add('hidden'); }
                })();
            },

            confirmSend: function () { el('preview_modal').close(); this.submitForm('send'); }
        };
    })();

    if (window.ReportManager) {
        window.ReportManager.init();
        setTimeout(() => window.ReportManager.setupPasteHandlers(), 1000);
    }
</script>