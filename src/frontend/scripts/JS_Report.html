<script>
  /**
   * JS_Report.html
   * Logic สำหรับหน้า Shift Report
   */
  const Report = {
    // เก็บไฟล์รูปภาพชั่วคราว
    proofFiles: { mono: [], ais: [], start: [] },

    init() {
      // โค้ดเริ่มต้นทำงาน (ถ้ามี)
    },

    // --- UI Interactions ---

    // เช็คถ้าเลือก "อื่นๆ" ให้โชว์ช่องกรอก
    checkReporterOther() {
      const val = document.getElementById('reporterSelect').value;
      const other = document.getElementById('reporterOther');
      if (val === 'อื่นๆ') {
        other.classList.remove('hidden');
        other.focus();
      } else {
        other.classList.add('hidden');
      }
    },

    // ซ่อน/แสดง โซนอัปโหลดรูปตามสถานะ
    toggleUploadSection(selectId, divId, fileType) {
      const val = document.getElementById(selectId).value;
      const div = document.getElementById(divId);
      if (val === 'ไม่มี') {
        div.classList.add('hidden');
        this.proofFiles[fileType] = []; // ล้างไฟล์ทิ้ง
        this.updateFileListUi(fileType, fileType + 'FileList');
      } else {
        div.classList.remove('hidden');
      }
    },

    // --- Image Processing (Compress & Handle) ---

    async compressImage(file) {
      const MAX_DIMENSION = 1600;
      const QUALITY = 0.8;
      return new Promise((resolve) => {
        const reader = new FileReader();
        reader.readAsDataURL(file);
        reader.onload = (e) => {
          const img = new Image();
          img.src = e.target.result;
          img.onload = () => {
            let width = img.width;
            let height = img.height;

            // คำนวณ Aspect Ratio
            if (width > height) {
              if (width > MAX_DIMENSION) { height *= MAX_DIMENSION / width; width = MAX_DIMENSION; }
            } else {
              if (height > MAX_DIMENSION) { width *= MAX_DIMENSION / height; height = MAX_DIMENSION; }
            }

            const canvas = document.createElement('canvas');
            canvas.width = width;
            canvas.height = height;
            const ctx = canvas.getContext('2d');
            ctx.drawImage(img, 0, 0, width, height);

            // คืนค่าเป็น Base64 (ตัด header ออก)
            resolve({
              data: canvas.toDataURL('image/jpeg', QUALITY).split(',')[1],
              mimeType: 'image/jpeg'
            });
          };
        };
      });
    },

    // เมื่อเลือกไฟล์จากปุ่ม Upload
    handleFilesUpload(inputId, listId) {
      const input = document.getElementById(inputId);
      const type = inputId.replace('file', '').toLowerCase(); // mono, ais, start
      const files = Array.from(input.files);

      if (files.length > 0) {
        this.proofFiles[type] = [...this.proofFiles[type], ...files];
        this.updateFileListUi(type, listId);
        UIManager.showToast(`เพิ่มรูปภาพ ${files.length} รายการ`, 'success');
      }
      input.value = ''; // Reset input
    },

    // เมื่อกดปุ่ม Paste (จาก Clipboard)
    async pasteImage(type, listId) {
      try {
        const items = await navigator.clipboard.read();
        for (const item of items) {
          const imgTypes = item.types.filter(t => t.startsWith('image/'));
          if (imgTypes.length > 0) {
            const blob = await item.getType(imgTypes[0]);
            const file = new File([blob], `Pasted_${Date.now()}.png`, { type: imgTypes[0] });
            this.proofFiles[type].push(file);
            this.updateFileListUi(type, listId);
            UIManager.showToast("วางรูปเรียบร้อย", 'success');
            return;
          }
        }
        UIManager.showToast("ไม่พบรูปใน Clipboard", 'warning');
      } catch (err) {
        UIManager.showToast("เข้าถึง Clipboard ไม่ได้ (อนุญาตสิทธิ์ก่อน)", 'error');
      }
    },

    // อัปเดตรายชื่อไฟล์ที่หน้าเว็บ
    updateFileListUi(type, listId) {
      const container = document.getElementById(listId);
      container.innerHTML = '';
      this.proofFiles[type].forEach((file, index) => {
        const div = document.createElement('div');
        div.className = 'flex items-center justify-between bg-base-100 border border-base-300 px-3 py-2 rounded-lg mb-1 shadow-sm';
        div.innerHTML = `
        <span class="truncate pr-4 font-mono">${file.name}</span> 
        <button type="button" onclick="Report.removeFile('${type}', ${index}, '${listId}')" class="btn btn-xs btn-square btn-ghost text-error">
          <i class="fas fa-times"></i>
        </button>`;
        container.appendChild(div);
      });
    },

    removeFile(type, index, listId) {
      this.proofFiles[type].splice(index, 1);
      this.updateFileListUi(type, listId);
    },

    // --- Data Fetching ---

    // 1. ดึงข้อมูล Ticket (รองรับ 5 สถานะ)
    autoFetchTicket(btn) {
      const d = document.getElementById('inputDate').value;
      if (!d) return UIManager.showToast("กรุณาเลือกวันที่ก่อน", 'warning');

      const originalText = btn.innerHTML;
      btn.disabled = true;
      btn.innerHTML = '<span class="loading loading-spinner loading-xs"></span>';

      Server.call('getTicketDetails', d)
        .then(res => {
          // A. อัปเดตค่าลง Hidden Input (สำหรับส่ง Backend)
          document.getElementById('ticketSummary').value = res.text;
          document.getElementById('ticketDetailsRaw').value = res.rawDetails;

          document.getElementById('ticketTotal').value = res.rawStats.total || 0;
          document.getElementById('ticketOpen').value = res.rawStats.open || 0;
          document.getElementById('ticketPending').value = res.rawStats.pending || 0;
          document.getElementById('ticketResolved').value = res.rawStats.resolved || 0;
          document.getElementById('ticketClosed').value = res.rawStats.closed || 0;

          // B. อัปเดตตัวเลขบนหน้าจอ (Visual Stats)
          const setText = (id, val) => {
            const el = document.getElementById(id);
            if (el) el.innerText = val;
          };

          setText('disp-ticket-total', res.rawStats.total || 0);
          setText('disp-ticket-open', res.rawStats.open || 0);
          setText('disp-ticket-pending', res.rawStats.pending || 0);
          setText('disp-ticket-resolved', res.rawStats.resolved || 0);
          setText('disp-ticket-closed', res.rawStats.closed || 0);

          UIManager.showToast("อัปเดต Ticket เรียบร้อย", 'success');
        })
        .catch(err => UIManager.showToast(err.message, 'error'))
        .finally(() => {
          btn.disabled = false;
          btn.innerHTML = originalText;
        });
    },

    // 2. ดึงข้อมูล Match
    autoFetchMatch(btn) {
      const d = document.getElementById('inputDate').value;
      if (!d) return UIManager.showToast("กรุณาเลือกวันที่ก่อน", 'warning');

      const originalText = btn.innerHTML;
      btn.disabled = true;
      btn.innerHTML = '<span class="loading loading-spinner loading-xs"></span>';

      Server.call('getMatchesByDate', d)
        .then(res => {
          // A. อัปเดตค่า Hidden Input
          document.getElementById('matchSummary').value = res.text;
          document.getElementById('matchDataJSON').value = JSON.stringify(res.data);
          document.getElementById('matchTotal').value = res.total;

          // B. อัปเดตตัวเลขบนหน้าจอ
          const dispTotal = document.getElementById('disp-match-total');
          if (dispTotal) dispTotal.innerText = res.total || 0;

          const dispStatus = document.getElementById('disp-match-status');
          if (dispStatus) dispStatus.innerText = `Fetched: ${res.total} Items`;

          UIManager.showToast("อัปเดต Match เรียบร้อย", 'success');
        })
        .catch(err => UIManager.showToast(err.message, 'error'))
        .finally(() => {
          btn.disabled = false;
          btn.innerHTML = originalText;
        });
    },

    // --- Form Submission ---

    async submitForm(e, mode = 'send') {
      if (e) e.preventDefault();
      const form = document.getElementById('mainForm');

      // Validation
      if (!form.checkValidity()) return form.reportValidity();
      if (this.proofFiles.mono.length === 0) return UIManager.showToast("กรุณาแนบรูป Mono อย่างน้อย 1 รูป", 'warning');

      UIManager.showLoading();

      // เตรียม Data Object
      const formData = {
        date: form.date.value,
        reporter: form.reporter.value === 'อื่นๆ' ? document.getElementById('reporterOther').value : form.reporter.value,
        shift: form.shift.value,
        ticketSummary: form.ticketSummary.value,

        // ✅ ส่ง 5 สถานะ Ticket
        ticketStats: {
          total: document.getElementById('ticketTotal').value,
          open: document.getElementById('ticketOpen').value,
          pending: document.getElementById('ticketPending').value,
          resolved: document.getElementById('ticketResolved').value,
          closed: document.getElementById('ticketClosed').value
        },

        ticketDetails: document.getElementById('ticketDetailsRaw').value,
        matchSummary: form.matchSummary.value,
        matchTotal: document.getElementById('matchTotal').value,
        matchData: JSON.parse(document.getElementById('matchDataJSON').value || "{}"),
        transferReport: form.transferReport.value,
        statusMono: document.getElementById('statusMono').value,
        statusAis: document.getElementById('statusAis').value,
        statusStart: document.getElementById('statusStart').value,
        chatTarget: form.chatTarget.value,
        proofImages: {}, // รอใส่ Blob
        isDraft: (mode === 'preview')
      };

      try {
        // Compress Images (Async Parallel)
        if (this.proofFiles.mono.length > 0) formData.proofImages.mono = await Promise.all(this.proofFiles.mono.map(f => this.compressImage(f)));
        if (this.proofFiles.ais.length > 0) formData.proofImages.ais = await Promise.all(this.proofFiles.ais.map(f => this.compressImage(f)));
        if (this.proofFiles.start.length > 0) formData.proofImages.start = await Promise.all(this.proofFiles.start.map(f => this.compressImage(f)));

        // Call Backend
        // ใช้ google.script.run โดยตรงเพื่อความชัวร์ในการส่ง Blob และข้อมูลขนาดใหญ่
        google.script.run
          .withSuccessHandler(resStr => {
            UIManager.hideLoading();
            const res = JSON.parse(resStr); // Backend ส่ง JSON String มา

            if (res.success) {
              if (res.isPreview) {
                this.showPreviewModal(res.pdfUrl, res.chatPreview);
              } else {
                UIManager.showToast("ส่งรายงานเรียบร้อยแล้ว!", 'success');
                // Reset Form
                form.reset();
                this.proofFiles = { mono: [], ais: [], start: [] };
                this.updateFileListUi('mono', 'monoFileList');
                this.updateFileListUi('ais', 'aisFileList');
                this.updateFileListUi('start', 'startFileList');

                // Redirect ไปหน้า History (ถ้ามี Router)
                if (typeof Router !== 'undefined') {
                  setTimeout(() => Router.navigateTo('page-history'), 1000);
                }
              }
            } else {
              UIManager.showToast("Error: " + res.error, 'error');
            }
          })
          .withFailureHandler(err => {
            UIManager.hideLoading();
            UIManager.showToast("Server Failed: " + err.message, 'error');
          })
          .processShiftReport(formData);

      } catch (err) {
        UIManager.hideLoading();
        UIManager.showToast("Client Error: " + err.message, 'error');
        console.error(err);
      }
    },

    // --- Modal Helpers ---

    showPreviewModal(url, chatText) {
      document.getElementById('previewLink').href = url;
      document.getElementById('chatPreviewText').textContent = chatText;
      document.getElementById('preview_modal').showModal();
    },

    confirmSend() {
      document.getElementById('preview_modal').close();
      this.submitForm(null, 'send');
    }
  };
</script>