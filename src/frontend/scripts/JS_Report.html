<script>
    /**
       * JS_Report.html
       * Version: Final Fix (Index 0 Bug, Hard Refresh, Display Logic)
       */
    window.ReportManager = (function () {
        // --- State Variables ---
        var _files = { mono: [], ais: [], start: [] };
        var _autoStartUrls = [];
        var _autoMonoUrls = [];
        var _isCustomReporter = false;
        var _picker = null;
        var _isLoading = false;

        // --- Helpers ---
        var el = function (id) { return document.getElementById(id); };
        var show = function (id, visible) { var e = el(id); if (e) e.classList.toggle('hidden', !visible); };

        var formatDriveUrl = function (url) {
            if (!url) return "";
            if (url.startsWith('data:')) return url;
            try {
                var id = null;
                if (url.indexOf('/d/') !== -1) id = url.match(/\/d\/(.+?)(\/|$)/)[1];
                else if (url.indexOf('id=') !== -1) id = url.match(/id=([^&]+)/)[1];
                return id ? 'https://drive.google.com/thumbnail?id=' + id + '&sz=w1000' : url;
            } catch (e) { return url; }
        };

        // üß† Smart Date Parser (Safe Version)
        var smartParse = function (val) {
            if (!val) return { date: '', display: '' };
            let d = null;
            try {
                if (val instanceof Date) {
                    d = val;
                } else if (typeof val === 'string') {
                    const s = val.trim();
                    // Try DD/MM/YYYY
                    const matchDMY = s.match(/^(\d{1,2})[\/\-\.](\d{1,2})[\/\-\.](\d{4})(?:\s+(\d{1,2}):(\d{1,2})(?::(\d{1,2}))?)?/);
                    if (matchDMY) {
                        d = new Date(parseInt(matchDMY[3]), parseInt(matchDMY[2]) - 1, parseInt(matchDMY[1]), parseInt(matchDMY[4] || 0), parseInt(matchDMY[5] || 0), parseInt(matchDMY[6] || 0));
                    } else {
                        // Try ISO or other formats
                        const tryD = new Date(s);
                        if (!isNaN(tryD.getTime())) d = tryD;
                    }
                }
            } catch (e) { console.warn("Date parse error", e); }

            if (d && !isNaN(d.getTime())) {
                const yyyy = d.getFullYear();
                const mm = String(d.getMonth() + 1).padStart(2, '0');
                const dd = String(d.getDate()).padStart(2, '0');
                return { date: `${yyyy}-${mm}-${dd}`, display: `${dd}/${mm}/${yyyy}`, nativeObj: d };
            }
            return { date: '', display: val || '-', nativeObj: null };
        };

        return {
            _autoMonoUrls: _autoMonoUrls, // Expose for debug

            init: function () {
                document.addEventListener('page-change', function (e) {
                    if (e.detail.pageId === 'page-report') ReportManager.onPageShow();
                });
            },

            onPageShow: function () {
                if (!_picker) {
                    var input = el('inputDate');
                    if (input) {
                        var today = new Date();
                        var yyyy = today.getFullYear();
                        var mm = String(today.getMonth() + 1).padStart(2, '0');
                        var dd = String(today.getDate()).padStart(2, '0');
                        input.value = `${yyyy}-${mm}-${dd}`;

                        _picker = new Pikaday({
                            field: input,
                            format: 'YYYY-MM-DD',
                            toString(date, format) {
                                const day = String(date.getDate()).padStart(2, '0');
                                const month = String(date.getMonth() + 1).padStart(2, '0');
                                const year = date.getFullYear();
                                return `${year}-${month}-${day}`;
                            },
                            yearRange: [2020, 2030],
                            onSelect: function () { if (!_isLoading) ReportManager.autoFetchAll(); }
                        });
                        setTimeout(function () { ReportManager.autoFetchAll(); }, 300);
                    }
                }
                this.fetchReporters();
                // Setup paste handlers initially
                setTimeout(() => { if (this.setupPasteHandlers) this.setupPasteHandlers(); }, 1000);
            },

            autoFetchAll: function () {
                if (_isLoading) return;
                var dateVal = el('inputDate').value;
                if (!dateVal) return;

                var self = this;
                self._setLoading(true);

                Promise.all([
                    self.fetchTickets(),
                    self.fetchMatches(),
                    self.fetchStartImages()
                ]).then(function () {
                    if (typeof UIManager !== 'undefined') UIManager.showToast("‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢", "success");
                }).catch(function (err) {
                    console.error("Fetch Error:", err);
                    if (typeof UIManager !== 'undefined') UIManager.showToast("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•", "error");
                }).finally(function () {
                    self._setLoading(false);
                });
            },

            _setLoading: function (loading) {
                _isLoading = loading;
                var btn = el('btn-load-data');
                var input = el('inputDate');
                if (input) input.disabled = loading;
                if (btn) {
                    btn.disabled = loading;
                    if (loading) btn.classList.add('is-loading');
                    else btn.classList.remove('is-loading');
                }
            },

            // ‚úÖ ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏î‡∏∂‡∏á Ticket (Robust & Shift Logic)
            fetchTickets: function () {
                var selectedDate = el('inputDate').value; // YYYY-MM-DD

                // üîç Safe Element Selector
                var tbody = el('disp-ticket-tbody') || el('ticket-table-body');
                if (!tbody) {
                    console.error("‚ùå ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏ï‡∏≤‡∏£‡∏≤‡∏á Ticket (ID: disp-ticket-tbody ‡∏´‡∏£‡∏∑‡∏≠ ticket-table-body)");
                    return Promise.resolve();
                }

                show('loader-ticket', true);
                show('empty-ticket', false);
                tbody.innerHTML = '';

                return Server.call({ func: 'getTickets', silent: true })
                    .then(function (res) {
                        if (res && res.success) {
                            var allTickets = res.data || [];

                            // Stats Logic (Shift Based)
                            let stats = {
                                newToday: 0,    // ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ
                                closedToday: 0, // ‡∏õ‡∏¥‡∏î‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ
                                pending: 0,     // ‡∏Ñ‡πâ‡∏≤‡∏á (‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î)
                                filteredCount: 0
                            };

                            let listForTable = [];

                            allTickets.forEach(r => {
                                const createdObj = smartParse(r.date);
                                const resolvedObj = smartParse(r.resolvedDate);

                                const status = String(r.status || '').toLowerCase();
                                const isClosed = (status.includes('close') || status.includes('resolved') || status.includes('fix'));

                                // üü¢ 1. ‡∏á‡∏≤‡∏ô‡πÄ‡∏Ç‡πâ‡∏≤‡πÉ‡∏´‡∏°‡πà
                                if (createdObj.date === selectedDate) {
                                    stats.newToday++;
                                }

                                // üîµ 2. ‡∏õ‡∏¥‡∏î‡πÑ‡∏î‡πâ‡πÉ‡∏ô‡∏Å‡∏∞
                                if (isClosed) {
                                    if (resolvedObj.date === selectedDate) {
                                        stats.closedToday++;
                                    }
                                    // Fallback
                                    else if (!resolvedObj.date && createdObj.date === selectedDate) {
                                        stats.closedToday++;
                                    }
                                }
                                // üî¥ 3. ‡∏á‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤‡∏á
                                else {
                                    stats.pending++;
                                }

                                // üìù 4. Filter ‡πÅ‡∏™‡∏î‡∏á‡πÉ‡∏ô‡∏ï‡∏≤‡∏£‡∏≤‡∏á
                                let showRow = false;
                                let tag = '';

                                if (createdObj.date === selectedDate) {
                                    showRow = true;
                                    tag = 'NEW';
                                } else if (isClosed && (resolvedObj.date === selectedDate || (!resolvedObj.date && createdObj.date === selectedDate))) {
                                    showRow = true;
                                    tag = 'RESOLVED';
                                } else if (!isClosed) {
                                    showRow = true;
                                    tag = 'BACKLOG';
                                }

                                // üéØ Date Logic
                                const ticketDate = createdObj.nativeObj || new Date(r.date);
                                const selectedDateObj = new Date(selectedDate);
                                const yesterdayObj = new Date(selectedDate);
                                yesterdayObj.setDate(yesterdayObj.getDate() - 1);

                                const isSameDay = (d1, d2) => d1.getFullYear() === d2.getFullYear() &&
                                    d1.getMonth() === d2.getMonth() &&
                                    d1.getDate() === d2.getDate();

                                let dateDisplay = createdObj.display;
                                if (!isNaN(ticketDate.getTime())) {
                                    const hh = String(ticketDate.getHours()).padStart(2, '0');
                                    const mm = String(ticketDate.getMinutes()).padStart(2, '0');

                                    if (isSameDay(ticketDate, selectedDateObj)) {
                                        dateDisplay = `<span class="text-blue-600 font-bold">(‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ) ${hh}:${mm}</span>`;
                                    } else if (isSameDay(ticketDate, yesterdayObj)) {
                                        dateDisplay = `<span class="text-gray-500">(‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏ß‡∏≤‡∏ô) ${hh}:${mm}</span>`;
                                    } else {
                                        dateDisplay = `${createdObj.display} ${hh}:${mm}`;
                                    }
                                }

                                if (showRow) {
                                    stats.filteredCount++;
                                    listForTable.push({
                                        id: r.ticketNumber,
                                        dateDisplay: dateDisplay,
                                        status: r.status || '-',
                                        subject: r.subject || '-',
                                        tag: tag,
                                        sortKey: tag === 'NEW' ? 3 : (tag === 'RESOLVED' ? 2 : 1)
                                    });
                                }
                            });

                            // Update UI Stats
                            if (el('disp-ticket-total')) el('disp-ticket-total').innerText = stats.filteredCount || 0;
                            if (el('disp-ticket-new')) el('disp-ticket-new').innerText = stats.newToday || 0;
                            if (el('disp-ticket-resolved')) el('disp-ticket-resolved').innerText = stats.closedToday || 0;
                            if (el('disp-ticket-backlog')) el('disp-ticket-backlog').innerText = stats.pending || 0;

                            if (el('ticketSummary')) el('ticketSummary').value = `‡∏á‡∏≤‡∏ô‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ: ${stats.newToday}, ‡∏õ‡∏¥‡∏î‡πÑ‡∏î‡πâ: ${stats.closedToday}, ‡∏Ñ‡πâ‡∏≤‡∏á: ${stats.pending}`;

                            // Render Table
                            listForTable.sort((a, b) => b.sortKey - a.sortKey || String(b.id).localeCompare(String(a.id)));

                            if (listForTable.length > 0) {
                                var html = listForTable.map(function (t) {
                                    var st = String(t.status || '').toLowerCase();
                                    var badgeClass = 'badge-ghost bg-gray-100 text-gray-500 border-none';

                                    if (st.includes('open')) badgeClass = 'badge-error text-white shadow-sm';
                                    else if (st.includes('pending') || st.includes('wait')) badgeClass = 'badge-warning text-white shadow-sm';
                                    else if (st.includes('resolved') || st.includes('close')) badgeClass = 'badge-success text-white shadow-sm';

                                    var miniTag = '';
                                    if (t.tag === 'NEW') miniTag = '<span class="text-[9px] text-blue-500 font-bold ml-1 tracking-tighter">‚ú®NEW</span>';
                                    else if (t.tag === 'RESOLVED') miniTag = '<span class="text-[9px] text-green-500 font-bold ml-1 tracking-tighter">‚úìDONE</span>';
                                    else if (t.tag === 'BACKLOG') miniTag = '<span class="text-[9px] text-gray-400 font-bold ml-1 tracking-tighter">‚è≥OLD</span>';

                                    return `<tr class="border-b border-gray-100 hover:bg-gray-50 transition-colors">
                                                <td class="font-mono font-bold text-center text-[10px] text-gray-400 w-24 py-3">${t.id}</td>
                                                <td class="text-center p-1 w-32">
                                                    <div class="flex flex-col items-center justify-center">
                                                        <span class="badge ${badgeClass} badge-xs font-bold uppercase tracking-wide h-5 px-2 min-w-[70px]">
                                                            ${t.status}
                                                        </span>
                                                        ${miniTag}
                                                    </div>
                                                </td>
                                                <td class="p-2 overflow-hidden">
                                                    <div class="text-xs text-gray-700 font-medium truncate w-full" title="${t.subject}">
                                                        ${t.subject}
                                                    </div>
                                                    <div class="text-[9px] text-gray-400 mt-0.5 font-mono">${t.dateDisplay}</div>
                                                </td>
                                            </tr>`;

                                }).join('');
                                tbody.innerHTML = html;
                            } else {
                                show('empty-ticket', true);
                            }
                        }
                    })
                    .catch(function (err) { console.error("Ticket Load Error", err); show('empty-ticket', true); })
                    .finally(() => show('loader-ticket', false));
            },

            fetchMatches: function () {
                var dateVal = el('inputDate').value;
                show('verify-loader', true);
                el('verification-tbody').innerHTML = '';

                // 1. Get Stats breakdown
                var p1 = Server.call({ func: 'getMatchesByDate', silent: true }, dateVal).then(res => {
                    if (res.success) {
                        var summaryText = "";
                        var breakdownHtml = "";
                        if (res.data) {
                            for (var league in res.data) {
                                summaryText += `${league}: ${res.data[league]}\n`;
                                breakdownHtml += `<div class="badge badge-ghost badge-sm text-[10px] gap-1 whitespace-nowrap border-slate-200">
                                    ${league}: <span class="font-bold text-slate-700">${res.data[league]}</span>
                                </div>`;
                            }
                        }
                        if (el('matchSummary')) el('matchSummary').value = summaryText || "‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÅ‡∏Ç‡πà‡∏á‡∏Ç‡∏±‡∏ô";
                        var bd = el('league-breakdown');
                        if (bd) bd.innerHTML = breakdownHtml;
                    }
                });

                // 2. Get Verification Table
                var p2 = Server.call({ func: 'getVerificationReport', silent: true }, dateVal).then(res => {
                    if (res.success) {
                        if (el('matchTotalValue')) el('matchTotalValue').value = res.data.stats.totalMatches;
                        if (el('disp-match-total')) el('disp-match-total').innerText = res.data.stats.totalMatches + " ‡∏Ñ‡∏π‡πà";

                        var list = res.data.list || [];
                        var endedCount = list.filter(item => item.dashboard && item.dashboard.stopImg).length;
                        if (el('matchEndedValue')) el('matchEndedValue').value = endedCount;

                        if (list.length === 0) {
                            show('verify-empty', true);
                        } else {
                            show('verify-empty', false);
                            var html = "";
                            var currentGroup = "";

                            list.forEach(item => {
                                var db = item.dashboard;
                                var isToday = (db.date === dateVal);
                                var groupKey = isToday ? "today" : "yesterday";

                                if (groupKey !== currentGroup) {
                                    currentGroup = groupKey;
                                    var label = isToday
                                        ? `<span class="text-blue-600 flex items-center gap-1"><i class="fas fa-sun text-yellow-500"></i> ‡∏´‡∏•‡∏±‡∏á‡πÄ‡∏ó‡∏µ‡πà‡∏¢‡∏á‡∏Ñ‡∏∑‡∏ô (‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ)</span>`
                                        : `<span class="text-gray-500 flex items-center gap-1"><i class="fas fa-moon text-indigo-400"></i> ‡∏Å‡πà‡∏≠‡∏ô‡πÄ‡∏ó‡∏µ‡πà‡∏¢‡∏á‡∏Ñ‡∏∑‡∏ô (‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏ß‡∏≤‡∏ô)</span>`;

                                    html += `<tr class="bg-gray-50/80 border-b border-gray-200">
                                            <td colspan="5" class="px-3 py-1.5 font-bold text-[10px] uppercase">${label}</td>
                                        </tr>`;
                                }

                                var hasEvidence = !!(db.startImg || db.stopImg);
                                var badge = hasEvidence
                                    ? '<div class="w-5 h-5 rounded-full bg-success/10 flex items-center justify-center mx-auto"><i class="fas fa-check text-success text-[10px]"></i></div>'
                                    : '<div class="w-5 h-5 rounded-full bg-base-200 flex items-center justify-center mx-auto"><i class="fas fa-times text-base-content/30 text-[10px]"></i></div>';

                                var imgBtn = (url, icon, color) => url
                                    ? `<a href="${formatDriveUrl(url)}" target="_blank" class="btn btn-xs btn-square btn-ghost text-${color}"><i class="fas ${icon}"></i></a>`
                                    : `<span class="text-gray-300 text-[10px]">-</span>`;

                                html += `<tr class="border-b border-gray-100 hover:bg-white transition-colors">
                                        <td class="text-center font-mono text-[10px] text-gray-500">${db.time}</td>
                                        <td class="text-xs py-2">
                                            <div class="font-bold text-slate-700">${db.home} v ${db.away}</div>
                                            <div class="text-[9px] text-slate-400">${db.league}</div>
                                        </td>
                                        <td class="text-center">${imgBtn(db.startImg, 'fa-play-circle', 'success')}</td>
                                        <td class="text-center">${imgBtn(db.stopImg, 'fa-stop-circle', 'error')}</td>
                                        <td class="text-center">${badge}</td>
                                    </tr>`;
                            });
                            el('verification-tbody').innerHTML = html;
                        }
                    }
                });
                return Promise.all([p1, p2]).finally(() => show('verify-loader', false));
            },

            fetchStartImages: function () {
                var dateVal = el('inputDate').value;
                var autoStartList = el('auto-start-list');
                if (autoStartList) autoStartList.innerHTML = '';
                show('auto-start-images', false);
                _autoStartUrls = [];

                var autoMonoList = el('auto-mono-list');
                if (autoMonoList) autoMonoList.innerHTML = '';
                show('auto-mono-images', false);
                _autoMonoUrls = [];

                return Server.call({ func: 'getDailyProofImages', silent: true }, dateVal).then(res => {
                    if (res.success) {
                        if (res.data.start && res.data.start.length > 0) {
                            show('auto-start-images', true);
                            res.data.start.forEach(img => ReportManager._renderAutoImage(img, autoStartList, _autoStartUrls));
                        }
                        // Force update status (should default to None, but area check will show images)
                        ReportManager._updateStartStatus();

                        if (res.data.stop && res.data.stop.length > 0) {
                            show('auto-mono-images', true);
                            res.data.stop.forEach(img => ReportManager._renderAutoImage(img, autoMonoList, _autoMonoUrls));
                        }
                    }
                });
            },

            fetchReporters: function () {
                Server.call({ func: 'getStaffAndAssignees', silent: true }).then(function (res) {
                    if (res && res.success && res.data && res.data.leaders) {
                        var select = el('reporterSelect');
                        if (!select) return;

                        var currentVal = select.value;
                        var html = '<option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å --</option>';
                        res.data.leaders.forEach(function (name) {
                            html += `<option value="${name}">${name}</option>`;
                        });
                        html += '<option value="OTHER">‡∏≠‡∏∑‡πà‡∏ô‡πÜ</option>';
                        select.innerHTML = html;
                        if (currentVal) select.value = currentVal;
                    }
                }).catch(function (err) { console.error("Fetch Reporters Error", err); });
            },

            // ‚úÖ ‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ Start Channel ‡∏ï‡∏≤‡∏°‡∏Å‡∏≤‡∏£‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏π‡∏õ
            _updateStartStatus: function () {
                var hasImages = (_autoStartUrls.length > 0) || (_files.start && _files.start.length > 0);
                var statusEl = el('statusStart');

                // 1. ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡∏£‡∏π‡∏õ‡πÉ‡∏´‡πâ‡πÄ‡∏õ‡πá‡∏ô '‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢'
                if (statusEl) {
                    if (hasImages) {
                        statusEl.value = '‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢';
                    }
                    // 2. ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏π‡∏õ ‡πÅ‡∏ï‡πà‡∏Ñ‡πà‡∏≤‡πÄ‡∏î‡∏¥‡∏°‡πÄ‡∏õ‡πá‡∏ô '‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢' -> ‡πÉ‡∏´‡πâ‡∏Å‡∏•‡∏±‡∏ö‡πÄ‡∏õ‡πá‡∏ô '‡πÑ‡∏°‡πà‡∏°‡∏µ'
                    // (‡πÅ‡∏ï‡πà‡∏ñ‡πâ‡∏≤ user ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å '‡∏ï‡∏¥‡∏î‡∏õ‡∏±‡∏ç‡∏´‡∏≤' ‡∏Ñ‡πâ‡∏≤‡∏á‡πÑ‡∏ß‡πâ ‡πÄ‡∏£‡∏≤‡πÑ‡∏°‡πà‡∏Ñ‡∏ß‡∏£‡πÑ‡∏õ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô)
                    else if (statusEl.value === '‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢') {
                        statusEl.value = '‡πÑ‡∏°‡πà‡∏°‡∏µ';
                    }
                    ReportManager.toggleStartArea(statusEl.value);
                }
            },

            // ‚úÖ ‡πÅ‡∏Å‡πâ‡∏ö‡∏±‡πä‡∏Å‡∏£‡∏π‡∏õ Index 0 ‡πÑ‡∏°‡πà‡πÅ‡∏™‡∏î‡∏á ‡πÅ‡∏•‡∏∞‡∏Å‡∏≤‡∏£‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏π‡∏õ
            _renderAutoImage: function (img, container, urlArray) {
                var div = document.createElement('div');
                div.className = "relative group cursor-pointer border-2 border-slate-200 rounded-lg overflow-hidden w-14 h-14 flex-shrink-0 transition-all hover:shadow-md";
                div.innerHTML = `<img src="${formatDriveUrl(img.url)}" class="object-cover w-full h-full opacity-60 transition-opacity">
                                 <div class="auto-check absolute top-0 right-0 w-4 h-4 bg-green-500 rounded-bl-lg flex items-center justify-center hidden"><i class="fas fa-check text-white text-[8px]"></i></div>
                                 <div class="auto-hover absolute inset-0 flex items-center justify-center bg-black/30 opacity-0 group-hover:opacity-100 text-white text-xs transition-opacity"><i class="fas fa-plus-circle"></i></div>
                                 <div class="absolute bottom-0 left-0 right-0 bg-black/60 text-[7px] text-white truncate px-1 py-0.5 leading-tight">${img.label}</div>`;

                div.onclick = () => {
                    var checkEl = div.querySelector('.auto-check');
                    if (div.classList.contains('ring-2')) {
                        // Uncheck
                        div.classList.remove('ring-2', 'ring-green-500', 'border-green-400');
                        div.classList.add('border-slate-200');
                        checkEl.classList.add('hidden');
                        var idx = urlArray.indexOf(img.url);
                        if (idx > -1) urlArray.splice(idx, 1);
                    } else {
                        // Check
                        div.classList.add('ring-2', 'ring-green-500', 'border-green-400');
                        div.classList.remove('border-slate-200');
                        checkEl.classList.remove('hidden');
                        urlArray.push(img.url);
                    }
                    // Update Counts (Optional UI feedback)
                    ReportManager.updateImageCounts();

                    // üî• Auto Update Status for Start Channel
                    if (container.id === 'auto-start-list') {
                        ReportManager._updateStartStatus();
                    }
                };
                container.appendChild(div);
            },

            updateImageCounts: function () {
                var startBadge = el('auto-start-count');
                if (startBadge) startBadge.innerText = _autoStartUrls.length + ' ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å';

                var monoBadge = el('auto-mono-count');
                if (monoBadge) monoBadge.innerText = _autoMonoUrls.length + ' ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å';
            },

            handleFileUpload: function (input, type) {
                if (input.files.length > 0) {
                    _files[type] = _files[type].concat(Array.from(input.files));
                    this.renderFileList(type);
                    if (type === 'start') ReportManager._updateStartStatus();
                }
            },

            renderFileList: function (type) {
                var dropzone = el('dropzone-' + type);
                if (!dropzone) return;
                var files = _files[type];
                dropzone.innerHTML = '';

                if (files.length === 0) {
                    var color = (type === 'start') ? 'amber' : (type === 'mono' ? 'indigo' : 'green');
                    dropzone.className = `border-2 border-dashed border-${color}-300 hover:border-${color}-400 bg-${color}-50/30 hover:bg-${color}-50 rounded-lg p-2.5 cursor-pointer transition-all group text-center focus:ring-2 focus:ring-${color}-300 focus:outline-none`;
                    dropzone.innerHTML = `<div class="flex items-center justify-center gap-2 text-${color}-400 group-hover:text-${color}-500 transition-colors">
                                            <i class="fas fa-cloud-upload-alt text-sm"></i>
                                            <span class="text-[10px] font-semibold">‡∏Ñ‡∏•‡∏¥‡∏Å‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î ‡∏´‡∏£‡∏∑‡∏≠ Ctrl+V ‡∏ß‡∏≤‡∏á‡∏£‡∏π‡∏õ</span>
                                          </div>`;
                } else {
                    dropzone.className = `border border-gray-200 p-2 rounded-lg bg-white`;
                    var grid = document.createElement('div');
                    grid.className = 'flex flex-wrap gap-2 justify-center';
                    files.forEach((file, idx) => {
                        var url = URL.createObjectURL(file);
                        var item = document.createElement('div');
                        item.className = "relative w-16 h-16 rounded overflow-hidden border shadow-sm";
                        item.innerHTML = `<img src="${url}" class="w-full h-full object-cover">
                                          <button onclick="event.stopPropagation(); ReportManager.removeFile('${type}', ${idx})" class="absolute top-0 right-0 w-5 h-5 bg-red-500 text-white flex items-center justify-center text-[10px]"><i class="fas fa-times"></i></button>`;
                        grid.appendChild(item);
                    });
                    dropzone.appendChild(grid);
                }
            },

            removeFile: function (type, index) {
                _files[type].splice(index, 1);
                this.renderFileList(type);
                if (type === 'start') this._updateStartStatus();
            },

            submitForm: function (mode) {
                // 1. Validation
                var reporter = _isCustomReporter ? el('reporterOther').value : el('reporterSelect').value;
                if (!reporter) return UIManager.showToast("‡∏£‡∏∞‡∏ö‡∏∏‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô", "warning");

                // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏´‡∏•‡∏±‡∏Å‡∏ê‡∏≤‡∏ô Mono (‡∏õ‡∏£‡∏±‡∏ö Logic ‡πÉ‡∏´‡πâ‡∏¢‡∏∑‡∏î‡∏´‡∏¢‡∏∏‡πà‡∏ô: ‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 1 ‡∏≠‡∏¢‡πà‡∏≤‡∏á ‡πÑ‡∏°‡πà‡∏ß‡πà‡∏≤‡∏à‡∏∞ Auto ‡∏´‡∏£‡∏∑‡∏≠ Upload ‡πÄ‡∏≠‡∏á)
                // ‡∏ñ‡πâ‡∏≤‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö‡∏ó‡∏±‡πâ‡∏á‡∏Ñ‡∏π‡πà ‡πÉ‡∏´‡πâ‡πÅ‡∏¢‡∏Å if ‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÄ‡∏î‡∏¥‡∏° ‡πÅ‡∏ï‡πà‡∏ñ‡πâ‡∏≤‡πÄ‡∏≠‡∏≤‡πÅ‡∏Ñ‡πà‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÉ‡∏î‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏´‡∏ô‡∏∂‡πà‡∏á ‡πÉ‡∏´‡πâ‡πÉ‡∏ä‡πâ‡πÅ‡∏ö‡∏ö‡∏ô‡∏µ‡πâ:
                if (_autoMonoUrls.length === 0 && _files.mono.length === 0) {
                     return UIManager.showToast("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏°‡∏µ‡∏£‡∏π‡∏õ‡∏´‡∏•‡∏±‡∏Å‡∏ê‡∏≤‡∏ô Mono (‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ ‡∏´‡∏£‡∏∑‡∏≠ ‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏û‡∏¥‡πà‡∏°)", "warning");
                }

                // 2. Prepare UI
                var btn = el('btn-submit-report');
                btn.disabled = true; el('spin-btn-send').classList.remove('hidden');

                // 3. Gather Data
                var formData = {
                    date: el('inputDate').value,
                    reporter: reporter,
                    shift: el('shiftSelect').value,
                    chatTarget: el('chatTargetSelect').value,
                    ticketSummary: el('ticketSummary').value,
                    matchSummary: el('matchSummary').value,
                    matchTotal: el('matchTotalValue').value,
                    matchEnded: el('matchEndedValue').value,
                    transferReport: el('transferReport').value,
                    statusMono: el('statusMono') ? el('statusMono').value : "‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢", // ‡πÉ‡∏ä‡πâ‡∏Ñ‡πà‡∏≤‡∏à‡∏≤‡∏Å Dropdown ‡∏´‡∏£‡∏∑‡∏≠ Default
                    statusAis: el('statusAis') ? el('statusAis').value : "‡πÑ‡∏°‡πà‡∏°‡∏µ",
                    statusStart: el('statusStart') ? el('statusStart').value : "‡πÑ‡∏°‡πà‡∏°‡∏µ",
                    ticketStats: {
                        total: el('disp-ticket-total').innerText,
                        new: el('disp-ticket-new').innerText,
                        open: el('disp-ticket-backlog').innerText,
                        pending: 0,
                        resolved: el('disp-ticket-resolved').innerText,
                        closed: 0,
                        backlog: el('disp-ticket-backlog').innerText
                    },
                    proofImages: {},
                    autoStartUrls: _autoStartUrls,
                    autoMonoUrls: _autoMonoUrls,
                    isDraft: (mode === 'preview')
                };

                // 4. Image Compression Helper
                var compress = (file) => new Promise(res => {
                    var r = new FileReader(); r.readAsDataURL(file);
                    r.onload = e => {
                        var i = new Image(); i.src = e.target.result;
                        i.onload = () => {
                            var c = document.createElement('canvas'); var ctx = c.getContext('2d');
                            var m = 1000, w = i.width, h = i.height;
                            if (w > h && w > m) { h *= m / w; w = m } else if (h > m) { w *= m / h; h = m }
                            c.width = w; c.height = h; ctx.drawImage(i, 0, 0, w, h);
                            res(c.toDataURL('image/jpeg', 0.8).split(',')[1]);
                        }
                    }
                });

                // 5. Process & Send
                (async () => {
                    try {
                        if (mode !== 'preview') {
                            if (_files.mono.length) formData.proofImages.mono = await Promise.all(_files.mono.map(compress));
                            if (_files.ais.length) formData.proofImages.ais = await Promise.all(_files.ais.map(compress));
                            if (_files.start.length) formData.proofImages.start = await Promise.all(_files.start.map(compress));
                        }
                        
                        var res = await Server.call({ func: 'processShiftReport' }, formData);
                        
                        if (res && res.success) {
                            if (res.isPreview) {
                                el('chatPreviewText').innerText = res.chatPreview;
                                el('preview_modal').showModal();
                            } else {
                                Swal.fire({
                                    icon: 'success',
                                    title: '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à',
                                    text: '‡∏£‡∏∞‡∏ö‡∏ö‡πÑ‡∏î‡πâ‡∏™‡πà‡∏á‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß',
                                    timer: 1500,
                                    showConfirmButton: false
                                }).then(() => {
                                    // üî• FULL RESET LOGIC Starts Here üî•
                                    
                                    // 1. Reset ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏õ‡πá‡∏ô‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô (‡πÄ‡∏ú‡∏∑‡πà‡∏≠ User ‡∏•‡∏∑‡∏°‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏Å‡∏•‡∏±‡∏ö)
                                    var today = new Date();
                                    var yyyy = today.getFullYear();
                                    var mm = String(today.getMonth() + 1).padStart(2, '0');
                                    var dd = String(today.getDate()).padStart(2, '0');
                                    if(el('inputDate')) {
                                        el('inputDate').value = `${yyyy}-${mm}-${dd}`;
                                        if(typeof _picker !== 'undefined') _picker.setDate(today);
                                    }

                                    // 2. Clear Text Inputs
                                    if (el('transferReport')) el('transferReport').value = "";
                                    
                                    // 3. Reset Status Dropdowns to Default
                                    if (el('statusMono')) el('statusMono').value = "‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢";
                                    if (el('statusAis')) el('statusAis').value = "‡πÑ‡∏°‡πà‡∏°‡∏µ";
                                    if (el('statusStart')) el('statusStart').value = "‡πÑ‡∏°‡πà‡∏°‡∏µ";

                                    // 4. üî• ‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç: ‡∏™‡∏±‡πà‡∏á‡∏ã‡πà‡∏≠‡∏ô‡∏Å‡∏•‡πà‡∏≠‡∏á‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏ï‡∏≤‡∏°‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÉ‡∏´‡∏°‡πà (Clean UI)
                                    ReportManager.toggleStartArea('‡πÑ‡∏°‡πà‡∏°‡∏µ');
                                    ReportManager.toggleAisActions('‡πÑ‡∏°‡πà‡∏°‡∏µ');

                                    // 5. Reset File Arrays & Variables
                                    _files = { mono: [], ais: [], start: [] };
                                    _autoStartUrls = [];
                                    _autoMonoUrls = [];

                                    // 6. Clear Rendered Lists (‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠)
                                    ReportManager.renderFileList('mono');
                                    ReportManager.renderFileList('ais');
                                    ReportManager.renderFileList('start');

                                    if (el('auto-start-list')) el('auto-start-list').innerHTML = '';
                                    show('auto-start-images', false);

                                    if (el('auto-mono-list')) el('auto-mono-list').innerHTML = '';
                                    show('auto-mono-images', false);
                                    
                                    // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏£‡∏π‡∏õ (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ô‡∏µ‡πâ)
                                    if (typeof ReportManager.updateImageCounts === 'function') {
                                        ReportManager.updateImageCounts();
                                    }

                                    // 7. Close Preview Modal (‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡∏¥‡∏î‡∏Ñ‡πâ‡∏≤‡∏á‡πÑ‡∏ß‡πâ)
                                    if (el('preview_modal')) el('preview_modal').close();

                                    // 8. ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• Ticket/Match ‡πÉ‡∏´‡∏°‡πà‡∏Ç‡∏≠‡∏á "‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ" ‡∏°‡∏≤‡πÅ‡∏™‡∏î‡∏á
                                    ReportManager.autoFetchAll();
                                });
                            }
                        } else UIManager.showToast(res ? res.error : "Unknown Error", "error");
                    } catch (e) { UIManager.showToast(e.message, "error"); }
                    finally { btn.disabled = false; el('spin-btn-send').classList.add('hidden'); }
                })();
            },

            showTicketInfo: function () {
                Swal.fire({
                    title: '‡∏´‡∏•‡∏±‡∏Å‡∏Å‡∏≤‡∏£‡∏ô‡∏±‡∏ö Ticket',
                    html: '<div style="text-align:left;font-size:12px;line-height:1.7">' +
                        '<div style="background:#ecfdf5;padding:10px 12px;border-radius:8px;border:1px solid #bbf7d0;margin-bottom:8px">' +
                        '<b style="color:#15803d">üü¢ ‡∏á‡∏≤‡∏ô‡πÄ‡∏Ç‡πâ‡∏≤‡πÉ‡∏´‡∏°‡πà</b><br>' +
                        '<span style="color:#16a34a">Ticket ‡∏ó‡∏µ‡πà <u>‡∏™‡∏£‡πâ‡∏≤‡∏á</u> ‡πÉ‡∏ô‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å</span></div>' +
                        '<div style="background:#eff6ff;padding:10px 12px;border-radius:8px;border:1px solid #bfdbfe;margin-bottom:8px">' +
                        '<b style="color:#1d4ed8">üîµ ‡∏õ‡∏¥‡∏î‡πÑ‡∏î‡πâ</b><br>' +
                        '<span style="color:#2563eb">Ticket ‡∏ó‡∏µ‡πà <u>‡∏õ‡∏¥‡∏î‡∏á‡∏≤‡∏ô</u> ‡πÉ‡∏ô‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å (‡∏£‡∏ß‡∏°‡∏á‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤‡∏á‡πÄ‡∏Å‡πà‡∏≤‡∏ó‡∏µ‡πà‡∏°‡∏≤‡∏õ‡∏¥‡∏î‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ)</span></div>' +
                        '<div style="background:#fef2f2;padding:10px 12px;border-radius:8px;border:1px solid #fecaca">' +
                        '<b style="color:#b91c1c">üî¥ ‡∏á‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤‡∏á</b><br>' +
                        '<span style="color:#dc2626">Ticket ‡∏ó‡∏µ‡πà‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ <u>‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏õ‡∏¥‡∏î</u> ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î (‡∏ô‡∏±‡∏ö‡∏£‡∏ß‡∏°‡∏ó‡∏∏‡∏Å‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà)</span></div></div>',
                    icon: 'info',
                    confirmButtonText: '‡πÄ‡∏Ç‡πâ‡∏≤‡πÉ‡∏à‡πÅ‡∏•‡πâ‡∏ß üëç',
                    heightAuto: false,
                    scrollbarPadding: false
                });
            },

            showMatchInfo: function () {
                Swal.fire({
                    title: '‡∏´‡∏•‡∏±‡∏Å‡∏Å‡∏≤‡∏£‡∏ô‡∏±‡∏ö Match',
                    html: '<div style="text-align:left;font-size:12px;line-height:1.7">' +
                        '<div style="background:#ecfdf5;padding:10px 12px;border-radius:8px;border:1px solid #bbf7d0;margin-bottom:8px">' +
                        '<b style="color:#15803d">üïí ‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤ (Shift)</b><br>' +
                        '<span style="color:#16a34a">‡∏ô‡∏±‡∏ö‡∏ï‡∏±‡πâ‡∏á‡πÅ‡∏ï‡πà <u>10:00 (‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏ß‡∏≤‡∏ô)</u> ‡∏ñ‡∏∂‡∏á <u>09:59 (‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ)</u></span></div>' +
                        '<div style="background:#eff6ff;padding:10px 12px;border-radius:8px;border:1px solid #bfdbfe;margin-bottom:8px">' +
                        '<b style="color:#1d4ed8">üìä ‡πÅ‡∏´‡∏•‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</b><br>' +
                        '<span style="color:#2563eb">‡∏ï‡πâ‡∏≠‡∏á‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö‡∏ï‡∏≤‡∏£‡∏≤‡∏á <u>DB_Matches</u> ‡πÉ‡∏ô Google Sheet ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô</span></div>' +
                        '<div style="background:#fef2f2;padding:10px 12px;border-radius:8px;border:1px solid #fecaca">' +
                        '<b style="color:#b91c1c">‚úÖ ‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö</b><br>' +
                        '<span style="color:#dc2626">‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ‡∏´‡∏•‡∏±‡∏Å‡∏ê‡∏≤‡∏ô <u>Start</u> ‡∏´‡∏£‡∏∑‡∏≠ <u>Stop</u> ‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 1 ‡∏≠‡∏¢‡πà‡∏≤‡∏á</span></div></div>',
                    icon: 'info',
                    confirmButtonText: '‡πÄ‡∏Ç‡πâ‡∏≤‡πÉ‡∏à‡πÅ‡∏•‡πâ‡∏ß üëç',
                    heightAuto: false,
                    scrollbarPadding: false
                });
            },

            // Helpers
            handleReporterChange: function (v) {
                var isO = v === 'OTHER'; _isCustomReporter = isO; show('wrapper-reporter-other', isO);
                if (isO) setTimeout(() => el('reporterOther').focus(), 100);
            },
            resetReporter: function () { el('reporterSelect').value = ''; el('reporterOther').value = ''; show('wrapper-reporter-other', false); },
            toggleStartArea: function (v) {
                var hasCandidates = el('auto-start-list') && el('auto-start-list').children.length > 0;
                show('start-upload-area', v !== '‡πÑ‡∏°‡πà‡∏°‡∏µ' || hasCandidates);
            },
            toggleAisActions: function (v) { show('proof-ais-box', v !== '‡πÑ‡∏°‡πà‡∏°‡∏µ'); },
            confirmSend: function () { el('preview_modal').close(); this.submitForm('send'); },
            setupPasteHandlers: function () {
                ['mono', 'ais', 'start'].forEach(type => {
                    var dz = el('dropzone-' + type);
                    if (dz && !dz.hasAttribute('data-listening')) {
                        dz.addEventListener('paste', (e) => {
                            var items = (e.clipboardData || e.originalEvent.clipboardData).items;
                            for (var i = 0; i < items.length; i++) {
                                if (items[i].type.indexOf("image") !== -1) {
                                    var blob = items[i].getAsFile();
                                    _files[type].push(blob);
                                    ReportManager.renderFileList(type);
                                    if (typeof UIManager !== 'undefined') UIManager.showToast("‡∏ß‡∏≤‡∏á‡∏£‡∏π‡∏õ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢ ‚úÖ", "success");
                                    e.preventDefault();
                                    return;
                                }
                            }
                        });
                        dz.setAttribute('data-listening', 'true');
                    }
                });
            }
        };
    })();

    if (window.ReportManager) {
        window.ReportManager.init();
    }
</script>