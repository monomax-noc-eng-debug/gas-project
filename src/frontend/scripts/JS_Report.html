<script>
  /**
   * JS_Report.html
   * Logic ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤ Shift Report
   * Updated: ‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö Ticket Table Layout
   */
  var Report = {
    proofFiles: { mono: [], ais: [], start: [] },

    init: function() {
      console.log("Report Module Initialized");
    },

    // --- UI Interactions ---

    checkReporterOther: function() {
      var val = document.getElementById('reporterSelect').value;
      var other = document.getElementById('reporterOther');
      if (val === '‡∏≠‡∏∑‡πà‡∏ô‡πÜ') {
        other.classList.remove('hidden');
        other.focus();
      } else {
        other.classList.add('hidden');
      }
    },

    toggleUploadSection: function(selectId, divId, fileType) {
      var val = document.getElementById(selectId).value;
      var div = document.getElementById(divId);
      if (val === '‡πÑ‡∏°‡πà‡∏°‡∏µ') {
        div.classList.add('hidden');
        this.proofFiles[fileType] = [];
        this.updateFileListUi(fileType, fileType + 'FileList');
      } else {
        div.classList.remove('hidden');
      }
    },

    // --- Image Processing ---

    compressImage: function(file) {
      var MAX_DIMENSION = 1600;
      var QUALITY = 0.8;
      
      return new Promise(function(resolve) {
        var reader = new FileReader();
        reader.readAsDataURL(file);
        reader.onload = function(e) {
          var img = new Image();
          img.src = e.target.result;
          img.onload = function() {
            var width = img.width;
            var height = img.height;
            if (width > height) {
              if (width > MAX_DIMENSION) { height *= MAX_DIMENSION / width; width = MAX_DIMENSION; }
            } else {
              if (height > MAX_DIMENSION) { width *= MAX_DIMENSION / height; height = MAX_DIMENSION; }
            }
            var canvas = document.createElement('canvas');
            canvas.width = width;
            canvas.height = height;
            var ctx = canvas.getContext('2d');
            ctx.drawImage(img, 0, 0, width, height);
            resolve({
              data: canvas.toDataURL('image/jpeg', QUALITY).split(',')[1],
              mimeType: 'image/jpeg'
            });
          };
        };
      });
    },

    handleFilesUpload: function(inputId, listId) {
      var input = document.getElementById(inputId);
      var type = inputId.replace('file', '').toLowerCase();
      if (input.files && input.files.length > 0) {
        var newFiles = Array.from(input.files);
        this.proofFiles[type] = this.proofFiles[type].concat(newFiles);
        this.updateFileListUi(type, listId);
        if(typeof UIManager !== 'undefined') UIManager.showToast('‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û ' + newFiles.length + ' ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£', 'success');
      }
      input.value = '';
    },

    pasteImage: function(type, listId) {
      var self = this;
      if (!navigator.clipboard) {
         if(typeof UIManager !== 'undefined') UIManager.showToast("Browser ‡πÑ‡∏°‡πà‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö Clipboard API", 'error');
         return;
      }
      navigator.clipboard.read().then(function(items) {
        var found = false;
        for (var i = 0; i < items.length; i++) {
          var item = items[i];
          var imgTypes = item.types.filter(function(t) { return t.startsWith('image/'); });
          if (imgTypes.length > 0) {
            item.getType(imgTypes[0]).then(function(blob) {
               var file = new File([blob], 'Pasted_' + Date.now() + '.png', { type: imgTypes[0] });
               self.proofFiles[type].push(file);
               self.updateFileListUi(type, listId);
               if(typeof UIManager !== 'undefined') UIManager.showToast("‡∏ß‡∏≤‡∏á‡∏£‡∏π‡∏õ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢", 'success');
            });
            found = true;
            return;
          }
        }
        if (!found && typeof UIManager !== 'undefined') UIManager.showToast("‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏£‡∏π‡∏õ‡πÉ‡∏ô Clipboard", 'warning');
      }).catch(function(err) {
        if(typeof UIManager !== 'undefined') UIManager.showToast("‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á Clipboard ‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ", 'error');
      });
    },

    updateFileListUi: function(type, listId) {
      var container = document.getElementById(listId);
      container.innerHTML = '';
      var self = this;
      this.proofFiles[type].forEach(function(file, index) {
        var div = document.createElement('div');
        div.className = 'flex items-center justify-between bg-base-100 border border-base-300 px-3 py-2 rounded-lg mb-1 shadow-sm';
        var html = '';
        html += '<span class="truncate pr-4 font-mono">' + file.name + '</span>';
        html += '<button type="button" onclick="Report.removeFile(\'' + type + '\', ' + index + ', \'' + listId + '\')" class="btn btn-xs btn-square btn-ghost text-error">';
        html +=   '<i class="fas fa-times"></i>';
        html += '</button>';
        div.innerHTML = html;
        container.appendChild(div);
      });
    },

    removeFile: function(type, index, listId) {
      this.proofFiles[type].splice(index, 1);
      this.updateFileListUi(type, listId);
    },

    // --- Data Fetching (Updated for Table Layout) ---

    // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• Ticket ‡πÅ‡∏•‡∏∞‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡πÉ‡∏ô Table
    autoFetchTicket: function(btn) {
      // 1. ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏´‡∏£‡∏∑‡∏≠‡∏¢‡∏±‡∏á
      var d = document.getElementById('inputDate').value;
      if (!d) return UIManager.showToast("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏Å‡πà‡∏≠‡∏ô", 'warning');

      // 2. ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏õ‡∏∏‡πà‡∏° (Loading State)
      var originalText = btn.innerHTML;
      btn.disabled = true;
      btn.innerHTML = '<span class="loading loading-spinner loading-xs"></span>';

      // 3. ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡πÉ‡∏ä‡πâ Server Function
      google.script.run
        .withSuccessHandler(function(resStr) {
          // ‡∏Ñ‡∏∑‡∏ô‡∏Ñ‡πà‡∏≤‡∏õ‡∏∏‡πà‡∏°‡∏Å‡∏•‡∏±‡∏ö‡∏™‡∏π‡πà‡∏õ‡∏Å‡∏ï‡∏¥
          btn.disabled = false;
          btn.innerHTML = originalText;
          
          // ‡πÅ‡∏õ‡∏•‡∏á JSON String ‡∏Å‡∏•‡∏±‡∏ö‡πÄ‡∏õ‡πá‡∏ô Object
          var res = JSON.parse(resStr);

          // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö Error ‡∏à‡∏≤‡∏Å‡∏ù‡∏±‡πà‡∏á Server
          if (!res.success) {
              UIManager.showToast("Error: " + res.error, 'error');
              return;
          }

          // ------------------------------------------------
          // ‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà 1: ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥ (Stats Cards)
          // ------------------------------------------------
          var stats = res.stats || {};
          var statKeys = ['total', 'open', 'pending', 'resolved', 'closed'];
          
          statKeys.forEach(function(key) {
             // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Ñ‡πà‡∏≤‡∏•‡∏á‡πÉ‡∏ô Hidden Input (‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Submit Form)
             var inputId = 'ticket' + key.charAt(0).toUpperCase() + key.slice(1);
             var inputEl = document.getElementById(inputId);
             if(inputEl) inputEl.value = stats[key] || 0;
             
             // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡πÅ‡∏™‡∏î‡∏á‡∏ö‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠
             var dispId = 'disp-ticket-' + key;
             var dispEl = document.getElementById(dispId);
             if(dispEl) dispEl.innerText = stats[key] || 0;
          });

          // ------------------------------------------------
          // ‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà 2: ‡πÄ‡∏Å‡πá‡∏ö Text Summary ‡πÑ‡∏ß‡πâ (‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö PDF/Preview)
          // ------------------------------------------------
          document.getElementById('ticketSummary').value = res.text; 

          // ------------------------------------------------
          // ‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà 3: ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÅ‡∏ñ‡∏ß‡∏ï‡∏≤‡∏£‡∏≤‡∏á (Table Rows) ‡∏à‡∏≤‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ List
          // ------------------------------------------------
          var tableBody = document.getElementById('ticketTableBody');
          tableBody.innerHTML = ""; // ‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏Å‡πà‡∏≤‡∏≠‡∏≠‡∏Å‡∏Å‡πà‡∏≠‡∏ô

          if (res.list && res.list.length > 0) {
            
            res.list.forEach(function(item) {
              // item ‡∏à‡∏∞‡∏°‡∏µ‡πÇ‡∏Ñ‡∏£‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á { id: "...", status: "...", detail: "..." }
              
              // ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏™‡∏µ Badge ‡∏ï‡∏≤‡∏°‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞
              var badgeClass = "badge-ghost";
              if (item.status === 'OPEN') badgeClass = "badge-info";
              else if (item.status === 'PENDING') badgeClass = "badge-warning";
              else if (item.status === 'RESOLVED') badgeClass = "badge-success";
              else if (item.status === 'CLOSED') badgeClass = "badge-neutral";

              // ‡∏™‡∏£‡πâ‡∏≤‡∏á HTML ‡∏Ç‡∏≠‡∏á‡πÅ‡∏ñ‡∏ß
              var row = '<tr class="hover">';
              // Col 1: Status Badge
              row += '<td class="text-center"><div class="badge ' + badgeClass + ' badge-sm font-bold text-[10px] w-20">' + item.status + '</div></td>';
              // Col 2: Ticket ID
              row += '<td class="font-mono text-xs font-semibold whitespace-nowrap">' + item.id + '</td>';
              // Col 3: Detail
              row += '<td class="text-xs min-w-[200px]">' + item.detail + '</td>';
              row += '</tr>';
              
              // ‡πÅ‡∏ó‡∏£‡∏Å‡πÅ‡∏ñ‡∏ß‡∏•‡∏á‡πÉ‡∏ô‡∏ï‡∏≤‡∏£‡∏≤‡∏á
              tableBody.insertAdjacentHTML('beforeend', row);
            });

          } else {
            // ‡∏Å‡∏£‡∏ì‡∏µ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
            tableBody.innerHTML = '<tr><td colspan="3" class="text-center py-8 text-base-content/50">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• Ticket ‡πÉ‡∏ô‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡∏ô‡∏µ‡πâ</td></tr>';
          }

          // ‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à
          UIManager.showToast("‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢ (" + (stats.total || 0) + " ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£)", 'success');
        })
        .withFailureHandler(function(err) {
           // ‡∏Å‡∏£‡∏ì‡∏µ Server Error (Network ‡∏´‡∏•‡∏∏‡∏î ‡∏´‡∏£‡∏∑‡∏≠ Script ‡∏û‡∏±‡∏á)
           btn.disabled = false;
           btn.innerHTML = originalText;
           UIManager.showToast("Server Error: " + err.message, 'error');
           console.error("Fetch Error:", err);
        })
        .getTicketDetails(d); // ‡∏ä‡∏∑‡πà‡∏≠‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ù‡∏±‡πà‡∏á Server (Code.gs)
    },

    autoFetchMatch: function(btn) {
      var d = document.getElementById('inputDate').value;
      if (!d) return UIManager.showToast("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏Å‡πà‡∏≠‡∏ô", 'warning');

      var originalText = btn.innerHTML;
      btn.disabled = true;
      btn.innerHTML = '<span class="loading loading-spinner loading-xs"></span>';

      google.script.run
        .withSuccessHandler(function(resStr) {
           btn.disabled = false;
           btn.innerHTML = originalText;
           var res = JSON.parse(resStr);

          if (!res.success) {
              UIManager.showToast("Error: " + res.error, 'error');
              document.getElementById('matchSummary').value = "Error: " + res.error;
              return;
          }

          // 1. Update Hidden Inputs & Textarea
          document.getElementById('matchSummary').value = res.text;
          document.getElementById('matchDataJSON').value = JSON.stringify(res.data);
          document.getElementById('matchTotal').value = res.total;
          
          // Update Total Display (‡πÄ‡∏ú‡∏∑‡πà‡∏≠‡πÉ‡∏ä‡πâ ID ‡∏ô‡∏µ‡πâ‡∏ó‡∏µ‡πà‡∏≠‡∏∑‡πà‡∏ô)
          var dispTotal = document.getElementById('disp-match-total');
          if(dispTotal) dispTotal.innerText = res.total || 0;

          // 2. üö© ‡∏™‡∏£‡πâ‡∏≤‡∏á Dynamic Cards ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏•‡∏µ‡∏Å
          var container = document.getElementById('match-stats-container');
          var html = '';

          // Card 1: Total Matches (‡∏™‡∏µ‡πÄ‡∏ó‡∏≤‡πÄ‡∏Ç‡πâ‡∏° ‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô Ticket Total)
          html += '<div class="flex flex-col items-center p-2 bg-base-200 rounded-lg border border-base-300 shadow-sm">';
          html +=   '<span class="text-[10px] font-bold uppercase opacity-60">Total</span>';
          html +=   '<span class="text-lg font-black">' + (res.total || 0) + '</span>';
          html += '</div>';

          // Loop ‡∏™‡∏£‡πâ‡∏≤‡∏á Card ‡∏ï‡∏≤‡∏°‡∏•‡∏µ‡∏Å‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏Ñ‡πà‡∏≤ > 0
          if (res.data && Object.keys(res.data).length > 0) {
            var hasLeagues = false;
            
            Object.keys(res.data).forEach(function(leagueName) {
               var count = res.data[leagueName];
               
               // üö© ‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç: ‡πÅ‡∏™‡∏î‡∏á‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏•‡∏µ‡∏Å‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô > 0
               if (count > 0) {
                   hasLeagues = true;
                   
                   // ‡∏™‡πÑ‡∏ï‡∏•‡πå Card ‡πÅ‡∏ö‡∏ö‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ö Ticket Status ‡πÅ‡∏ï‡πà‡πÉ‡∏ä‡πâ‡πÇ‡∏ó‡∏ô‡∏™‡∏µ‡∏Å‡∏•‡∏≤‡∏á‡πÜ ‡∏´‡∏£‡∏∑‡∏≠‡∏™‡∏µ‡∏ü‡πâ‡∏≤‡∏≠‡πà‡∏≠‡∏ô
                   html += '<div class="flex flex-col items-center p-2 bg-white rounded-lg border border-base-200 shadow-sm hover:border-info/50 transition-colors">';
                   // ‡∏ï‡∏±‡∏î‡∏Ñ‡∏≥‡∏ä‡∏∑‡πà‡∏≠‡∏•‡∏µ‡∏Å‡∏ñ‡πâ‡∏≤‡∏™‡∏±‡πâ‡∏ô‡πÜ ‡πÉ‡∏´‡πâ‡πÅ‡∏™‡∏î‡∏á‡πÄ‡∏ï‡πá‡∏° ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÉ‡∏´‡πâ‡πÅ‡∏™‡∏î‡∏á‡∏ä‡∏∑‡πà‡∏≠‡∏õ‡∏Å‡∏ï‡∏¥
                   html +=   '<span class="text-[10px] font-bold uppercase text-info text-center truncate w-full" title="' + leagueName + '">' + leagueName + '</span>';
                   html +=   '<span class="text-lg font-black text-base-content">' + count + '</span>';
                   html += '</div>';
               }
            });

            // ‡∏Å‡∏£‡∏ì‡∏µ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏°‡∏≤‡πÅ‡∏ï‡πà‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ñ‡∏π‡πà‡πÅ‡∏Ç‡πà‡∏á‡πÄ‡∏•‡∏¢ (Count 0 ‡∏ó‡∏∏‡∏Å‡∏ï‡∏±‡∏ß)
            if (!hasLeagues && res.total === 0) {
                html += '<div class="col-span-2 md:col-span-3 flex items-center justify-center p-2 text-xs text-base-content/50 border border-dashed rounded-lg">';
                html +=   'No matches found for this date';
                html += '</div>';
            }
          }

          container.innerHTML = html;
          UIManager.showToast("‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï Match ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢ (" + res.total + " ‡∏Ñ‡∏π‡πà)", 'success');
        })
        .withFailureHandler(function(err) {
           btn.disabled = false;
           btn.innerHTML = originalText;
           UIManager.showToast(err.message, 'error');
        })
        .getMatchesByDate(d);
    },

    // --- Form Submission ---

    submitForm: function(e, mode) {
      if (e) e.preventDefault();
      var form = document.getElementById('mainForm');
      if(!mode) mode = 'send';

      if (!form.checkValidity()) return form.reportValidity();
      if (this.proofFiles.mono.length === 0) {
          UIManager.showToast("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÅ‡∏ô‡∏ö‡∏£‡∏π‡∏õ Mono ‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 1 ‡∏£‡∏π‡∏õ", 'warning');
          return;
      }

      UIManager.showLoading();
      var self = this;

      var reporterVal = form.reporter.value;
      if(reporterVal === '‡∏≠‡∏∑‡πà‡∏ô‡πÜ') reporterVal = document.getElementById('reporterOther').value;

      var formData = {
        date: form.date.value,
        reporter: reporterVal,
        shift: form.shift.value,
        ticketSummary: document.getElementById('ticketSummary').value, // ‡πÄ‡∏≠‡∏≤‡∏Ñ‡πà‡∏≤‡∏à‡∏≤‡∏Å Hidden
        ticketStats: {
          total: document.getElementById('ticketTotal').value,
          open: document.getElementById('ticketOpen').value,
          pending: document.getElementById('ticketPending').value,
          resolved: document.getElementById('ticketResolved').value,
          closed: document.getElementById('ticketClosed').value
        },
        ticketDetails: document.getElementById('ticketDetailsRaw').value,
        matchSummary: form.matchSummary.value,
        matchTotal: document.getElementById('matchTotal').value,
        matchData: JSON.parse(document.getElementById('matchDataJSON').value || "{}"),
        transferReport: form.transferReport.value,
        statusMono: document.getElementById('statusMono').value,
        statusAis: document.getElementById('statusAis').value,
        statusStart: document.getElementById('statusStart').value,
        chatTarget: form.chatTarget.value,
        proofImages: {},
        isDraft: (mode === 'preview')
      };

      var promises = [];
      if (this.proofFiles.mono.length > 0) {
         var pMono = Promise.all(this.proofFiles.mono.map(function(f) { return self.compressImage(f); }))
            .then(function(res) { formData.proofImages.mono = res; });
         promises.push(pMono);
      }
      if (this.proofFiles.ais.length > 0) {
         var pAis = Promise.all(this.proofFiles.ais.map(function(f) { return self.compressImage(f); }))
            .then(function(res) { formData.proofImages.ais = res; });
         promises.push(pAis);
      }
      if (this.proofFiles.start.length > 0) {
         var pStart = Promise.all(this.proofFiles.start.map(function(f) { return self.compressImage(f); }))
            .then(function(res) { formData.proofImages.start = res; });
         promises.push(pStart);
      }

      Promise.all(promises).then(function() {
          if (typeof google === 'undefined' || !google.script) {
              UIManager.hideLoading();
              UIManager.showToast("Google Script Environment not found", 'error');
              return;
          }

          google.script.run
            .withSuccessHandler(function(resStr) {
              UIManager.hideLoading();
              var res = JSON.parse(resStr); 

              if (res.success) {
                if (res.isPreview) {
                  self.showPreviewModal(res.pdfUrl, res.chatPreview);
                } else {
                  UIManager.showToast("‡∏™‡πà‡∏á‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß!", 'success');
                  form.reset();
                  self.proofFiles = { mono: [], ais: [], start: [] };
                  self.updateFileListUi('mono', 'monoFileList');
                  self.updateFileListUi('ais', 'aisFileList');
                  self.updateFileListUi('start', 'startFileList');
                  
                  // ‡∏•‡πâ‡∏≤‡∏á Table ‡πÅ‡∏•‡∏∞ Stats
                  document.getElementById('ticketTableBody').innerHTML = '<tr><td colspan="3" class="text-center py-8 text-base-content/50">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• (‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏î‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•)</td></tr>';
                  ['total','open','pending','resolved','closed'].forEach(k => {
                     document.getElementById('disp-ticket-'+k).innerText = '-';
                  });

                  if (typeof Router !== 'undefined') {
                    setTimeout(function() { Router.navigateTo('page-history'); }, 1000);
                  }
                }
              } else {
                UIManager.showToast("Error: " + res.error, 'error');
              }
            })
            .withFailureHandler(function(err) {
              UIManager.hideLoading();
              UIManager.showToast("Server Failed: " + err.message, 'error');
            })
            .processForm(formData); // ‡∏ä‡∏∑‡πà‡∏≠ Function ‡∏ù‡∏±‡πà‡∏á Server

      }).catch(function(err) {
          UIManager.hideLoading();
          UIManager.showToast("Client Error (Compress): " + err.message, 'error');
          console.error(err);
      });
    },

    showPreviewModal: function(url, chatText) {
      document.getElementById('previewLink').href = url;
      document.getElementById('chatPreviewText').textContent = chatText;
      document.getElementById('preview_modal').showModal();
    },

    confirmSend: function() {
      document.getElementById('preview_modal').close();
      this.submitForm(null, 'send');
    }
  };
</script>