<script>
    /**
     * JS_Report.html
     * Version: Final Stable (Correct Report Format & Logic)
     */
    window.ReportManager = (function () {
        var _files = { mono: [], ais: [], start: [] };
        var _autoStartUrls = [];
        var _isCustomReporter = false;
        var _picker = null;
        var _isLoading = false;

        var el = function (id) { return document.getElementById(id); };
        var show = function (id, visible) { var e = el(id); if (e) e.classList.toggle('hidden', !visible); };

        var formatDriveUrl = function (url) {
            if (!url) return "";
            if (url.startsWith('data:')) return url;
            try {
                var id = null;
                if (url.indexOf('/d/') !== -1) id = url.match(/\/d\/(.+?)(\/|$)/)[1];
                else if (url.indexOf('id=') !== -1) id = url.match(/id=([^&]+)/)[1];
                return id ? 'https://drive.google.com/thumbnail?id=' + id + '&sz=w1000' : url;
            } catch (e) { return url; }
        };

        return {
            init: function () {
                document.addEventListener('page-change', function (e) {
                    if (e.detail.pageId === 'page-report') ReportManager.onPageShow();
                });
            },

            onPageShow: function () {
                if (!_picker) {
                    var input = el('inputDate');
                    if (input) {
                        var today = new Date();
                        var yyyy = today.getFullYear();
                        var mm = String(today.getMonth() + 1).padStart(2, '0');
                        var dd = String(today.getDate()).padStart(2, '0');
                        input.value = `${yyyy}-${mm}-${dd}`;

                        _picker = new Pikaday({
                            field: input,
                            format: 'YYYY-MM-DD',
                            yearRange: [2020, 2030],
                            onSelect: function () { if (!_isLoading) ReportManager.autoFetchAll(); }
                        });
                        setTimeout(function () { ReportManager.autoFetchAll(); }, 300);
                    }
                }
            },

            openDatePicker: function () {
                if (_picker) { _picker.show(); }
                else { var input = el('inputDate'); if (input) input.focus(); }
            },

            autoFetchAll: function () {
                if (_isLoading) return;
                var dateVal = el('inputDate').value;
                if (!dateVal) return;

                var self = this;
                self._setLoading(true);

                Promise.all([
                    self.fetchTickets(),
                    self.fetchMatches(),
                    self.fetchStartImages()
                ]).then(function () {
                    if (typeof UIManager !== 'undefined') UIManager.showToast("อัปเดตข้อมูลเรียบร้อย", "success");
                }).catch(function (err) {
                    console.error("Fetch Error:", err);
                }).finally(function () {
                    self._setLoading(false);
                });
            },

            _setLoading: function (loading) {
                _isLoading = loading;
                var btn = el('btn-load-data');
                var input = el('inputDate');
                if (input) input.disabled = loading;
                if (btn) {
                    btn.disabled = loading;
                    btn.innerHTML = loading ? '<span class="loading loading-spinner"></span>' : '<i class="fas fa-sync-alt"></i> โหลดข้อมูล';
                }
            },

            fetchTickets: function () {
                var dateVal = el('inputDate').value;
                show('loader-ticket', true);
                show('empty-ticket', false);
                el('disp-ticket-tbody').innerHTML = '';

                return Server.call({ func: 'getTicketDetails', silent: true }, dateVal)
                    .then(function (res) {
                        if (res && res.success) {
                            ['total', 'new', 'open', 'pending', 'resolved', 'closed'].forEach(k => {
                                if (el('disp-ticket-' + k)) el('disp-ticket-' + k).innerText = res.stats[k] || 0;
                            });
                            el('ticketSummary').value = res.text;

                            if (res.list && res.list.length > 0) {
                                var html = res.list.map(function (t) {
                                    var badgeClass = "badge-ghost";
                                    var s = t.status.toUpperCase();
                                    if (s.includes('OPEN')) badgeClass = "badge-error text-white";
                                    else if (s.includes('PENDING')) badgeClass = "badge-warning text-white";
                                    else if (s.includes('RESOLVED')) badgeClass = "badge-success text-white";
                                    else if (s.includes('CLOSE')) badgeClass = "badge-neutral text-white";

                                    var newBadge = t.isNew ? '<span class="badge badge-primary badge-xs ml-1 font-bold">NEW</span>' : '';

                                    return `<tr class="border-b border-gray-100 hover:bg-gray-50">
                                        <td class="font-mono font-bold text-center text-[10px] text-gray-500 w-24">${t.id}</td>
                                        <td class="text-center p-1 w-24">
                                            <div class="flex items-center justify-center">
                                                <span class="badge ${badgeClass} badge-xs font-bold whitespace-nowrap">${t.status}</span>
                                                ${newBadge}
                                            </div>
                                        </td>
                                        <td class="p-2">
                                            <div class="text-xs text-gray-700 truncate max-w-[250px]" title="${t.detail}">${t.detail}</div>
                                        </td>
                                    </tr>`;
                                }).join('');
                                el('disp-ticket-tbody').innerHTML = html;
                            } else { show('empty-ticket', true); }
                        }
                    })
                    .finally(() => show('loader-ticket', false));
            },

            fetchMatches: function () {
                var dateVal = el('inputDate').value;
                show('verify-loader', true);
                el('verification-tbody').innerHTML = '';

                // 1. Get Stats breakdown (API return data: { "Premier League": 2, ... })
                var p1 = Server.call({ func: 'getMatchesByDate', silent: true }, dateVal).then(res => {
                    if (res.success) {
                        // ✅ สร้าง Format สรุปสำหรับรายงาน (ตามตัวอย่างที่ขอ)
                        // SV League Volleyball: 11
                        // Premier League: 2
                        var summaryText = "";
                        var breakdownHtml = "";

                        if (res.data) {
                            for (var league in res.data) {
                                // Text for Report/Preview
                                summaryText += `${league}: ${res.data[league]}\n`;
                                // HTML Badge for UI
                                breakdownHtml += `<div class="badge badge-ghost badge-sm text-[10px] gap-1 whitespace-nowrap border-slate-200">
                                    ${league}: <span class="font-bold text-slate-700">${res.data[league]}</span>
                                </div>`;
                            }
                        }

                        // Set value to hidden input for submission
                        el('matchSummary').value = summaryText || "ไม่มีรายการแข่งขัน";

                        // Render Badges
                        var bd = el('league-breakdown');
                        if (bd) bd.innerHTML = breakdownHtml;
                    }
                });

                // 2. Get Verification Table
                var p2 = Server.call({ func: 'getVerificationReport', silent: true }, dateVal).then(res => {
                    if (res.success) {
                        el('matchTotalValue').value = res.data.stats.totalMatches;
                        if (el('disp-match-total')) el('disp-match-total').innerText = res.data.stats.totalMatches + " คู่";

                        var list = res.data.list || [];
                        if (list.length === 0) {
                            show('verify-empty', true);
                        } else {
                            show('verify-empty', false);
                            var html = list.map(item => {
                                var db = item.dashboard;
                                var hasEvidence = !!(db.startImg || db.stopImg);
                                var badge = hasEvidence
                                    ? '<div class="w-5 h-5 rounded-full bg-success/10 flex items-center justify-center mx-auto"><i class="fas fa-check text-success text-[10px]"></i></div>'
                                    : '<div class="w-5 h-5 rounded-full bg-base-200 flex items-center justify-center mx-auto"><i class="fas fa-times text-base-content/30 text-[10px]"></i></div>';

                                var imgBtn = (url, icon, color) => url
                                    ? `<a href="${formatDriveUrl(url)}" target="_blank" class="btn btn-xs btn-square btn-ghost text-${color}"><i class="fas ${icon}"></i></a>`
                                    : `<span class="text-gray-300 text-[10px]">-</span>`;

                                return `<tr class="border-b border-gray-100">
                                    <td class="font-mono text-[10px] text-center">${db.time}</td>
                                    <td class="text-xs">
                                        <div class="font-bold text-slate-700">${db.home} v ${db.away}</div>
                                        <div class="text-[9px] text-slate-400">${db.league}</div>
                                    </td>
                                    <td class="text-center">${imgBtn(db.startImg, 'fa-play-circle', 'success')}</td>
                                    <td class="text-center">${imgBtn(db.stopImg, 'fa-stop-circle', 'error')}</td>
                                    <td class="text-center">${badge}</td>
                                </tr>`;
                            }).join('');
                            el('verification-tbody').innerHTML = html;
                        }
                    }
                });

                return Promise.all([p1, p2]).finally(() => show('verify-loader', false));
            },

            fetchStartImages: function () {
                var dateVal = el('inputDate').value;

                // Reset Start List
                var autoStartList = el('auto-start-list');
                if (autoStartList) autoStartList.innerHTML = '';
                show('auto-start-images', false);
                _autoStartUrls = [];

                // Reset Mono (Stop) List
                var autoMonoList = el('auto-mono-list');
                if (autoMonoList) autoMonoList.innerHTML = '';
                show('auto-mono-images', false);
                ReportManager._autoMonoUrls = [];

                return Server.call({ func: 'getDailyProofImages', silent: true }, dateVal).then(res => {
                    if (res.success) {
                        // Render Start Images
                        if (res.data.start && res.data.start.length > 0) {
                            show('auto-start-images', true);
                            res.data.start.forEach(img => {
                                ReportManager._renderAutoImage(img, autoStartList, _autoStartUrls);
                            });
                        }

                        // Render Stop Images (for Mono)
                        if (res.data.stop && res.data.stop.length > 0) {
                            show('auto-mono-images', true);
                            res.data.stop.forEach(img => {
                                ReportManager._renderAutoImage(img, autoMonoList, ReportManager._autoMonoUrls);
                            });
                        }
                    }
                });
            },

            _renderAutoImage: function (img, container, urlArray) {
                var div = document.createElement('div');
                div.className = "relative group cursor-pointer border border-slate-200 rounded overflow-hidden w-12 h-12 flex-shrink-0 transition-all hover:shadow-md";
                div.innerHTML = `<img src="${formatDriveUrl(img.url)}" class="object-cover w-full h-full opacity-70 hover:opacity-100 transition-opacity">
                                 <div class="absolute inset-0 flex items-center justify-center bg-black/20 opacity-0 group-hover:opacity-100 text-white text-[10px] transition-opacity"><i class="fas fa-plus"></i></div>
                                 <div class="absolute bottom-0 left-0 right-0 bg-black/50 text-[8px] text-white truncate px-1 opacity-0 group-hover:opacity-100 transition-opacity">${img.label}</div>`;

                div.onclick = () => {
                    if (div.classList.contains('ring-2')) {
                        div.classList.remove('ring-2', 'ring-primary');
                        const idx = urlArray.indexOf(img.url);
                        if (idx > -1) urlArray.splice(idx, 1);
                    } else {
                        div.classList.add('ring-2', 'ring-primary');
                        urlArray.push(img.url);
                    }
                };
                container.appendChild(div);
            },

            handleFileUpload: function (input, type) {
                if (input.files.length > 0) {
                    _files[type] = _files[type].concat(Array.from(input.files));
                    this.renderFileList(type);
                }
            },

            triggerPaste: async function (type) {
                var areaId = 'paste-area-' + type;
                var area = el(areaId);
                try {
                    const items = await navigator.clipboard.read();
                    for (const item of items) {
                        const types = item.types.filter(t => t.startsWith('image/'));
                        for (const t of types) {
                            const blob = await item.getType(t);
                            const file = new File([blob], `pasted_${type}_${Date.now()}.png`, { type: t });
                            _files[type].push(file);
                            this.renderFileList(type);
                            if (typeof UIManager !== 'undefined') UIManager.showToast("วางรูปเรียบร้อย", "success");
                            return;
                        }
                    }
                    if (typeof UIManager !== 'undefined') UIManager.showToast("ไม่พบรูปภาพใน Clipboard", "warning");
                } catch (e) {
                    console.warn("Clipboard API Error:", e);
                    if (area) area.focus();
                    if (typeof UIManager !== 'undefined') UIManager.showToast("กด Ctrl+V เพื่อวางรูป (Fallback)", "info");
                }
            },

            setupPasteHandlers: function () {
                ['mono', 'ais', 'start'].forEach(type => {
                    var area = el('paste-area-' + type);
                    if (area && !area.hasAttribute('data-listening')) {
                        area.addEventListener('paste', (e) => {
                            var items = (e.clipboardData || e.originalEvent.clipboardData).items;
                            for (var i = 0; i < items.length; i++) {
                                if (items[i].type.indexOf("image") !== -1) {
                                    var blob = items[i].getAsFile();
                                    _files[type].push(blob);
                                    this.renderFileList(type);
                                    if (typeof UIManager !== 'undefined') UIManager.showToast("วางรูปเรียบร้อย", "success");
                                    e.preventDefault();
                                    return;
                                }
                            }
                        });
                        area.setAttribute('data-listening', 'true');
                    }
                });
            },

            renderFileList: function (type) {
                var listId = type + 'FileList';
                var container = el(listId);
                if (!container) return;

                container.innerHTML = '';
                _files[type].forEach((file, idx) => {
                    var div = document.createElement('div');
                    div.className = "flex justify-between items-center bg-white p-1.5 rounded border text-[10px] mb-1 shadow-sm";
                    div.innerHTML = `<span class="truncate w-32 text-slate-600">${file.name}</span>
                                     <button onclick="ReportManager.removeFile('${type}',${idx})" class="text-red-400 hover:text-red-600 hover:bg-red-50 p-0.5 rounded transition-colors"><i class="fas fa-times"></i></button>`;
                    container.appendChild(div);
                });

                var emptyId = type === 'mono' ? 'mono-empty' : (type === 'ais' ? 'ais-empty-upload' : null);
                if (emptyId) show(emptyId, _files[type].length === 0);
            },

            removeFile: function (type, index) {
                _files[type].splice(index, 1);
                this.renderFileList(type);
            },

            handleReporterChange: function (val) {
                var isOther = (val === 'OTHER');
                _isCustomReporter = isOther;
                show('wrapper-reporter-other', isOther);
                if (isOther) setTimeout(() => el('reporterOther').focus(), 100);
            },

            resetReporter: function () {
                el('reporterSelect').value = '';
                el('reporterOther').value = '';
                show('wrapper-reporter-other', false);
            },

            toggleAisActions: function (val) {
                var hasAis = (val !== 'ไม่มี');
                show('proof-ais-box', hasAis);
                show('ais-actions', hasAis);
            },

            submitForm: function (mode) {
                var reporter = _isCustomReporter ? el('reporterOther').value : el('reporterSelect').value;
                if (!reporter) return UIManager.showToast("ระบุชื่อผู้รายงาน", "warning");

                var hasMono = (_files.mono && _files.mono.length > 0) || (ReportManager._autoMonoUrls && ReportManager._autoMonoUrls.length > 0);
                if (!hasMono) return UIManager.showToast("กรุณาแนบรูป Mono หรือเลือกจาก Dashboard", "error");

                var btn = el('btn-submit-report');
                if (mode === 'send') { btn.disabled = true; el('spin-btn-send').classList.remove('hidden'); }

                var formData = {
                    date: el('inputDate').value,
                    reporter: reporter,
                    shift: el('shiftSelect').value,
                    chatTarget: el('chatTargetSelect').value,
                    ticketSummary: el('ticketSummary').value,
                    matchSummary: el('matchSummary').value, // ✅ This will be the Breakdown List (e.g. "SV League: 1")
                    matchTotal: el('matchTotalValue').value,
                    matchEnded: el('matchEndedValue').value,
                    transferReport: el('transferReport').value,
                    statusMono: "เรียบร้อย",
                    statusAis: el('statusAis').value,
                    statusStart: el('statusStart').value,
                    ticketStats: {
                        total: el('disp-ticket-total').innerText,
                        new: el('disp-ticket-new').innerText,
                        open: el('disp-ticket-open').innerText,
                        pending: el('disp-ticket-pending').innerText,
                        resolved: el('disp-ticket-resolved').innerText,
                        closed: el('disp-ticket-closed').innerText
                    },
                    proofImages: {},
                    autoStartUrls: _autoStartUrls,
                    autoMonoUrls: ReportManager._autoMonoUrls,
                    isDraft: (mode === 'preview')
                };

                var compress = (file) => new Promise(res => {
                    var r = new FileReader(); r.readAsDataURL(file);
                    r.onload = e => {
                        var i = new Image(); i.src = e.target.result;
                        i.onload = () => {
                            var c = document.createElement('canvas'); var ctx = c.getContext('2d');
                            var m = 1000, w = i.width, h = i.height;
                            if (w > h && w > m) { h *= m / w; w = m } else if (h > m) { w *= m / h; h = m }
                            c.width = w; c.height = h; ctx.drawImage(i, 0, 0, w, h);
                            res(c.toDataURL('image/jpeg', 0.7).split(',')[1]);
                        }
                    }
                });

                (async () => {
                    try {
                        if (mode !== 'preview') {
                            if (_files.mono.length) formData.proofImages.mono = await Promise.all(_files.mono.map(compress));
                            if (_files.ais.length) formData.proofImages.ais = await Promise.all(_files.ais.map(compress));
                            if (_files.start.length) formData.proofImages.start = await Promise.all(_files.start.map(compress));
                        }

                        // Add auto-selected images to proofImages if manually uploaded proofs are empty?
                        // Actually, the backend should handle autoStartUrls/autoMonoUrls separately or merge them.
                        // I'm sending them as separate fields in formData.

                        var res = await Server.call({ func: 'processShiftReport' }, formData);

                        if (res && res.success) {
                            if (res.isPreview) {
                                el('chatPreviewText').innerText = res.chatPreview;
                                el('preview_modal').showModal();
                            } else {
                                UIManager.showToast("ส่งรายงานสำเร็จ", "success");
                                _files = { mono: [], ais: [], start: [] };
                                _autoStartUrls = [];
                                ReportManager._autoMonoUrls = [];
                                this.renderFileList('mono');
                                this.renderFileList('ais');
                                this.renderFileList('start');
                                el('auto-start-list').innerHTML = ''; show('auto-start-images', false);
                                el('auto-mono-list').innerHTML = ''; show('auto-mono-images', false);
                                el('transferReport').value = "";
                            }
                        } else UIManager.showToast(res ? res.error : "Unknown Error", "error");
                    } catch (e) { UIManager.showToast(e.message, "error"); }
                    finally { btn.disabled = false; el('spin-btn-send').classList.add('hidden'); }
                })();
            },

            confirmSend: function () { el('preview_modal').close(); this.submitForm('send'); }
        };
    })();

    if (window.ReportManager) {
        window.ReportManager.init();
        setTimeout(() => window.ReportManager.setupPasteHandlers(), 1000);
    }
</script>