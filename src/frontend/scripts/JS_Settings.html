<script>
const SettingsManager = (() => {
  let _config = { types: [], statuses: [], severities: [], categories: {} };
  let _isLoaded = false;
  
  // เก็บสถานะว่ากำลังแก้อะไรอยู่
  let _editContext = null; // { type: 'list'|'cat'|'sub', key: '...', index: 0, oldVal: '...' }

  const el = id => document.getElementById(id);

  return {
    init: function() {},

    onShow: function() {
      if (!_isLoaded) this.loadSettings();
    },

    loadSettings: function(force = false) {
      UIManager.showLoading();
      Server.call('getTicketConfig')
        .then(res => {
          if (res.success) {
            _config = res.data || { types: [], statuses: [], severities: [], categories: {} };
            this.renderAll();
            _isLoaded = true;
            if (force) UIManager.showToast("รีเฟรชข้อมูลเรียบร้อย", "success");
          } else {
             UIManager.showToast(res.message, "error");
          }
        })
        .finally(() => UIManager.hideLoading());
    },

    saveSettings: function() {
      UIManager.showLoading();
      const payload = JSON.parse(JSON.stringify(_config));
      Server.call('saveTicketConfig', payload)
        .then(res => {
          if (res.success) UIManager.showToast("บันทึกสำเร็จ", "success");
          else UIManager.showToast(res.message, "error");
        })
        .catch(err => UIManager.showToast("Error: " + err, "error"))
        .finally(() => UIManager.hideLoading());
    },

    renderAll: function() {
      this.renderChips('statuses', 'badge-info');
      this.renderChips('types', 'badge-secondary');
      this.renderChips('severities', 'badge-error');
      this.renderCategories();
    },

    renderChips: function(key, colorClass) {
      const container = el(`list-${key}`);
      const list = _config[key] || [];
      const counter = el(`count-${key}`);
      if(counter) counter.innerText = list.length;
      container.innerHTML = '';

      list.forEach((item, index) => {
        const chip = document.createElement('div');
        chip.className = `badge ${colorClass} badge-outline gap-2 p-3 hover:bg-opacity-10 cursor-pointer group transition-all`;
        chip.innerHTML = `
          <span class="font-medium text-xs hover:underline" onclick="SettingsManager.editItem('${key}', ${index})" title="Click to edit">${item}</span>
          <button onclick="event.stopPropagation(); SettingsManager.deleteItem('${key}', ${index})" class="w-4 h-4 rounded-full hover:bg-black/10 flex items-center justify-center opacity-60 group-hover:opacity-100">
            <i class="fas fa-times text-[10px]"></i>
          </button>
        `;
        container.appendChild(chip);
      });
    },

    renderCategories: function() {
      const container = el('container-categories');
      container.innerHTML = '';
      const cats = Object.keys(_config.categories);
      
      if (cats.length === 0) {
        container.innerHTML = `<div class="text-center py-10 text-gray-300">No Categories</div>`; return;
      }

      cats.forEach(cat => {
        const subs = _config.categories[cat];
        const div = document.createElement('div');
        div.className = "collapse collapse-arrow bg-base-100 border border-base-200 shadow-sm rounded-lg mb-2";
        
        div.innerHTML = `
          <input type="checkbox" /> 
          <div class="collapse-title text-sm font-bold flex items-center justify-between pr-12 min-h-0 py-3">
             <div class="flex items-center gap-2 text-gray-700 w-full z-10">
               <i class="fas fa-folder text-warning/70"></i>
               <span class="hover:text-primary cursor-pointer hover:underline" onclick="event.preventDefault(); SettingsManager.editCategory('${cat}')" title="Rename Category">${cat}</span>
               <span class="badge badge-sm badge-ghost font-normal text-xs text-gray-400">${subs.length}</span>
             </div>
             <button onclick="event.preventDefault(); SettingsManager.deleteCategory('${cat}')" class="btn btn-xs btn-ghost text-gray-300 hover:text-error z-20">
               <i class="fas fa-trash"></i>
             </button>
          </div>
          <div class="collapse-content">
             <div class="pt-2 pl-6 pr-2 space-y-1">
               ${subs.map((sub, idx) => `
                 <div class="flex justify-between items-center group/sub px-3 py-1.5 rounded-md hover:bg-gray-50 text-xs text-gray-600">
                   <div class="flex items-center gap-2">
                     <div class="w-1.5 h-1.5 rounded-full bg-gray-300 group-hover/sub:bg-primary"></div>
                     <span class="cursor-pointer hover:text-primary hover:underline" onclick="SettingsManager.editSub('${cat}', ${idx})" title="Rename Subcategory">${sub}</span>
                   </div>
                   <button onclick="SettingsManager.deleteSub('${cat}', ${idx})" class="text-gray-300 hover:text-error opacity-0 group-hover/sub:opacity-100">
                     <i class="fas fa-times"></i>
                   </button>
                 </div>
               `).join('')}
               <div class="mt-3 pl-3 pr-1 flex gap-2">
                 <input type="text" id="in-sub-${cat}" class="input input-xs input-bordered w-full" placeholder="+ Subcategory..." onkeypress="if(event.key==='Enter') SettingsManager.addSub('${cat}')">
                 <button onclick="SettingsManager.addSub('${cat}')" class="btn btn-xs btn-ghost btn-square text-primary"><i class="fas fa-plus"></i></button>
               </div>
             </div>
          </div>
        `;
        container.appendChild(div);
      });
    },

    handleEnter: function(e, key) { if (e.key === 'Enter') { e.preventDefault(); this.addItem(key); } },

    addItem: function(key) {
      const input = el(`in-${key}`);
      const val = input.value.trim();
      if (val && !_config[key].includes(val)) {
        _config[key].push(val);
        this.renderAll();
        input.value = '';
      }
    },
    
    deleteItem: function(key, idx) {
      if(confirm('Delete item?')) { _config[key].splice(idx, 1); this.renderAll(); }
    },

    addCategory: function() {
      const val = el('in-new-cat').value.trim();
      if (val && !_config.categories[val]) {
        _config.categories[val] = [];
        this.renderCategories();
        el('in-new-cat').value = '';
      }
    },

    deleteCategory: function(cat) {
      if(confirm(`Delete category '${cat}'?`)) { delete _config.categories[cat]; this.renderCategories(); }
    },

    addSub: function(cat) {
      const input = el(`in-sub-${cat}`);
      const val = input.value.trim();
      if (val && !_config.categories[cat].includes(val)) {
        _config.categories[cat].push(val);
        this.renderCategories();
      }
    },

    deleteSub: function(cat, idx) {
      _config.categories[cat].splice(idx, 1);
      this.renderCategories();
    },

    // --- Modal Edit Logic ---

    openModal: function(title, value) {
      el('modal-edit-title').innerText = title;
      const input = el('modal-edit-input');
      input.value = value;
      el('modal-edit-error').classList.add('hidden');
      el('modal_edit_setting').showModal();
      // Focus input after delay
      setTimeout(() => input.focus(), 100);
    },

    editItem: function(key, idx) {
      _editContext = { type: 'list', key: key, index: idx, oldVal: _config[key][idx] };
      this.openModal(`แก้ไขข้อมูล ${key}`, _config[key][idx]);
    },

    editCategory: function(catName) {
      _editContext = { type: 'cat', key: 'categories', oldVal: catName };
      this.openModal('แก้ไขชื่อหมวดหมู่', catName);
    },

    editSub: function(catName, idx) {
      _editContext = { type: 'sub', key: catName, index: idx, oldVal: _config.categories[catName][idx] };
      this.openModal('แก้ไขหมวดหมู่ย่อย', _config.categories[catName][idx]);
    },

    saveEditFromModal: function() {
      const newVal = el('modal-edit-input').value.trim();
      if (!newVal) {
        el('modal-edit-error').innerText = "กรุณากรอกข้อมูล";
        el('modal-edit-error').classList.remove('hidden');
        return;
      }

      if (newVal === _editContext.oldVal) {
        el('modal_edit_setting').close();
        return;
      }

      // Logic ตามประเภทที่แก้
      if (_editContext.type === 'list') {
        _config[_editContext.key][_editContext.index] = newVal;
        this.renderAll();
      } 
      else if (_editContext.type === 'cat') {
        if (_config.categories[newVal]) {
          alert('ชื่อหมวดหมู่นี้มีอยู่แล้ว');
          return;
        }
        // Rename key: copy data to new key, delete old key
        const data = _config.categories[_editContext.oldVal];
        delete _config.categories[_editContext.oldVal];
        _config.categories[newVal] = data;
        this.renderCategories();
      } 
      else if (_editContext.type === 'sub') {
        _config.categories[_editContext.key][_editContext.index] = newVal;
        this.renderCategories();
      }

      el('modal_edit_setting').close();
      _editContext = null;
    }

  };
})();

document.addEventListener('DOMContentLoaded', () => {
  Router.register('page-settings', SettingsManager);
  SettingsManager.init();
});
</script>