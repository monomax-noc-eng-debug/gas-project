<script>
   /**
    * JS_History.html
    * จัดการหน้าประวัติรายงาน (Refactored to Alpine.js)
    */

   document.addEventListener('alpine:init', () => {
      Alpine.data('historyModule', () => ({
         isLoading: false,
         data: [],
         isLoaded: false,

         init() {
            document.addEventListener('page-change', (e) => {
               if (e.detail.pageId === 'page-history') {
                  this.onPageShow();
               }
            });
         },

         onPageShow() {
            const container = document.getElementById('page-history');
            if (container && container.classList.contains('hidden')) return;

            if (!this.isLoaded) {
               this.loadData();
            }
         },

         loadData(forceRefresh = false) {
            if (!forceRefresh && this.isLoaded) return;

            this.isLoading = true;

            // Use silent loading if app is already loaded to avoid global spinner covering everything
            // BUT here we want to show local spinner, so we might not need global silent if we handle local state
            const options = Store.state.isAppLoaded ? { func: 'getShiftHistory', silent: true } : 'getShiftHistory';

            Server.call(options)
               .then((data) => {
                  this.data = data || [];
                  this.isLoaded = true;
                  // Set global app loaded flag
                  if (!Store.state.isAppLoaded) Store.state.isAppLoaded = true;
                  if (forceRefresh) UIManager.showToast("อัปเดตข้อมูลเรียบร้อย", "success");
                  this.isLoading = false;
               })
               .catch((err) => {
                  console.error(err);
                  this.isLoading = false;
                  // UIManager.showToast(err.message, 'error'); // Optional
               });
         },

         // Helper for group label class/icon
         getGroupLabel(group) {
            if (group === 'group_all') {
               return { class: 'badge-success badge-outline border-2', icon: 'fa-file-alt', text: 'Report' };
            } else if (group === 'group_dev') {
               return { class: 'badge-primary badge-outline border-2', icon: 'fa-code', text: 'DEV' };
            } else {
               return { class: 'badge-ghost opacity-50', icon: '', text: group || '-' };
            }
         }
      }));
   });
</script>