<script>
  /**
   * JS_Email.html
   * Handle Email Composer & Preview Logic (Refactored to Alpine.js)
   */

  document.addEventListener('alpine:init', () => {
    Alpine.data('emailModule', () => ({
      templates: [],
      isLoaded: false,
      isLoading: false,
      isLoadingPreview: false,
      previewData: { subject: 'à¸«à¸±à¸§à¸‚à¹‰à¸­: (à¹€à¸¥à¸·à¸­à¸à¹€à¸—à¸¡à¹€à¸žà¸¥à¸•)', body: '' },
      form: {
        templateId: '',
        to: '',
        cc: '',
        note: ''
      },
      previewTimeout: null,

      init() {
        console.log("Email Module Initialized");
        document.addEventListener('page-change', (e) => {
          if (e.detail.pageId === 'page-email') {
            this.onPageShow();
          }
        });
      },

      onPageShow() {
        const container = document.getElementById('page-email');
        if (container && container.classList.contains('hidden')) return;

        if (!this.isLoaded) {
          this.loadTemplates();
        }
      },

      loadTemplates() {
        this.isLoading = true;
        const options = Store.state.isAppLoaded ? { func: 'getEmailTemplates', silent: true } : 'getEmailTemplates';

        Server.call(options)
          .then((templates) => {
            this.templates = templates || [];

            // Auto-select first template
            if (this.templates.length > 0) {
              this.form.templateId = this.templates[0].id;
              this.updatePreview();
            }

            this.isLoaded = true;
            // Set global app loaded flag
            if (!Store.state.isAppLoaded) Store.state.isAppLoaded = true;
          })
          .catch((err) => UIManager.showToast("Error loading templates: " + err.message, 'error'))
          .finally(() => { this.isLoading = false; });
      },

      debouncePreview() {
        if (this.previewTimeout) clearTimeout(this.previewTimeout);
        this.previewTimeout = setTimeout(() => this.updatePreview(), 1000);
      },

      updatePreview() {
        if (!this.form.templateId) return;

        this.isLoadingPreview = true;

        Server.call('getEmailPreview', this.form.templateId, this.form.note)
          .then((res) => {
            this.previewData = res;
            this.isLoadingPreview = false;
          })
          .catch((err) => {
            this.previewData.body = `<p class="text-error">Error loading preview: ${err.message}</p>`;
            this.isLoadingPreview = false;
          });
      },

      createDraft() {
        // Validate
        if (!this.form.templateId) return UIManager.showToast("Please select a template", "warning");
        if (!this.form.to) return UIManager.showToast("Recipient (To) is required", "warning");

        // Show Confirmation Modal
        UIManager.showModal({
          title: "Confirm Draft Creation",
          body: `
                <div class="text-center">
                  <div class="text-primary text-4xl mb-2"><i class="fas fa-file-signature"></i></div>
                  <p class="font-bold text-lg">Create Draft Email?</p>
                  <p class="text-sm opacity-70 mt-1">
                    This will create a draft in your Gmail.<br>
                    It will <b>NOT</b> be sent immediately.
                  </p>
                  <div class="bg-base-200 p-2 rounded mt-3 text-sm text-left">
                    <b>To:</b> ${this.form.to}<br>
                    <b>Template:</b> ${this.form.templateId}
                  </div>
                </div>
              `,
          confirmText: "Yes, Create Draft",
          onConfirm: () => {
            this.submitDraft();
          }
        });
      },

      submitDraft() {
        Server.call({ func: 'createDraftEmail', loadingMsg: 'Creating Draft...' },
          this.form.templateId, this.form.to, this.form.cc, this.form.note)
          .then((res) => {
            if (res.success) {
              UIManager.showModal({
                title: "Draft Created Successfully! ðŸŽ‰",
                showCancel: false,
                confirmText: "Open Gmail Drafts",
                body: `
                           <div class="text-center">
                             <i class="fas fa-envelope-open-text text-success text-5xl mb-4"></i>
                             <p class="text-lg">Your email draft is ready.</p>
                             <p class="text-sm opacity-60">Please review and click 'Send' in Gmail.</p>
                           </div>
                         `,
                onConfirm: () => {
                  window.open('https://mail.google.com/mail/u/0/#drafts', '_blank');
                }
              });
            } else {
              UIManager.showToast(res.message, "error");
            }
          })
          .catch((err) => console.error(err));
      }

    }));
  });
</script>